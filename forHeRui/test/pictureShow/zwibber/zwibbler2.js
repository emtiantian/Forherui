/**
   Zwibbler

   Copyright 2013 Hanov Solutions Inc. All Rights Reserved. This software is
   NOT open source. For licensing information, contact the author.

   steve.hanov@gmail.com

   @license
 */
(function(){
"use strict";var m;function aa(a,b,c,d,e){this.Sa=a||"transparent";this.left=b||0;this.top=c||0;this.right=d||0;this.bottom=e||0;this.$=1;this.insertBefore=null}aa.prototype.Ma=function(){this.ia.remove()};
aa.prototype.show=function(a){this.ia=p("<div>");this.ia.da("position","fixed");this.ia.da("background",this.Sa);this.ia.da("opacity","0.25");this.ia.da("left",""+this.left+"px");this.ia.da("top",""+this.top+"px");this.ia.da("right",""+this.right+"px");this.ia.da("bottom",""+this.bottom+"px");this.ia.da("display","none");this.ia.click(function(b){a(b)});this.insertBefore?(this.ia.da("z-index",""+this.$),ba(p(this.ia),this.insertBefore)):(this.ia.da("z-index",""+this.$),p("body").append(this.ia));
ca(this.ia)};var da={},ea={};function ha(a){for(var b=["base64"],c=0;c<b.length;c++)a=da[b[c]](a);return a}
da.base64=function(a){for(var b="",c,d,e,f,g,h,k=0;k<a.length;)c=a.charCodeAt(k++),d=a.charCodeAt(k++),e=a.charCodeAt(k++),f=c>>2,c=(c&3)<<4|d>>4,g=(d&15)<<2|e>>6,h=e&63,isNaN(d)?g=h=64:isNaN(e)&&(h=64),b=b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(c)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h);
return b};
ea.base64=function(a){var b="",c,d,e,f,g,h=0,k={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,a:26,b:27,c:28,d:29,e:30,f:31,g:32,h:33,i:34,j:35,k:36,l:37,m:38,n:39,o:40,p:41,q:42,r:43,s:44,t:45,u:46,v:47,w:48,x:49,y:50,z:51,0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,"+":62,"/":63,"=":64};for(a=a.replace(/[^A-Za-z0-9\-_\=\+\/]/g,"");h<a.length;)c=k[a.charAt(h++)],d=k[a.charAt(h++)],f=k[a.charAt(h++)],g=k[a.charAt(h++)],c=
c<<2|d>>4,d=(d&15)<<4|f>>2,e=(f&3)<<6|g,b+=String.fromCharCode(c),64!==f&&(b+=String.fromCharCode(d)),64!==g&&(b+=String.fromCharCode(e));return b};
da.ascii85=function(a){for(var b="",c,d,e,f,g,h,k,l,n=0;n<a.length;)c=a.charCodeAt(n++),d=a.charCodeAt(n++),e=a.charCodeAt(n++),f=a.charCodeAt(n++),g=(c<<24|d<<16|e<<8|f)>>>0,c=(g/52200625|0)%85+33,h=(g/614125|0)%85+33,k=(g/7225|0)%85+33,l=(g/85|0)%85+33,g=g%85+33,(118<c||118<h||118<k||118<l||118<g)&&console.log(c,h,k,l,g),(33>c||33>h||33>k||33>l||33>g)&&console.log(c,h,k,l,g),b+=String.fromCharCode(c)+String.fromCharCode(h),isNaN(d)||(b+=String.fromCharCode(k),isNaN(e)||(b+=String.fromCharCode(l),
isNaN(f)||(b+=String.fromCharCode(g))));return b+"~>"};da.utf8=function(a){for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b};
ea.utf8=function(a){for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);127>=d?b+=String.fromCharCode(d):2047>=a?(b+=String.fromCharCode(192|a>>6),b+=String.fromCharCode(128|a&63)):65535>=a?(b+=String.fromCharCode(224|a>>12),b+=String.fromCharCode(128|a>>6&63),b+=String.fromCharCode(128|a&63)):1114111>=a?(b+=String.fromCharCode(240|a>>18),b+=String.fromCharCode(128|a>>12&63),b+=String.fromCharCode(128|a>>6&63),b+=String.fromCharCode(128|a&63)):b+=String.fromCharCode(63)}return b};
ea.utf8=function(a){for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b};da.hex=function(a){for(var b=[],c=0;c<a.length;c++){var d=a.charCodeAt(c);16>d&&b.push("0");b.push(d.toString(16))}return b.join("")};
da.sha1=function(a){var b=[1518500249,1859775393,2400959708,3395469782];a+=String.fromCharCode(128);for(var c=Math.ceil((a.length/4+2)/16),d=Array(c),e=0;e<c;e++){d[e]=Array(16);for(var f=0;16>f;f++)d[e][f]=a.charCodeAt(64*e+4*f)<<24|a.charCodeAt(64*e+4*f+1)<<16|a.charCodeAt(64*e+4*f+2)<<8|a.charCodeAt(64*e+4*f+3)}d[c-1][14]=8*(a.length-1)/Math.pow(2,32);d[c-1][14]=Math.floor(d[c-1][14]);d[c-1][15]=8*(a.length-1)&4294967295;a=1732584193;for(var f=4023233417,g=2562383102,h=271733878,k=3285377520,l=
Array(80),n,q,r,u,v,e=0;e<c;e++){for(var w=0;16>w;w++)l[w]=d[e][w];for(w=16;80>w;w++)n=l[w-3]^l[w-8]^l[w-14]^l[w-16],l[w]=n<<1|n>>>31;n=a;q=f;r=g;u=h;v=k;for(w=0;80>w;w++){var z=Math.floor(w/20),sa;a:{switch(z){case 0:sa=q&r^~q&u;break a;case 1:sa=q^r^u;break a;case 2:sa=q&r^q&u^r&u;break a;case 3:sa=q^r^u;break a}sa=void 0}z=(n<<5|n>>>27)+sa+v+b[z]+l[w]&4294967295;v=u;u=r;r=q<<30|q>>>2;q=n;n=z}a=a+n&4294967295;f=f+q&4294967295;g=g+r&4294967295;h=h+u&4294967295;k=k+v&4294967295}return String.fromCharCode(a>>
24&255)+String.fromCharCode(a>>16&255)+String.fromCharCode(a>>8&255)+String.fromCharCode(a>>0&255)+String.fromCharCode(f>>24&255)+String.fromCharCode(f>>16&255)+String.fromCharCode(f>>8&255)+String.fromCharCode(f>>0&255)+String.fromCharCode(g>>24&255)+String.fromCharCode(g>>16&255)+String.fromCharCode(g>>8&255)+String.fromCharCode(g>>0&255)+String.fromCharCode(h>>24&255)+String.fromCharCode(h>>16&255)+String.fromCharCode(h>>8&255)+String.fromCharCode(h>>0&255)+String.fromCharCode(k>>24&255)+String.fromCharCode(k>>
16&255)+String.fromCharCode(k>>8&255)+String.fromCharCode(k>>0&255)};function ia(a){if("string"===typeof a){for(;8>a.length;)a+=a;for(var b=16777619,c=0;c<a.length;c++)b=(16777619*b^a.charCodeAt(c))&4294967295;a=b}this.ba=a;this.reset()}ia.prototype={reset:function(){this.aa=this.$=this.ba},next:function(){this.aa=36969*(this.aa&65535)+(this.aa>>16);this.$=18E3*(this.$&65535)+(this.$>>16);return((this.aa<<16)+this.$)/4294967295/2+.5}};var ja=null;"undefined"!==typeof window&&(ja=window);var ka={},la=[];
function t(a,b){function c(b){var c=arguments,f=[],g=c[0];if(!ka[a]){var h=g.split("%s");f.push(h[0]);for(g=1;g<h.length;g++)g-1>=c.length-1?f.push("<too few args>"):"string"===typeof c[g]||"number"===typeof c[g]?f.push(c[g]):void 0===c[g]?f.push("(undefined)"):null===c[g]?f.push("(null)"):c[g]instanceof Object&&c[g].toString instanceof Function?f.push(c[g].toString()):f.push(JSON.stringify(c[g])),f.push(h[g]);c=f.join("");for(g=0;g<la.length;g++)la[g](a,c)}}!1===b&&(ka[a]=!0);c.$=function(){return 0<
la.length&&!ka[a]};return c}function ma(a){la.push(a);return a}"console"in ja||(ja.console={log:function(){for(var a=[],b=0;b<arguments.length;b++)try{"string"===typeof arguments[b]?a.push(arguments[b]):a.push(JSON.stringify(arguments[b]))}catch(c){a.push(c.toString())}for(b=0;b<la.length;b++)la[b]("Console",a.join(""))}},ja.console.error=ja.console.log);function na(){this.length=0}var oa=t("JQUERY"),pa,qa=/\s+/,ra=/^[\s\xA0]+/,ta=/[\s\xA0]+$/,ua,va={B:1,BIG:1,I:1,SMALL:1,TT:1,ABBR:1,ACRONYM:1,CITE:1,CODE:1,DFN:1,EM:1,KBD:1,STRONG:1,SAMP:1,VAR:1,A:1,BDO:1,BR:1,IMG:1,MAP:1,OBJECT:1,Q:1,SCRIPT:1,SPAN:1,SUB:1,SUP:1,BUTTON:1,INPUT:1,LABEL:1,SELECT:1,TEXTAREA:1},wa=[],xa=!1;function ya(){!xa&&window.attachEvent&&(window.attachEvent("onresize",function(a){for(var b=0;b<wa.length;b++)wa[b](a)}),xa=!0)}
function za(a,b,c,d){this.name=a;this.qf=b;this.ld=c;this.Ag=d}
function Ba(a,b){var c=/#(.*)$/,d=/\.(.*)$/,e=/^<\s*([a-zA-Z0-9]+).*>$/,f=/^([A-Za-z]+)$/;b=b||document;var g=new na,h,k,l;try{l=("object"===typeof HTMLElement?a instanceof HTMLElement:"object"===typeof a&&1===a.nodeType&&"string"===typeof a.nodeName||3===a.nodeType)||a===window||a===document||a===document.body||a instanceof Element}catch(r){l=!1}if(l)return g[g.length++]=a,g;if(a instanceof na)return a;l=a.split(",");for(var n=0;n<l.length;n++)if(k=l[n],null!==(h=c.exec(k)))h=document.getElementById(h[1]),
null!==h&&(g[g.length++]=h);else if(null!==(h=e.exec(k)))h=h[1],g[g.length++]=document.createElement(h);else if(null!==(h=d.exec(k))){k=g;h=ua(b,h[1],null);for(var q=0;q<h.length;q++)k[k.length++]=h[q]}else if(null!==(h=f.exec(k)))for(k=g,h=b.getElementsByTagName(h[1]),q=0;q<h.length;q++)k[k.length++]=h[q];else throw console.log(k),"Error: can't parse selector: "+k+" ("+k.nodeType;return g}
na.prototype={children:function(){for(var a=new na,b=0;b<this.length;b++)for(var c=this[b].firstChild;c;)a[a.length++]=c,c=c.nextSibling;return a},Ma:function(){for(var a=0;a<this.length;a++){var b=p(this[a]).da("display");"none"!==b&&(this[a].fe=b);this[a].style.display="none"}return this},show:function(){for(var a=0;a<this.length;a++)this[a].fe?this[a].style.display=this[a].fe:"none"===p(this[a]).da("display")&&(this[a].style.display=this[a].tagName in va?"inline":"block");return this},append:function(a){a=
Ba(a);if(0<this.length)for(var b=0;b<a.length;b++)this[0].appendChild(a[b]);return this},remove:function(){for(var a=0;a<this.length;a++)this[a].parentNode&&this[a].parentNode.removeChild(this[a]);return this},empty:function(){for(var a=0;a<this.length;a++)for(;null!==this[a].firstChild;)this[a].removeChild(this[a].firstChild);return this},text:function(a){if(0===arguments.length){var b="";Ca(this,function(a){3===a.nodeType&&(b+=a.nodeValue)});return b}for(var c=0;c<this.length;c++){for(;null!==this[c].firstChild;)this[c].removeChild(this[c].firstChild);
this[c].appendChild(document.createTextNode(a))}return this},width:function(){if(0<this.length){if(1===arguments.length){for(var a=Math.max(0,arguments[0]),b=0;b<this.length;b++)this[b].style.width=""+a+"px";return this}return this[0]===window?this[0].innerWidth||document.documentElement.clientWidth:this[0].clientWidth}return 0},height:function(){if(0<this.length){if(1===arguments.length){for(var a=0;a<this.length;a++)this[a].style.height=""+arguments[0]+"px";return this}return this[0]===window?this[0].innerHeight||
document.documentElement.clientHeight:this[0].clientHeight}return 0},outerWidth:function(){return 0<this.length?this[0].offsetWidth:0},outerHeight:function(){return 0<this.length?this[0].offsetHeight:0},offset:function(a){if(a){if(0<this.length){var b;if(0===this.length)b=null;else{for(b=this[0].parentNode;b&&"static"===p(b).da("position")&&"BODY"!==b.tagName;)b=b.parentNode;b=p(b)}b=b.offset();this[0].style.left=a.left-b.left+"px";this[0].style.top=a.top-b.top+"px"}}else{if(0<this.length){a=this[0].getBoundingClientRect();
var c=b=0;"pageYOffset"in window?(b=window.pageXOffset,c=window.pageYOffset):(b=document.body.scrollLeft,c=document.body.scrollTop);return{top:a.top+c,left:a.left+b}}return{left:0,top:0}}},clone:function(){return this.length?Ba(this[0].cloneNode(!0)):new na},find:function(a){return this.length?Ba(a,this[0]):new na},ab:function(a,b){if(2===arguments.length){for(var c=0;c<this.length;c++)this[c].setAttribute(a,b);return this}return 0<this.length?this[0].getAttribute(a):""},jb:function(a){for(var b=
0;b<this.length;b++)a(b,this[b])},focus:function(){0<this.length&&this[0].focus();return this},blur:function(){0<this.length&&this[0].blur();return this},submit:function(){for(var a=0;a<this.length;a++)this[a].submit();return this},select:function(){for(var a=0;a<this.length;a++)this[a].select();return this},da:function(a,b){var c=a.split("-");a=c[0];for(var d=1;d<c.length;d++)a="ms"!==c[d]?a+(c[d].substr(0,1).toUpperCase()+c[d].substr(1)):a+c[d];if(2===arguments.length){for(d=0;d<this.length;d++)this[d].style[a]=
""+b;return this}return this[0].currentStyle?this[0].currentStyle[a]:window.getComputedStyle?window.getComputedStyle(this[0],null)[a]:this[0].style[a]},on:function(a,b){function c(c){d[0]===window&&"resize"===c&&window.attachEvent?(wa.push(b),ya()):window.addEventListener?d.jb(function(d,e){function k(a){a.eb=a;"which"in a||(a.which=a.button);return b.call(e,a)}e.__JqlListeners||(e.__JqlListeners=[]);k.ue=a;b.ue=a;e.addEventListener(c,k,!1);e.__JqlListeners.push(new za(c,e,b,k))}):d.jb(function(a,
d){d.attachEvent("on"+c,function(a){a.eb=a;a.which=a.button;a.pageX=a.clientX;a.pageY=a.clientY;a.preventDefault=function(){a.returnValue=!1};a.stopPropagation=function(){a.cancelBubble=!0};a.target=a.target||a.srcElement;return b.call(d,a)})})}var d=this;a=a.split(" ");for(var e=0;e<a.length;e++)c(a[e]);return this},bind:function(a,b){return this.on(a,b)},Ac:function(a,b){window.addEventListener&&this.jb(function(c,d){if(d.__JqlListeners)for(var e=d.__JqlListeners,f=0;f<e.length;f++){var g=e[f];
if(a===g.name&&d===g.qf&&b===g.ld){d.removeEventListener(a,g.Ag,!1);e.splice(f,1);break}}});return this},click:function(a){return a?this.on("click",a):Da(this)},scrollLeft:function(a){if(1===arguments.length){for(var b=0;b<this.length;b++)this[b].scrollLeft=a;return this}return this[0].scrollLeft},scrollTop:function(a){if(1===arguments.length){for(var b=0;b<this.length;b++)this[b].scrollTop=a;return this}return this[0].scrollTop}};
function ca(a){for(var b=0;b<a.length;b++)a[b].style.display="block"}function Ea(a,b){a.on("change",b)}function Fa(a,b){a.on("mouseout",b)}function Ga(a,b){a.on("mouseover",b)}function Ha(a,b){a.on("dblclick",b)}function Ia(a,b){a.on("mousemove",b)}function Ja(a){p(window).on("mouseup",a)}function Ka(a,b){a.on("mousedown",b)}function La(a,b){a.on("keydown",b)}function Ma(){var a=p("<input>").ab("type","button");a[0].value="OK";return a}
function Na(a,b){if(b&&"string"===typeof b)for(var c=(b||"").split(qa),d=0,e=a.length;d<e;d++){var f=a[d];if(1===f.nodeType)if(f.className){for(var g=" "+f.className+" ",h=f.className,k=0,l=c.length;k<l;k++)0>g.indexOf(" "+c[k]+" ")&&(h+=" "+c[k]);f.className=pa.ba(h)}else f.className=b}return a}function Oa(a,b){for(var c=0;c<a.length;c++)a[c].innerHTML=b}
function Da(a){a.jb(function(a,c){var d;oa("Trigger click");document.createEventObject?(d=document.createEventObject(),c.fireEvent("onclick",d)):(d=document.createEvent("HTMLEvents"),d.initEvent("click",!0,!0),c.dispatchEvent(d))})}function ba(a,b){b=Ba(b);0<a.length&&0<b.length&&b[0].parentNode.insertBefore(a[0],b[0])}function Pa(a,b){b=Ba(b);0<a.length&&0<b.length&&a[0].parentNode.insertBefore(b[0],a[0])}
function Ca(a,b){for(var c=[],d=a.length-1;0<=d;d--)c.push(a[d]);for(;c.length;)for(d=c.pop(),b(d),d=d.lastChild;d;)c.push(d),d=d.previousSibling}pa=function(a){return Ba(a)};pa.ba=function(a){return null===a?"":a.toString().replace(ra,"").replace(ta,"")};
pa.aa=function(a){var b=a.url||"",c=a.type||"GET",d=a.ig||function(){},e=a.error||function(){},f=a.data||"";a=a.jf||function(){};var g="",h;try{h=new XMLHttpRequest}catch(l){try{h=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{h=new ActiveXObject("Microsoft.XMLHTTP")}catch(q){e(null,"",null)}}}if("object"===typeof f)for(var k in f)Object.hasOwnProperty.call(f,k)&&(g.length&&(g+="&"),g+=encodeURIComponent(k),g+="=",g+=encodeURIComponent(f[k]));"GET"===c&&(b+="?"+g,g="");a(h,h);h.open(c,b,!0);h.onreadystatechange=
function(){if(4===h.readyState)if(200===h.status){var a=h.responseText,b=h.getResponseHeader("content-type");if(b&&0===b.indexOf("application/json"))try{a=pa.ha(a)}catch(c){}d(a,"",h)}else e(h,"",null)};"POST"===c&&h.setRequestHeader("Content-Type","application/x-www-form-urlencoded");h.send(g)};
ua=function(a,b,c){var d=[],e=b.split(/\s+/);for(b=0;b<e.length;b++){var f=e[b].replace(/([\/\\\^$*+?.()|\[\]{}])/g,"\\$1");d.push(new RegExp("(^|\\s)"+f+"(\\s|$)"))}e=a.getElementsByTagName(c||"*");f=[];b=0;for(c=e.length;b<c;b++){var g=e[b],h=!0;for(a=0;a<d.length;a++)if(!d[a].test(g.className)){h=!1;break}h&&f.push(g)}return f};pa.ha=function(a){return window.JSON.parse(a)};
pa.$=function(a){for(var b=arguments[0],c=1;c<arguments.length;c++){var d=arguments[c],e;for(e in d)d.hasOwnProperty(e)&&(b[e]=d[e])}return b};pa.fc=na.prototype;var p=pa;t("Cookies");function Qa(){this.$=[]}Qa.prototype={log:t("DESTRUCTOR"),add:function(a){this.$.push(a)},bind:function(a,b,c){a.bind(b,c);this.add(function(){a.Ac(b,c)})}};function Ra(a){this.$=a}Ra.prototype={$a:function(a){this.$.$a(a)},flush:function(){this.$.flush()},jd:function(){return this.$.jd()}};function Sa(){this.data=""}Sa.prototype={log:t("BYTESTREAM"),jd:function(){return this},$a:function(a){if(255<a||0>a)throw"Bad data written to byte buffer";this.data+=String.fromCharCode(a)},flush:function(){},toString:function(){return this.data},Eb:function(){for(var a=[],b=0;b<this.data.length;b++)a.push(this.data.charCodeAt(b));return a}};var Ta={};
function Ua(){var a,b=new Sa;a=["LZWEncoder","Ascii85Encoder"];a.reverse();for(var c=0;c<a.length;c++)b=new Ta[a[c]](b);return b};function Va(a){this.$=a;this.aa=[]}Va.prototype={$a:function(a){4===this.aa.length&&Wa(this);this.aa.push(a)},flush:function(){0<this.aa.length&&Wa(this);for(var a=this.$,b=0;2>b;b++)a.$a("~>".charCodeAt(b));this.$.flush()}};
function Wa(a){var b,c,d,e,f,g,h,k;b=a.aa[0];c=a.aa[1];d=a.aa[2];e=a.aa[3];f=(b<<24|c<<16|d<<8|e)>>>0;b=(f/52200625|0)%85+33;g=(f/614125|0)%85+33;h=(f/7225|0)%85+33;k=(f/85|0)%85+33;f=f%85+33;(118<b||118<g||118<h||118<k||118<f)&&console.log(b,g,h,k,f);(33>b||33>g||33>h||33>k||33>f)&&console.log(b,g,h,k,f);a.$.$a(b);a.$.$a(g);isNaN(c)||(a.$.$a(h),isNaN(d)||(a.$.$a(k),isNaN(e)||a.$.$a(f)));a.aa.length=0}Va.prototype=p.$({},Ra.prototype,Va.prototype);Ta.Ascii85Encoder=Va;function Xa(a){this.$=a;this.aa=this.ba=0;this.ha=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8193]}Xa.prototype={log:t("BITWRITER"),$a:function(a){Ya(this,a,8)},flush:function(){this.aa&&(this.$.$a(this.ba<<8-this.aa),this.ba=this.aa=0);this.$.flush()}};function Ya(a,b,c){a.ba=a.ba<<c|b&a.ha[c];for(a.aa+=c;8<=a.aa;)a.$.$a(a.ba>>>a.aa-8&255),a.aa-=8,a.ba&=a.ha[a.aa]}Ta.BitWriter=Xa;Xa.prototype=p.$({},Ra.prototype,Xa.prototype);function Za(a){this.$=new Xa(a);this.ha=258;this.aa=0;this.oa=!0;this.la=[];this.Da=[];this.sa=[];this.ba=9;$a(this)}
Za.prototype={log:t("LZWEncoder"),$a:function(a){var b;if(this.oa)this.aa=a,this.oa=!1;else{a:{b=this.aa;var c,d;c=a<<4^b;for(d=0===c?1:18041-c;;){if(void 0===this.la[c]||this.Da[c]===b&&this.sa[c]===a){b=c;break a}c-=d;0>c&&(c+=18041)}}void 0!==this.la[b]?this.aa=this.la[b]:(Ya(this.$,this.aa,this.ba),this.la[b]=this.ha,this.Da[b]=this.aa,this.aa=this.sa[b]=a,4095>this.ha?(this.ha+=1,this.ba=Math.ceil(Math.log(this.ha)/Math.log(2))):$a(this))}},flush:function(){this.oa||(Ya(this.$,this.aa,this.ba),
Ya(this.$,257,this.ba))}};function $a(a){Ya(a.$,256,a.ba);a.ha=258;a.ba=9;a.la.length=0;a.Da.length=0;a.sa.length=0}Ta.LZWEncoder=Za;Za.prototype=p.$({},Ra.prototype,Za.prototype);(function(a){this.algorithm=a.algorithm||"wrap";this.$=a.gravity||"down";this.aa=!1!==a.resize;"down"===this.$?(this.offsetWidth="offsetWidth",this.offsetHeight="offsetHeight",this.width="width",this.height="height",this.top="top",this.left="left",this.clientWidth="clientWidth",this.clientHeight="clientHeight"):"up"===this.$?(this.offsetWidth="offsetWidth",this.offsetHeight="offsetHeight",this.width="width",this.height="height",this.top="bottom",this.left="left",this.clientWidth="clientWidth",this.clientHeight=
"clientHeight"):(this.offsetWidth="offsetHeight",this.offsetHeight="offsetWidth",this.width="height",this.height="width",this.top="left",this.left="top",this.clientWidth="clientHeight",this.clientHeight="clientWidth")}).prototype={log:t("Layout")};function ab(a){this.$="en";"string"===typeof a&&(a=bb(this,a,{}));this.data=a}ab.prototype={log:t("LANGUAGE"),fc:function(){var a=this;return function(b,c){return cb(a,arguments)}},get:function(a,b){return cb(this,arguments)}};function cb(a,b){var c=b[0],d="<not translated:"+c+">";a.$ in a.data&&c in a.data[a.$]&&(d=a.data[a.$][c]);for(c=1;c<b.length;c++)d=d.replace("^"+c,b[c]);return d}
function bb(a,b,c){b=b.split("\n");for(var d=/^([ \t]*)([^:]+):([^:]+):(.*)/,e=0;e<b.length;e++){var f=d.exec(b[e]);if(f){var g=f[2],h=f[3],f=f[4];g in c||(c[g]={});h in c[g]&&a.log("Warning: Replacing %s:%s",g,h);c[g][h]=f}}return c}function db(a,b){b=b.split(",");a.log("Choice of languages: %s",b);for(var c=0;c<b.length;c++){var d=b[c].split("-")[0];if(d in a.data){a.log("Using language code %s",d);a.$=d;break}else a.log("No language for code %s",d)}};function eb(a,b,c,d,e){this.view=a;this.node=b;this.$=c;this.aa=b.Zd(c);this.La(d,e)}
eb.prototype={log:t("MoveEditNode"),Gb:function(){this.log("Entering MoveEditNode")},Jb:function(){this.log("Leaving MoveEditNode")},Wa:function(a){"touchmove"===a.type?(a=a.touches[0],a=x(this.view,a.pageX,a.pageY),this.Na(a.x,a.y)):"touchend"===a.type&&(a=a.changedTouches[0],a=x(this.view,a.pageX,a.pageY),this.Oa(a.x,a.y))},La:function(a,b){var c=this.view.Ta(new y(a,b));a=c.x;b=c.y;this.log("onMouseDown(%s,%s)",a,b);this.ba=a;this.ha=b},Na:function(a,b){var c=this.view.Ta(new y(a,b));a=c.x;b=c.y;
this.node.Gc(this.$,a,b);this.node.format(this.view.ma,this.view.request);this.view.na()},Oa:function(a,b){var c=this.view.Ta(new y(a,b));a=c.x;b=c.y;this.log("onMouseUp(%s,%s)",a,b,this.ba,this.ha);if(a!==this.ba||b!==this.ha)this.view.ya([new fb(this.node.id,this.$,this.aa.x,this.aa.y,a,b)]);else{var c=this.view,d=this.node.id,e=this.$,f=A(c.ka,d);f?f.ce(e)?(f!==c.Ca&&(c.Ca=f),c.log("Select edit handle %s",e),c.oa=e,c.ua.emit("selected-edit-handle",d,e)):c.log("selectEditHandle: That handle is not selectable."):
c.log("selectEditHandle: nodeid %s does not exist.",d)}this.view.na();C(this.view,new gb(this.view))}};function hb(a,b){this.view=a;this.state="none";this.Qa=document.createElement("img");this.url=this.Qa.src=b}
hb.prototype={log:t("ImageStamp"),Gb:function(){this.log("Entering ImageStampBehaviour");this.view.canvas.style.cursor="move"},Jb:function(){this.log("Leaving ImageStampBehaviour");this.view.na()},Wa:function(a){var b;"touchstart"===a.type?(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.La(b.x,b.y,a)):"touchmove"===a.type?(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.Na(b.x,b.y,a)):"touchend"===a.type&&(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.Oa(b.x,b.y,a))},
Ta:function(a,b){this.Qa.complete&&(a-=this.Qa.width/2,b-=this.Qa.height/2);return this.view.Ta(new y(a,b))},La:function(a,b,c){this.log("onMouseDown type %s",c.type);a=this.Ta(a,b);this.view.ya([new D("ImageNode",{url:this.url,layer:this.view.Ja,matrix:new E(a.x,a.y)})]);this.view.fa.get("autoPickTool")&&G(this.view)},Na:function(a,b){this.Qa.complete||this.log("Don't draw; image not loaded.");var c=this.Ta(a,b),d=this;this.view.na(function(a){var b=a.globalAlpha;a.globalAlpha=.5;a.drawImage(d.Qa,
c.x,c.y);a.globalAlpha=b})},Oa:function(){},ub:function(a){"cancel"===a&&(G(this.view),this.view.qb.emit("goto-toolbar"))}};function ib(a){this.view=a;this.state="none"}
ib.prototype={log:t("PanTool"),Gb:function(){this.log("Entering PanToolBehaviour");this.view.canvas.style.cursor="all-scroll"},Jb:function(){this.log("Leaving PanToolBehaviour")},Wa:function(a){var b;"touchstart"===a.type?(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.La(b.x,b.y,a)):"touchmove"===a.type?(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.Na(b.x,b.y,a)):"touchend"===a.type&&(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.Oa(b.x,b.y,a))},La:function(a,
b,c){this.log("onMouseDown type %s",c.type);this.state="dragging";this.start=jb(c);this.$=this.view.Ha;this.aa=this.view.Ga},Na:function(a,b,c){"dragging"===this.state&&(a=jb(c),b=this.aa+a.y-this.start.y,this.view.Ha=this.$+a.x-this.start.x,this.view.Ga=b,H(this.view),this.view.na())},Oa:function(){this.state="none"},Kd:function(a,b,c){if(!this.view.fa.get("allowZoom"))return this.log("Zooming is disabled."),!1;this.log("onMouseWheel(%s, %s, %s)",a,b,c);0<c?this.view.cd():this.view.dd()},ub:function(a){"cancel"===
a&&G(this.view)}};function jb(a){return"changedTouches"in a?new y(a.changedTouches[0].pageX,a.changedTouches[0].pageY):new y(a.pageX,a.pageY)};function kb(){this.$=[];this.next=0;this.ec=!1}
kb.prototype={log:t("UNDOSTACK"),ya:function(a,b,c){"object"===typeof a&&"[object Array]"===Object.prototype.toString.apply(a)||(a=[a]);this.next<this.$.length&&(this.$.length=this.next);if(!b){for(var d=[],e=2;e<arguments.length;e++)d.push(arguments[e]);for(e=0;e<a.length;e++)a[e].rb.apply(a[e],d)}for(d=this.top();d;)if(d[d.length-1].ee(a[0])){if(a.shift(),0===a.length)break}else break;a.length&&this.$.push(a);this.ec=!0;this.next=this.$.length},Va:function(a){this.log("Undo index %s of %s",this.next,
this.$.length);if(this.cc()){for(var b=this.$[--this.next],c=b.length-1;0<=c;c--)b[c].Va.apply(b[c],arguments);this.ec=!0}},Sb:function(a){this.log("Redo index %s of %s",this.next,this.$.length);if(this.bc()){for(var b=this.$[this.next++],c=0;c<b.length;c++)b[c].rb.apply(b[c],arguments);this.ec=!0}},cc:function(){return 0<this.next},bc:function(){return this.next<this.$.length},top:function(){return this.$.length?this.$[this.$.length-1]:0}};function lb(){}
lb.prototype={rb:function(){},Va:function(){},ee:function(){return!1}};var I=[],mb=null,nb=t("ImageLoader");function ob(){var a=[];nb("Timeout running... %s images remaining",I.length);for(var b=0;b<I.length;b++)I[b].complete?I[b].fc(I[b],I[b].Wc):5E3>I[b].sd?(I[b].sd+=250,a.push(I[b])):I[b].fc(I[b],I[b].Wc);I=a;I.length?setTimeout(ob,250):(nb("Timeout Stopped"),mb=!1)}
function pb(a,b){function c(){nb("LoadFn called. complete=%s",d.complete);if(d.complete)for(var a=0;a<I.length;a++){if(I[a]===d){I.splice(a,1);b(d,d.Wc);break}}else mb||(mb=!0,setTimeout(ob,250),d.sd=250)}var d=document.createElement("img");I.push(d);d.fc=b;d.Wc=a;d.sd=0;var e="://"+window.location.host;0!==a.indexOf("data:")&&-1===a.indexOf(e)&&(nb("Using cross origin request for img"),d.crossOrigin="");d.addEventListener?(d.addEventListener("load",function(){c()},!1),d.addEventListener("error",
function(){nb("Error loading %s",a);b(null,d.Wc)},!1)):(d.attachEvent("onload",function(){c()}),d.attachEvent("onerror",function(){nb("Error loading %s",a);b(null,d.Wc)}));d.src=a};function J(){this.Ra=!1;this.aa={}}
J.prototype={log:t("EventEmitter"),emit:function(a,b){var c,d=this;this.aa||(this.aa={});c=Array.prototype.slice.call(arguments,1);setTimeout(function(){var b,f,g,h,k=!1;if(a in d.aa)for(h=d.aa[a],f=0,g=h.length;f<g;f++)b=h[f],d.Ra||k||(d.log("Emit %s",a),k=!0),b.apply(null,c)},0);return this},rc:function(a,b){var c;this.aa||(this.aa={});c=Array.prototype.slice.call(arguments,1);var d,e,f,g,h=!1;if(a in this.aa)for(g=this.aa[a],e=0,f=g.length;e<f;e++)d=g[e],this.Ra||h||(this.log("Emit %s",a),h=!0),
d.apply(null,c);return this},on:function(a,b){this.aa||(this.aa={});this.bind(a,b);return this},bind:function(a,b){a in this.aa?this.aa[a].push(b):this.aa[a]=[b];return b},Ac:function(a,b){var c,d,e,f;if(a in this.aa)for(c=this.aa[a],d=e=0,f=c.length-1;e<=f;d=e+=1)if(c[d]===b){c.splice(d,1);break}}};function qb(a,b){function c(){a.Ac("done",c);b.apply(null,arguments)}a.bind("done",c)};function rb(a){J.call(this);this.ia=a;this.oa=!1;a.da("display","none");this.right=!0;a:{a=(document.body||document.documentElement).style;for(var b="transition",c=["Moz","Webkit","Khtml","O","ms"],b=b.charAt(0).toUpperCase()+b.substr(1),d=0;d<c.length;d++)if("string"===typeof a[c[d]+b]){sb=c[d];a=!0;break a}a=!1}this.ha=a;this.sa=sb;this.$=null;this.ha&&(a=this.ia.outerWidth(),this.da("TransitionProperty","transform"),this.da("Transform","translate("+a+"px,0)"));this.la=p(".body")}var sb;
rb.prototype={log:t("SlidingPanel",!1),show:function(a,b){var c=this;this.$&&(clearTimeout(this.$),this.$=null);!1!==b&&(b=!0);this.oa=!0;this.ia.show();var d=this.ia.outerWidth();this.ia.Ma();"right"===a?(this.left=!1,this.ia.da("left",""+(p(window).width()-d)+"px")):this.left=!0;b&&(c.ba=new aa,c.ba.$=c.ia.da("z-index"),c.ba.insertBefore=c.ia,c.ba.show(function(){c.Ma()}));c.ha?(this.log("Performing transition"),c.ia.da("display","block"),c.left?c.da("Transform","translate(-"+d+"px,0)"):c.da("Transform",
"translate("+d+"px,0)"),c.da("TransitionDuration","200ms"),c.da("TransitionDuration","200ms",c.la),window.setTimeout(function(){c.da("Transform","translate(0,0)");c.da("Transform","translate("+(c.left?d:-d)+"px,0)",c.la);window.setTimeout(function(){ub(c)},200)},1)):(this.log("No transitions allowed"),c.ia.da("display","block"),ub(c))},da:function(a,b,c){c=c||this.ia;a=""!==this.sa?this.sa+a:a.charAt(0).toLowerCase()+a.substr(1);c[0].style[a]=b;this.log("%s=%s",a,b)},fb:function(){return this.oa},
Ma:function(){var a=this;if(!this.$){this.oa=!1;a.ba&&a.ba.Ma();var b=this.ia.outerWidth();a.ha?this.left?a.da("Transform","translate(-"+b+"px,0)"):a.da("Transform","translate("+b+"px,0)"):a.ia.da("display","none");a.da("Transform","translate(0,0)",this.la);a.ha?this.$=window.setTimeout(function(){a.ia.da("display","none");a.emit("hide")},200):a.emit("hide")}}};function ub(a){console.log("Set focus on ",a.ia.find(".focus"));a.ia.find(".focus").focus();a.emit("show")}
rb.prototype=p.$({},J.prototype,rb.prototype);function vb(){var a=this;J.call(this);window.addEventListener("message",function(b){wb(a,b)},!1);window.parent.postMessage('{"event": "ready"}',"*")}vb.prototype={log:t("Api")};
function wb(a,b){function c(a){"ticket"in d&&(a={ticket:d.ticket,args:a},window.parent.postMessage(window.JSON.stringify(a),"*"))}var d;try{d=window.JSON.parse(b.data)}catch(g){a.log("Error parsing %s from %s",b.data,b.origin);return}a.log("Received %s",b.data);if(d["function"]in a.aa)for(var e=a.aa[d["function"]],f=0;f<e.length;f++)(0,e[f])(d.args,c)}vb.prototype=p.$({},J.prototype,vb.prototype);function xb(){J.apply(this,arguments);this.ba=[];this.$=!1;this.canvas=null}xb.prototype={log:t("FORMAT",!0),add:function(a,b,c,d,e){var f,g,h,k;k=this.ba;g=0;for(h=k.length;g<h;g++)f=k[g],f.type===b&&f.node===a&&(f.rd=!0);this.log("Request URL %s",c);this.ba.push({node:a,type:b,url:c,Qf:d,Sd:e,rd:!1});yb(this)}};
function zb(a,b){a.$=!0;a.log("Processing request for item %s url=%s",b.node.id,b.url);0===b.type.indexOf("image")?pb(b.url,function(c,d){null!==c?(a.log("Image request completed for item %s url %s",b.node.id,d),b.Sd(c,d)):a.log("Image request failed for url %s",d);a.$=!1;b.rd=!0;yb(a)}):p.aa({url:b.url,data:b.Qf,dataType:"json",success:function(c){b.rd||(a.log("Request completed for item %s",b.node.id),b.Sd(c),a.emit("reformat",b.node),a.$=!1,a.ba.shift(),yb(a))},error:function(b,d,e){a.log("Error: %s %s",
d,e);a.$=!1;a.ba.shift();yb(a)}})}function yb(a){for(var b=0;!a.$&&b<a.ba.length;)a.ba[b].rd?a.ba.shift():(zb(a,a.ba[0]),b+=1);a.$||a.emit("done")}xb.prototype=p.$({},J.prototype,xb.prototype);function Ab(a,b){this.ja=b;this.hg=!0}Ab.prototype={log:t("MoveSegment"),na:function(a){a.moveTo(this.ja.x,this.ja.y)},nc:function(){return null},Lb:function(){return{x:1,y:0}}};function Bb(a,b,c,d,e){this.ja=b;this.wa=a;this.Lf=!0;this.$=e;this.oa=d;c.next();this.ha=c.next();this.la=c.next();this.moveTo=this.kc=null;this.format()}
Bb.prototype={log:t("LineSegment"),format:function(){var a=Cb(this.wa.ja.x,this.wa.ja.y,this.ja.x,this.ja.y);this.aa=this.length=a;var b=this.wa.ja.clone();if(this.wa.Lf&&this.$){this.$=Math.min(this.$,a/2,this.wa.length/2);a=K(this.wa.ja.x,this.wa.ja.y,this.ja.x,this.ja.y);b.x+=a.x*this.$;b.y+=a.y*this.$;var a=this.wa,c=this.$,d=K(a.ba.x,a.ba.y,a.ja.x,a.ja.y),e=a.ja.clone();e.x-=d.x*c;e.y-=d.y*c;a.kc=e;a.aa-=c;c=a.aa/10*a.oa;10<c&&(c=10);var d=a.ba.x,f=a.ba.y,g=e.x,h=e.y,d=d+c,f=f+c;a.Fa=new y(d+
a.ha*(g+c-d),f+a.ha*(h+c-f));a.log("RECALC ctrl1=%s",a.Fa);d=a.ba.x-c;g=e.x-c;f=a.ba.y-c;h=e.y-c;a.Ia=new y(d+a.la*(g-d),f+a.la*(h-f));this.aa-=this.$}this.ba=b;null===this.kc&&(this.kc=this.ja);a=this.aa/10*this.oa;10<a&&(a=10);e=b.x;c=b.y;d=this.ja.x;f=this.ja.y;e+=a;c+=a;this.Fa=new y(e+this.ha*(d+a-e),c+this.ha*(f+a-c));e=b.x-a;d=this.ja.x-a;c=b.y-a;f=this.ja.y-a;this.Ia=new y(e+this.la*(d-e),c+this.la*(f-c))},Uc:function(a){this.wa=a;this.format();this.wa.kc&&(this.moveTo=this.wa.kc)},na:function(a){this.$&&
(this.moveTo&&a.moveTo(this.moveTo.x,this.moveTo.y),a.quadraticCurveTo(this.wa.ja.x,this.wa.ja.y,this.ba.x,this.ba.y));a.bezierCurveTo(this.Fa.x,this.Fa.y,this.Ia.x,this.Ia.y,this.kc.x,this.kc.y)},nc:function(){return this.wa?K(this.wa.ja.x,this.wa.ja.y,this.Fa.x,this.Fa.y):null},Lb:function(){return K(this.Ia.x,this.Ia.y,this.ja.x,this.ja.y)}};
function Db(a,b,c){this.ja=b;this.wa=a;this.$=c;var d=Cb(a.ja.x,a.ja.y,b.x,b.y);d||(d=1);var e=(b.x-a.ja.x)/d,f=(b.y-a.ja.y)/d;this.Ia=new y(b.x-d*c*e,b.y-d*c*f);if(b=a.Ia){var g=K(a.wa.ja.x,a.wa.ja.y,a.ja.x,a.ja.y),h=Cb(a.wa.ja.x,a.wa.ja.y,a.ja.x,a.ja.y),e=.5*(e+g.x),f=.5*(f+g.y);b.x=a.ja.x-h*c*e;b.y=a.ja.y-h*c*f}this.Fa=new y(a.ja.x+d*c*e,a.ja.y+d*c*f);this.length=d}
Db.prototype={Uc:function(a){this.wa=a;var b=a.Ia,c=(this.ja.x-a.ja.x)/this.length,d=(this.ja.y-a.ja.y)/this.length,e=this.$;if(b){var f=K(a.wa.ja.x,a.wa.ja.y,a.ja.x,a.ja.y),g=Cb(a.wa.ja.x,a.wa.ja.y,a.ja.x,a.ja.y),c=.5*(c+f.x),d=.5*(d+f.y);b.x=a.ja.x-g*e*c;b.y=a.ja.y-g*e*d}this.Fa=new y(a.ja.x+this.length*e*c,a.ja.y+this.length*e*d)},na:function(a){a.bezierCurveTo(this.Fa.x,this.Fa.y,this.Ia.x,this.Ia.y,this.ja.x,this.ja.y)},nc:function(){return this.wa?K(this.wa.ja.x,this.wa.ja.y,this.Fa.x,this.Fa.y):
null},Lb:function(){return 0<this.$?K(this.Ia.x,this.Ia.y,this.ja.x,this.ja.y):K(this.wa.ja.x,this.wa.ja.y,this.ja.x,this.ja.y)}};function Eb(a,b,c){this.control=b;this.ja=c}Eb.prototype={na:function(a){a.quadraticCurveTo(this.control.x,this.control.y,this.ja.x,this.ja.y)},nc:function(){return this.wa?K(this.wa.ja.x,this.wa.ja.y,this.control.x,this.control.y):null},Lb:function(){return K(this.control.x,this.control.y,this.ja.x,this.ja.y)}};function Fb(a,b,c,d){this.control=b;this.ja=c;this.Xb=d}
Fb.prototype={na:function(a){a.arcTo(this.control.x,this.control.y,this.ja.x,this.ja.y,this.Xb)}};function Gb(a,b,c,d){this.Fa=b;this.Ia=c;this.ja=d;this.wa=a}Gb.prototype={na:function(a){a.bezierCurveTo(this.Fa.x,this.Fa.y,this.Ia.x,this.Ia.y,this.ja.x,this.ja.y)},nc:function(){return this.wa?K(this.wa.ja.x,this.wa.ja.y,this.Fa.x,this.Fa.y):null},Lb:function(){return K(this.Ia.x,this.Ia.y,this.ja.x,this.ja.y)}};function Hb(a,b,c,d){this.Fa=b;this.Ia=c;this.ja=d;this.wa=a}
Hb.prototype={na:function(a){if(this.wa){var b=[];this.wa.Ia&&b.push(this.wa.Ia);this.Fa&&b.push(this.Fa);2===b.length?a.bezierCurveTo(b[0].x,b[0].y,b[1].x,b[1].y,this.ja.x,this.ja.y):1===b.length&&a.quadraticCurveTo(b[0].x,b[0].y,this.ja.x,this.ja.y)}},Uc:function(a){this.wa=a},nc:function(){return this.wa&&this.wa.Ia?K(this.wa.ja.x,this.wa.ja.y,this.Fa.x,this.Fa.y):null},Lb:function(){if(!this.Fa)return null}};
function Ib(a,b,c,d,e){this.wa=a;this.$=b;e=2*e;var f=2*d.next()-1;d.next();d=this.wa.Lb();if(!this.wa.hg&&d){var g=Cb(a.ja.x,a.ja.y,b.x,b.y);this.Fa=new y(a.ja.x+.5522847498*d.x*g,a.ja.y+.5522847498*d.y*g)}else this.Fa=new y(a.ja.x+.5522847498*(b.x-a.ja.x),a.ja.y+.5522847498*(b.y-a.ja.y));this.Ia=new y(c.x-.5522847498*(c.x-b.x)*(1-f*e),c.y-.5522847498*(c.y-b.y)*(1-f*e));this.ja=c}
Ib.prototype={log:t("SEGMENT"),Uc:function(a){this.wa=a;var b=this.wa.Lb();if(b){var c=Cb(a.ja.x,a.ja.y,this.$.x,this.$.y);this.Fa=new y(a.ja.x+.5522847498*b.x*c,a.ja.y+.5522847498*b.y*c)}else this.Fa=new y(a.ja.x+.5522847498*(this.$.x-this.wa.ja.x),a.ja.y+.5522847498*(this.$.y-this.wa.ja.y))},na:function(a){a.bezierCurveTo(this.Fa.x,this.Fa.y,this.Ia.x,this.Ia.y,this.ja.x,this.ja.y)},nc:function(){return this.wa?K(this.wa.ja.x,this.wa.ja.y,this.Fa.x,this.Fa.y):null},Lb:function(){return K(this.Ia.x,
this.Ia.y,this.ja.x,this.ja.y)}};function Jb(a){this.aa=a;this.Xb=30;this.$=[]}
Jb.prototype={log:t("AngleAddon"),format:function(){var a=this.aa.ba,b=0,c=[],d=[];this.$.length=0;for(var e=0>Kb(a);b<a.ea.length;){switch(a.ea[b]){case Lb:c=[new y(a.ea[b+1],a.ea[b+2])];d=c.concat();break;case Mb:3===c.length&&c.shift();c.push(new y(a.ea[b+1],a.ea[b+2]));d.push(c[c.length-1]);3===c.length&&Nb(this,c[0],c[1],c[2],e);break;case Ob:3<=d.length&&Nb(this,d[d.length-2],d[0],d[1],e)}b+=Pb[a.ea[b]]}},na:function(a){a.beginPath();var b,c;for(c=0;c<this.$.length;c++)b=this.$[c],a.moveTo(b.x+
this.Xb*Math.cos(b.wc),b.y+this.Xb*Math.sin(b.wc)),a.arc(b.x,b.y,this.Xb,b.wc,b.gd,!1);a.lineWidth=3;a.strokeStyle="red";a.stroke();a.fillStyle="red";a.font="20px Arial";for(c=0;c<this.$.length;c++){b=this.$[c];var d=(b.wc+b.gd)/2+Math.PI;0<b.wc&&0>b.gd&&(d-=Math.PI);var e=b.gd-b.wc;0>e&&(e+=2*Math.PI);a.fillText(""+Math.round(e/Math.PI*180)+"\u00b0",b.x+this.Xb*Math.cos(d),b.y+this.Xb*Math.sin(d))}}};
function Nb(a,b,c,d,e){var f;b=K(c.x,c.y,b.x,b.y);f=K(c.x,c.y,d.x,d.y);d=Math.atan2(b.y,b.x);b=Math.atan2(f.y,f.x);e&&(e=d,d=b,b=e);a.$.push({x:c.x,y:c.y,wc:b,gd:d})};function Qb(a,b){for(var c in a)a.hasOwnProperty(c)&&!b.hasOwnProperty(c)&&(b[c]=a[c])};function Rb(a,b){J.call(this);this.Tb=b;this.ia=document.createElement("div");this.ia.style.width=b+"px";this.ia.style.height="320px";this.ia.style.border="none";this.ia.style.backgroundColor="#ffffff";this.ia.style.MozUserSelect="none";this.ia.style.WebkitUserSelect="none";this.ia.style.$="none";this.ia.style.ha="none";this.ha={};this.la=1;this.$=[];this.ba=0}
Rb.prototype={width:function(){return parseInt(this.ia.style.width,10)},focus:function(a){0<this.$.length&&(0<arguments.length&&(Sb(this,!1),this.ba=a),Sb(this,!0))},blur:function(){0<this.$.length&&Sb(this,!1)},ub:function(a,b){if(0!==this.$.length){var c="next"===a||"previous"===a;c&&Sb(this,!1);switch(a){case "next":this.ba=Math.min(this.ba+1,this.$.length-1);break;case "previous":this.ba=Math.max(this.ba-1,0);break;case "enter":this.$[this.ba].nf(b)}c&&(Sb(this,!0),b.stopPropagation(),b.preventDefault())}},
moveTo:function(a,b){p(this.ia).da("left",""+a+"px");p(this.ia).da("top",""+b+"px")},show:function(a){this.ia.style.display=a||0===arguments.length?"block":"none"},log:t("TOOLBAR"),yb:function(a,b,c){function d(){var a=e.style.background;e.style.background="#e7d69f";f.style.background="#e7d69f";var b=e.style.background;setTimeout(function(){e.style.background===b&&(e.style.background=a,f.style.background=a)},200)}var e=document.createElement("div"),f=document.createElement("img"),g=this;e.style.display=
"inline";e.style.cssFloat="left";e.style.overflow="hidden";e.style.width=this.Tb+"px";e.style.height=this.Tb+"px";e.style.margin="1px";f.src=a;f.ia=e;f.style.cursor="hand";f.setAttribute("title",b);f.style.maxWidth=this.Tb+"px";f.style.maxHeight=this.Tb+"px";f.draggable=!1;e.appendChild(f);p(f).bind("load",function(){g.log("Toolbar image loaded; %sx%s",f.width,f.height);var a=(this.Tb-f.height)/2;f.style.marginLeft=(this.Tb-f.width)/2+"px";f.style.marginTop=a+"px"});this.ia.appendChild(e);var h=this.$.length;
c&&(p(e).bind("touchstart",function(a){a.preventDefault();g.log("Got touchstart");d();c(a);g.emit("click",a)}),p(e).click(function(a){g.log("Got a click");d();c(a);g.focus(h);g.emit("click",a)}));this.la+=this.Tb+1;this.$.push({element:e,nf:c});return f}};
function Tb(a,b){for(var c in a.ha)a.ha.hasOwnProperty(c)&&(a.ha[c].ia.style.background="#ffffff",a.ha[c].style.background="#ffffff");b in a.ha?(c=a.ha[b],a.log("Highlight %s",b),c.ia.style.background="#9fb3e7",c.style.background="#9fb3e7"):a.log("Failed to highlight %s",b)}function Ub(a,b,c,d,e){a.ha[b]=a.yb(d,c,e)}function Sb(a,b){a.$[a.ba].element.style.outline=b?"1px dotted gray":"none"}Qb(J.prototype,Rb.prototype);function Vb(){J.call(this);Wb(this)}
Vb.prototype={log:t("KEYMAP"),map:function(a,b){var c=a.toLowerCase().split(","),d;if("string"===typeof b){var e=b.split(",");for(d=0;d<c.length;d++)for(var f=0;f<e.length;f++)Xb(this,c[d],e[f])}else for(d=0;d<c.length;d++)Xb(this,c[d],b)},translate:function(a){var b=[],c="";a.keyCode&&(c+=a.keyCode);a.shiftKey&&(c+="-shift");a.ctrlKey&&(c+="-control");a.altKey&&(c+="-alt");a.metaKey&&(c+="-meta");a=c;a in this.keys&&(b=this.keys[a]);this.log("%s",a);return b},jb:function(a,b){for(var c=this.translate(a),
d=0;d<c.length;d++)b(c[d])},detach:function(a){p(a).Ac("keydown",this.ld)}};function Yb(a,b){p(b).bind("keydown",a.ld)}
function Xb(a,b,c){if(0!==b.length){var d=b.match(a.$)||[],e=!1,f=!1,g=!1,h=!1,k=[],l;for(l=0;l<d.length;l++)switch(d[l]){case "alt":g=!0;break;case "control":case "ctrl":f=!0;break;case "shift":e=!0;break;case "shift":e=!0;break;case "home":k.push(36);break;case "end":k.push(35);break;case "pageup":k.push(33);break;case "pagedown":k.push(34);break;case "delete":case "del":k.push(46);break;case "backspace":k.push(8);break;case "up":k.push(38);break;case "right":k.push(39);break;case "down":k.push(40);
break;case "left":k.push(37);break;case "escape":case "esc":k.push(27);break;case "enter":k.push(13);break;case "ins":case "insert":k.push(45);break;case "f4":k.push(115);break;case "meta":case "command":case "cmd":case "\u2318":h=!0;break;default:alert("key entry not found: "+d[l])}d=function(b){e&&-1===b.indexOf("-shift")&&(b+="-shift");f&&-1===b.indexOf("-control")&&(b+="-control");g&&-1===b.indexOf("-alt")&&(b+="-alt");h&&-1===b.indexOf("-meta")&&(b+="-meta");"string"===typeof c?a.log("Keyboard mapping: %s->%s",
b,c):a.log("Keyboard mapping: %s->%s",b,"function()");if(b in a.keys){for(var d=0,l=a.keys[b],d=0;d<l.length&&l[d]!==c;d++);d===l.length&&a.keys[b].push(c)}else a.keys[b]=[c]};if(0===k.length)switch(b=b.toUpperCase().charAt(b.length-1),b){case "=":d("107-shift");d("187");d("61");break;case "+":d("107");d("61-shift");break;case "-":d("109");d("189");d("173");break;default:k.push(b.charCodeAt(0))}for(l=0;l<k.length;l++)d(""+k[l])}}
function Wb(a){a.keys={};a.Ra=!0;a.$=new RegExp("alt backspace cmd command control ctrl del delete down end enter esc escape f4 home ins insert left meta pagedown pageup right shift up \u2318".split(" ").sort(function(a,c){return c.length-a.length}).join("|"),"g");a.ld=function(b){for(var c=a.translate(b),d=0;d<c.length;d++)if("string"===typeof c[d])a.log("action: %s",c[d]),a.rc("*",c[d],b);else c[d](b)}}Qb(J.prototype,Vb.prototype);function Zb(a){var b=document.createElement("input");p(b).ab("type","range");if("range"===b.type)return b.bg=function(a,c){b.min=a;b.max=c},b.Hf=function(){return b.value},b.oe=function(a){b.value=a},b;var c=p("<div>");c.da("display","inline-block");c.da("vertical-align","top");c.da("height","1em");c.da("width","10em");c.da("padding","0.25em");c.da("position","relative");var d=p("<div>");d.da("top","50%");d.da("height","0");d.da("border-top","1px solid black");d.da("border-bottom","1px solid #888888");
d.da("position","absolute");d.da("left","0");d.da("right","0");var e=p("<div>");e.da("height","1em");e.da("left","0px");e.da("background","#888888");e.da("border-top","1px solid #cccccc");e.da("border-left","1px solid #cccccc");e.da("border-bottom","1px solid #000000");e.da("border-right","1px solid #000000");e.da("width","0.5em");e.da("position","absolute");e.da("cursor","pointer");c.append(d);c.append(e);c[0].type="range";c[0].min=0;c[0].max=100;c[0].value=0;c[0].onchange=function(){};c[0].bg=function(a,
b){c[0].min=a;c[0].max=b};c[0].oe=function(a){c[0].value=a;var b=c.width()-e.width();a=a/c[0].max*b;a=Math.round(a);a=Math.max(a,0);a=Math.min(a,c.width());e.da("left",""+a+"px")};c[0].Hf=function(){return c[0].value};var f,g,h,k=t("RANGE");Ka(p(e),function(a){h=!0;f=a.pageX;g=parseInt(e.da("left"),10);k("Mousedown at %s, ox=%s",f,g);a.stopPropagation();a.preventDefault()});Ka(p(c),function(a){var b=c.width()-e.width(),d=a.pageX-p(c).offset().left,d=Math.max(d,0),d=Math.min(d,b);e.da("left",""+d+
"px");f=a.pageX;g=d;d=d/b*(c[0].max-c[0].min)+c[0].min;d=Math.round(d);c[0].value=d;c[0].onchange();h=!0});Ia(p(c),function(a){if(h){var b=c.width()-e.width();a=a.pageX-f+g;a=Math.max(a,0);a=Math.min(a,b);e.da("left",""+a+"px");a=a/b*(c[0].max-c[0].min)+c[0].min;a=Math.round(a);c[0].value=a;c[0].onchange()}});a.bind(p(document.body),"mouseup",function(){h=!1});return c[0]};function y(a,b){this.x=a;this.y=b}y.prototype.pb=function(a){return Math.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y))};y.prototype.toString=function(){return"("+this.x+", "+this.y+")"};y.prototype.Wb=function(a){return this.x===a.x&&this.y===a.y};y.prototype.clone=function(){return new y(this.x,this.y)};function bc(a,b){this.width=a;this.height=b}function Cb(a,b,c,d){return Math.sqrt((a-c)*(a-c)+(b-d)*(b-d))}
function K(a,b,c,d){var e=Cb(a,b,c,d);return 0===e?{x:1,y:0}:{x:(c-a)/e,y:(d-b)/e}}function cc(a){a.x*=-1;a.y*=-1;return a}function L(a,b,c,d){this.x=a;this.y=b;this.width=c;this.height=d;0>this.width&&(this.x+=this.width,this.width=-this.width);0>this.height&&(this.y+=this.height,this.height=-this.height)}
function dc(a){if(0===a.length)return new L(0,0,0,0);for(var b=a[0].x,c=a[0].x,d=a[0].y,e=a[0].y,f=1;f<a.length;f++)a[f].x<b&&(b=a[f].x),a[f].x>c&&(c=a[f].x),a[f].y<d&&(d=a[f].y),a[f].y>e&&(e=a[f].y);return new L(b,d,c-b,e-d)}
L.prototype={save:function(){return{x:this.x,y:this.y,width:this.width,height:this.height}},clone:function(){return new L(this.x,this.y,this.width,this.height)},Wb:function(a){return this.x===a.x&&this.y===a.y&&this.width===a.width&&this.height===a.height},contains:function(a){return this.x<=a.x&&this.x+this.width>a.x+a.width&&this.y<=a.y&&this.y+this.height>a.y+a.height},Ub:function(a,b){return this.x<=a&&this.x+this.width>a&&this.y<=b&&this.y+this.height>b},Pb:function(a,b){void 0===b&&(b=a);this.x-=
a/2;this.y-=b/2;this.width+=a;this.height+=b},transform:function(a){var b,c,d;b=a.apply(this.x,this.y);c=a.apply(this.x+this.width,this.y);d=a.apply(this.x+this.width,this.y+this.height);a=a.apply(this.x,this.y+this.height);this.x=Math.min(b.x,c.x,d.x,a.x);this.y=Math.min(b.y,c.y,d.y,a.y);this.width=Math.max(b.x,c.x,d.x,a.x)-this.x;this.height=Math.max(b.y,c.y,d.y,a.y)-this.y},right:function(){return this.x+this.width},bottom:function(){return this.y+this.height},toString:function(){return"Rectangle("+
this.x+", "+this.y+", "+this.width+", "+this.height+")"}};function hc(a){return new y(a.x+a.width/2,a.y+a.height/2)}function ic(a,b,c){b<a.x?(a.width+=a.x-b,a.x=b):b>a.x+a.width&&(a.width=b-a.x);c<a.y?(a.height+=a.y-c,a.y=c):c>a.y+a.height&&(a.height=c-a.y)}function jc(a,b){b.x<a.x&&(a.width+=a.x-b.x,a.x=b.x);b.y<a.y&&(a.height+=a.y-b.y,a.y=b.y);b.x+b.width>a.x+a.width&&(a.width+=b.x+b.width-a.x-a.width);b.y+b.height>a.y+a.height&&(a.height+=b.y+b.height-a.y-a.height)}
function M(a){if(0===arguments.length)this.m11=1,this.m21=this.m12=0,this.m22=1,this.Ba=this.Aa=0;else if(1===arguments.length){if(6!==arguments[0].length)throw"Bad array initializer for Matrix.";this.m11=arguments[0][0];this.m12=arguments[0][1];this.m21=arguments[0][2];this.m22=arguments[0][3];this.Aa=arguments[0][4];this.Ba=arguments[0][5]}else if(6===arguments.length)this.m11=arguments[0],this.m12=arguments[1],this.m21=arguments[2],this.m22=arguments[3],this.Aa=arguments[4],this.Ba=arguments[5];
else throw"Bad initializer for Matrix.";}
M.prototype={log:t("MATRIX"),toString:function(){return"[ "+this.m11+" "+this.m12+" "+this.Aa+"    "+this.m21+" "+this.m22+" "+this.Ba+"    0 0 1 ]"},Eb:function(){return[this.m11,this.m12,this.m21,this.m22,this.Aa,this.Ba]},Wb:function(a){return this.m11===a.m11&&this.m12===a.m12&&this.m21===a.m21&&this.m22===a.m22&&this.Aa===a.Aa&&this.Ba===a.Ba},multiply:function(a){var b=new M;b.m11=this.m11*a.m11+this.m12*a.m21;b.m21=this.m21*a.m11+this.m22*a.m21;b.m12=this.m11*a.m12+this.m12*a.m22;b.m22=this.m21*
a.m12+this.m22*a.m22;b.Aa=this.m11*a.Aa+this.m12*a.Ba+this.Aa;b.Ba=this.m21*a.Aa+this.m22*a.Ba+this.Ba;return b},apply:function(a,b){return new y(this.m11*a+this.m12*b+this.Aa,this.m21*a+this.m22*b+this.Ba)},clone:function(){return new M(this.m11,this.m12,this.m21,this.m22,this.Aa,this.Ba)},inverse:function(){var a=this.m11*this.m22-this.m12*this.m21;return new M(this.m22/a,-this.m12/a,-this.m21/a,this.m11/a,(this.m12*this.Ba-this.Aa*this.m22)/a,(this.Aa*this.m21-this.m11*this.Ba)/a)}};
function kc(a){var b=a.m11,c=a.m21,d=a.m12,e=a.m22,f=Math.sqrt(b*b+c*c),g=Math.sqrt(d*d+e*e);return new M(b/f,d/g,c/f,e/g,a.Aa,a.Ba)}function lc(a,b){b.transform(a.m11,a.m21,a.m12,a.m22,a.Aa,a.Ba)}function mc(a){return 1===a.m11&&0===a.m12&&0===a.m21&&1===a.m22&&0===a.Aa&&0===a.Ba}
function nc(a,b,c,d){void 0===c?(this.m11=a,this.m21=this.m12=0,this.m22=b,this.aa=this.$=this.Ba=this.Aa=0):(this.m11=a,this.m21=this.m12=0,this.m22=b,this.Aa=c-a*c,this.Ba=d-b*d,this.$=c,this.aa=d);this.ba=a;this.ha=b}nc.prototype.inverse=function(){return new nc(1/this.ba,1/this.ha,this.$,this.aa)};Qb(M.prototype,nc.prototype);function oc(a,b,c){var d=Math.cos(a),e=Math.sin(a);this.m11=d;this.m12=e;this.m21=-e;this.m22=d;this.Aa=-b*d-c*e+b;this.Ba=b*e-c*d+c;this.$=a;this.x=b;this.y=c}
oc.prototype.inverse=function(){return new oc(-this.$,this.x,this.y)};Qb(M.prototype,oc.prototype);function pc(a,b,c){var d=Math.cos(2*a),e=Math.sin(2*a);this.m11=d;this.m21=this.m12=e;this.m22=-d;this.Aa=-b*d-c*e+b;this.Ba=-b*e+c*d+c;this.$=a;this.x=b;this.y=c}pc.prototype.inverse=function(){return new pc(-this.$,this.x,this.y)};Qb(M.prototype,pc.prototype);function E(a,b){this.m11=1;this.m21=this.m12=0;this.m22=1;this.Aa=a;this.Ba=b}E.prototype.inverse=function(){return new E(-this.Aa,-this.Ba)};
Qb(M.prototype,E.prototype);function qc(a,b,c,d,e,f,g,h,k,l){if(!(8<++rc)){var n=(b+d)/2,q=(c+e)/2,r=(d+f)/2,u=(e+g)/2,v=(f+h)/2,w=(g+k)/2,z=(n+r)/2,sa=(q+u)/2,r=(r+v)/2,u=(u+w)/2,$c=(z+r)/2,ad=(sa+u)/2,$b=h-b,ac=k-c;d=Math.abs((d-h)*ac-(e-k)*$b);f=Math.abs((f-h)*ac-(g-k)*$b);(d+f)*(d+f)<l*($b*$b+ac*ac)?a.push(new y($c,ad)):(qc(a,b,c,n,q,z,sa,$c,ad,l),qc(a,$c,ad,r,u,v,w,h,k,l))}--rc}var rc=0;
function sc(a,b,c,d,e,f,g,h){if(!(8<++rc)){var k=(b+d)/2,l=(c+e)/2,n=(d+f)/2,q=(e+g)/2,r=(k+n)/2,u=(l+q)/2,v=f-b,w=g-c;d=Math.abs((d-f)*w-(e-g)*v);d*d<=h*(v*v+w*w)?a.push(new y(r,u)):(sc(a,b,c,k,l,r,u,h),sc(a,r,u,n,q,f,g,h))}--rc}function tc(a,b,c){var d,e,f,g,h,k,l,n,q=0;if(3>a.length)return 0;f=a[a.length-1].x;g=a[a.length-1].y;for(n=0;n<a.length;n++)d=a[n].x,e=a[n].y,d>f?(h=f,l=d,k=g,g=e):(h=d,l=f,k=e),d<b===b<=f&&(c-k)*(l-h)<(g-k)*(b-h)&&(q=!q),f=d,g=e;return q}
function uc(a){this.closed=!1;this.ea=[];a instanceof L&&(this.moveTo(a.x,a.y),this.lineTo(a.x+a.width,a.y),this.lineTo(a.x+a.width,a.y+a.height),this.lineTo(a.x,a.y+a.height),this.lineTo(a.x,a.y),this.close())}var Lb=0,Mb=1,Ob=4,Pb=[3,3,7,5,1],vc=[1,1,3,2,0];
uc.prototype={moveTo:function(a,b){this.ea.push(Lb,a,b)},lineTo:function(a,b){this.ea.push(Mb,a,b)},bezierCurveTo:function(a,b,c,d,e,f){this.ea.push(2,a,b,c,d,e,f)},quadraticCurveTo:function(a,b,c,d){this.ea.push(3,a,b,c,d)},close:function(){this.ea.push(Ob)},na:function(a){for(var b=0;b<this.ea.length;){switch(this.ea[b]){case Lb:a.moveTo(this.ea[b+1],this.ea[b+2]);break;case Mb:a.lineTo(this.ea[b+1],this.ea[b+2]);break;case 2:a.bezierCurveTo(this.ea[b+1],this.ea[b+2],this.ea[b+3],this.ea[b+4],this.ea[b+
5],this.ea[b+6]);break;case 3:a.quadraticCurveTo(this.ea[b+1],this.ea[b+2],this.ea[b+3],this.ea[b+4]);break;case Ob:a.closePath();break;default:alert("Error!")}b+=Pb[this.ea[b]]}},transform:function(a){for(var b=0,c,d;b<this.ea.length;){d=vc[this.ea[b]];for(c=0;c<d;c++){var e=a.apply(this.ea[b+1+2*c],this.ea[b+1+2*c+1]);this.ea[b+1+2*c]=e.x;this.ea[b+1+2*c+1]=e.y}b+=Pb[this.ea[b]]}},clone:function(){var a=new uc;a.ea=this.ea.concat();return a},append:function(a){this.ea=this.ea.concat(a.ea)}};
function Kb(a){function b(a,b){f-=(a-d)*(b+e);d=a;e=b}for(var c=0,d,e,f=0;c<a.ea.length;){switch(a.ea[c]){case Lb:d=a.ea[c+1];e=a.ea[c+2];break;case Mb:b(a.ea[c+1],a.ea[c+2]);break;case 2:b(a.ea[c+5],a.ea[c+6]);break;case 3:b(a.ea[c+3],a.ea[c+4])}c+=Pb[a.ea[c]]}return f/2}
function wc(a,b,c){for(var d=0,e=0,f=c[0],g,h=new y(0,0),k;d<a.ea.length;){switch(a.ea[d]){case Lb:k=a.ea[d+1];g=a.ea[d+2];b.moveTo(k,g);h=new y(k,g);break;case Mb:k=a.ea[d+1];var l=g=a.ea[d+2],n=new y(k,l);g=h.pb(n);if(!(0>=g)){for(;g>f;)h.x+=(n.x-h.x)*f/g,h.y+=(n.y-h.y)*f/g,e&1?b.moveTo(h.x,h.y):b.lineTo(h.x,h.y),g-=f,e=(e+1)%c.length,f=c[e];g<=f&&(h=new y(k,l),e&1?b.moveTo(h.x,h.y):b.lineTo(h.x,h.y),f-=g)}}d+=Pb[a.ea[d]]}}
function xc(a,b){for(var c=0,d,e,f=new L(a.ea[1],a.ea[2],0,0),g;c<a.ea.length;){switch(a.ea[c]){case Lb:case Mb:d=a.ea[c+1];e=a.ea[c+2];ic(f,d,e);break;case 2:var h=g=[],k=a.ea[c+5],l=a.ea[c+6];qc(h,d,e,a.ea[c+1],a.ea[c+2],a.ea[c+3],a.ea[c+4],k,l,b*b);h.push(new y(k,l));for(d=0;d<g.length;d++)ic(f,g[d].x,g[d].y);d=a.ea[c+5];e=a.ea[c+6];break;case 3:h=g=[];k=a.ea[c+3];l=a.ea[c+4];sc(h,d,e,a.ea[c+1],a.ea[c+2],k,l,b*b);h.push(new y(k,l));for(d=0;d<g.length;d++)ic(f,g[d].x,g[d].y);d=a.ea[c+3];e=a.ea[c+
4]}c+=Pb[a.ea[c]]}return f}function yc(a){for(var b=0,c,d=[];b<a.ea.length;){var e=vc[a.ea[b]];for(c=0;c<e;c++)d.push(new y(a.ea[b+1+2*c],a.ea[b+1+2*c+1]));b+=Pb[a.ea[b]]}return d}function zc(a,b,c,d,e){var f;if(2>=d-c)e.push(a[c]);else{var g=a[c],h=a[d-1],k=0,l=0;for(f=c+1;f<d;f++){var n,q=a[f],r=g.x;n=g.y;var u=q.x,q=q.y,v=h.x-r,w=h.y-n,z=((u-r)*v+(q-n)*w)/(v*v+w*w);1<z?z=1:0>z&&(z=0);r=r+z*v-u;n=n+z*w-q;n=Math.sqrt(r*r+n*n);n>k&&(k=n,l=f)}0<l&&k>b?(zc(a,b,c,l,e),zc(a,b,l,d,e)):e.push(g)}}
function Ac(a,b){var c=[];zc(a,b,0,a.length,c);0<a.length&&0<c.length&&!a[a.length-1].Wb(c[c.length-1])&&c.push(a[a.length-1]);return c}function Bc(a){this.ta=[];if(1===arguments.length){var b=arguments[0];if(b instanceof L)this.ta.push(new y(b.x,b.y)),this.ta.push(new y(b.right(),b.y)),this.ta.push(new y(b.right(),b.bottom())),this.ta.push(new y(b.x,b.bottom()));else if(b instanceof Array)this.ta=b;else throw alert("Bad parameter passed to Polygon() constructor."),"Error";}}
Bc.prototype={transform:function(a){for(var b=0;b<this.ta.length;b++)this.ta[b]=a.apply(this.ta[b].x,this.ta[b].y)},add:function(a,b){this.ta.push(new y(a,b))},Ub:function(a,b){return tc(this.ta,a,b)},clone:function(){return new Bc(this.ta.slice(0))},Wb:function(a){if(this.ta.length!==a.ta.length)return!1;for(var b=0;b<this.ta.length;b++){var c=this.ta[b],d=a.ta[b];if(c.x!==d.x||c.y!==d.y)return!1}return!0},Pb:function(a){for(var b=[],c=0;c<this.ta.length;c++){var d=this.ta[0===c?this.ta.length-1:
c-1],e=this.ta[c],f=this.ta[c===this.ta.length-1?0:c+1],g=Cb(d.x,d.y,e.x,e.y),h=Cb(f.x,f.y,e.x,e.y);b.push({x:e.x+((e.x-d.x)/g+(e.x-f.x)/h)/Math.sqrt(2)*a,y:e.y+((e.y-d.y)/g+(e.y-f.y)/h)/Math.sqrt(2)*a})}this.ta=b},na:function(a){if(!(1>this.ta.length)){a.moveTo(this.ta[0].x,this.ta[0].y);for(var b=1;b<this.ta.length;b++)a.lineTo(this.ta[b].x,this.ta[b].y);a.closePath()}}};
function Cc(a,b){function c(a){var b,c,h,k,l;b=[];c=h=0;for(k=a.length;c<k;c++)l=a[c],a[h+1]&&(b[h]=d(l,a[h+1])),h+=1;return b}function d(a,b){return new y(a.x+(b.x-a.x)/2,a.y+(b.y-a.y)/2)}return b?Cc(c(c(function(a){var b,c,h,k,l;a=[a[0]].concat(a).concat(a[a.length-1]);l=[];b=c=0;for(h=a.length;b<h;b++)k=a[b],l[2*c]=k,a[c+1]&&(l[2*c+1]=d(k,a[c+1])),c+=1;return l}(a))),b-1):a};function Dc(a,b,c,d,e){this.view=a;this.aa=b;this.sa=c;this.view.ad=this.aa instanceof Ec;this.oa=!1;this.La(d,e)}function Fc(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].id);return b}
Dc.prototype={log:t("TransformSelectionBehaviour"),Wa:function(a){var b;if(!this.oa){for(b=0;b<a.touches.length;){b=a.touches[b];b=x(this.view,b.pageX,b.pageY);"touchmove"===a.type&&this.Na(b.x,b.y,a);break}for(b=0;b<a.changedTouches.length;){b=a.changedTouches[b];b=x(this.view,b.pageX,b.pageY);"touchend"===a.type&&this.Oa(b.x,b.y,a);break}}},uc:function(a){this.log("%s scale=%s rotation=%s",a.type,a.scale,a.rotation);this.oa=!0;var b=this.la.x+this.la.width/2,c=this.la.y+this.la.height/2,d=a.scale;
this.view.Rb||(d=1);var e=-a.rotation/180*Math.PI;if(0<this.view.fa.get("snap"))var f=Math.PI/16,e=Math.floor(e/f)*f;b=(new nc(d,d,b,c)).multiply(new oc(e,b,c));c=b.inverse();for(d=0;d<this.za.length;d++)Gc(this.za[d],b.multiply(this.ha[d]),this.ba[d].multiply(c)),this.za[d].format(this.view.ma,this.view.request);this.view.lc=b;this.view.na();if("gestureend"===a.type){for(d=0;d<this.za.length;d++)Gc(this.za[d],this.ha[d],this.ba[d]);this.view.ya([new Hc(Fc(this.za),b,b.inverse())]);Ic(this)}},La:function(a,
b){this.$=this.view.Ta(new y(a,b));this.log("onMouseDown(%s,%s)",this.$.x,this.$.y);var c=this.za=Jc(this.view);this.ha=[];this.ba=[];for(var d=0;d<c.length;d++)this.ha.push(c[d].Ua()),this.ba.push(Kc(c[d]));this.la=new L(this.view.ha.x,this.view.ha.y,this.view.ha.width,this.view.ha.height)},Na:function(a,b){var c=this,d=this.view.Ta(new y(a,b));a=d.x;b=d.y;for(var d=this.aa.Dc(new y(d.x-this.$.x,d.y-this.$.y)),e=d.inverse(),f=0;f<this.za.length;f++)Gc(this.za[f],d.multiply(this.ha[f]),this.ba[f].multiply(e)),
this.za[f].format(this.view.ma,this.view.request);this.view.lc=d;this.view.na(function(){if(c.aa instanceof Ec){var d=c.view.ma;d.save();d.beginPath();d.strokeStyle="#0050B7";d.lineWidth=1/c.view.scale;d.moveTo(c.aa.origin.x,c.aa.origin.y);d.lineTo(a,b);d.stroke();d.restore()}})},Oa:function(a,b){var c=a,d=b,e=this.view.Ta(new y(a,b));a=e.x;b=e.y;this.log("onMouseUp(%s,%s)",a,b);if(e.Wb(this.$))this.sa?(c=this.view.ka.gb(c,d,this.view.Ja))&&c.md()?(this.log("Didn't move, and has edit mode. Selecting node %s",
c.id),this.view.Za(),this.view.Ca=c):this.log("Didn't move, but node has no edit mode or failed hittest"):this.log("Didn't move, but toggleEditNode=false");else{this.log("Moved by %s,%s",a-this.$.x,b-this.$.y);c=this.aa.Dc(new y(e.x-this.$.x,e.y-this.$.y));for(d=0;d<this.za.length;d++)Gc(this.za[d],this.ha[d],this.ba[d]);this.view.ya([new Hc(Fc(this.za),c,c.inverse())])}Ic(this)},hc:function(){this.log("onDoubleClick")}};
function Ic(a){var b=new M;a.view.lc=b;a.view.ad=!0;Lc(a.view);a.view.update(!0);G(a.view)};var Mc=t("FitCurve");
function Nc(a){function b(a){z.bezierCurveTo(a[1].x,a[1].y,a[2].x,a[2].y,a[3].x,a[3].y);Mc("Bezier: (%s,%s), (%s,%s), (%s,%s), (%s,%s)",a[0].x,a[0].y,a[1].x,a[1].y,a[2].x,a[2].y,a[3].x,a[3].y)}function c(a,b){return a.x*b.x+a.y*b.y}function d(a){var b=1-a;return 3*a*b*b}function e(a){return 3*a*a*(1-a)}function f(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)}function g(a){return a.x*a.x+a.y*a.y}function h(a,b){var c=Math.sqrt(g(a));0!==c&&(a.x*=b/c,a.y*=b/c);return a}function k(a,b,c){void 0===
c&&Mc("Undef!");c.x=a.x+b.x;c.y=a.y+b.y}function l(a,b){return{x:a.x+b.x,y:a.y+b.y}}function n(a,b){return{x:a.x*b,y:a.y*b}}function q(a,b){return{x:a.x-b.x,y:a.y-b.y}}function r(a,b,g,r,u){var v,w=[],z,B=[[],[]],O=[],fa,U;U=[{},{},{},{}];z=b-0+1;for(v=0;v<z;v++){fa={x:r.x,y:r.y};var ga={x:u.x,y:u.y};h(fa,d(g[v]));h(ga,e(g[v]));w[v]=[fa,ga]}B[0][0]=0;B[0][1]=0;B[1][0]=0;B[1][1]=0;O[0]=0;for(v=O[1]=0;v<z;v++)B[0][0]+=c(w[v][0],w[v][0]),B[0][1]+=c(w[v][0],w[v][1]),B[1][0]=B[0][1],B[1][1]+=c(w[v][1],
w[v][1]),fa=1-g[v],ga=g[v],fa=q(a[0+v],l(n(a[0],fa*fa*fa),l(n(a[0],d(g[v])),l(n(a[b],e(g[v])),n(a[b],ga*ga*ga))))),O[0]+=c(w[v][0],fa),O[1]+=c(w[v][1],fa);g=B[0][0]*B[1][1]-B[1][0]*B[0][1];v=B[0][0]*O[1]-B[0][1]*O[0];O=O[0]*B[1][1]-O[1]*B[0][1];0===g&&(g=B[0][0]*B[1][1]*1E-11);B=O/g;O=v/g;if(0>B||0>O)return B=f(a[b],a[0])/3,U[0]=a[0],U[3]=a[b],k(U[0],h(r,B),U[1]),k(U[3],h(u,B),U[2]),U;U[0]=a[0];U[3]=a[b];k(U[0],h(r,B),U[1]);k(U[3],h(u,O),U[2]);return U}function u(a,b,c){var d,e;e=[];for(d=0;d<=a;d++)e[d]=
{x:b[d].x,y:b[d].y};for(d=1;d<=a;d++)for(b=0;b<=a-d;b++)e[b].x=(1-c)*e[b].x+c*e[b+1].x,e[b].y=(1-c)*e[b].y+c*e[b+1].y;return e[0]}function v(a){var b=Math.sqrt(Math.sqrt(g(a)));0!==b&&(a.x/=b,a.y/=b);return a}function w(a,b,c,d){var e,f,h,k=(b-0+1)/2;f=0;for(e=1;e<b;e++)h=u(3,c,d[e-0]),h=q(h,a[e]),h=g(h),h>=f&&(f=h,k=e);return{Of:f,Kg:k}}var z=new uc;z.moveTo(a[0].x,a[0].y);(function(a,c,d){var e;e=q(a[1],a[0]);e=v(e);var g=c-1,g=q(a[g-1],a[g]),g=v(g);a:{c=c-1;var l,n;l=[{},{},{},{}];if(2===c-0+1)d=
f(a[c],a[0])/3,l[0]=a[0],l[3]=a[c],k(l[0],h(e,d),l[1]),k(l[3],h(g,d),l[2]),b(l);else{var z=[0];for(n=1;n<=c;n++)z[n-0]=z[n-0-1]+f(a[n],a[n-1]);for(n=1;n<=c;n++)z[n-0]/=z[c-0];l=r(a,c,z,e,g);n=w(a,c,l,z).Of;if(n<d)b(l);else for(;;){d=a;n=c;for(var B=void 0,O=[],O=[],B=0;B<=n;B++){for(var fa=O,U=B-0,ga=l,ec=d[B],fc=z[B-0],Aa=[],gc=[],tb=void 0,F=void 0,cd=void 0,F=void 0,tb=u(3,ga,fc),F=0;2>=F;F++)Aa[F]={},Aa[F].x=3*(ga[F+1].x-ga[F].x),Aa[F].y=3*(ga[F+1].y-ga[F].y);for(F=0;1>=F;F++)gc[F]={},gc[F].x=
2*(Aa[F+1].x-Aa[F].x),gc[F].y=2*(Aa[F+1].y-Aa[F].y);F=u(2,Aa,fc);cd=u(1,gc,fc);fa[U]=fc-((tb.x-ec.x)*F.x+(tb.y-ec.y)*F.y)/(F.x*F.x+F.y*F.y+(tb.x-ec.x)*cd.x+(tb.y-ec.y)*cd.y)}d=O;l=r(a,c,d,e,g);w(a,c,l,d);b(l);break a}}}})(a,a.length,25);return z};function Oc(a,b,c,d,e,f){var g=this;this.view=a;this.nodeType=b;this.ga=c;this.width=d;this.height=e;this.aa=f;this.state="initial";this.node=this.$=null;this.ba=function(){};"rectangle-tl"===f&&(this.ba=function(a){a.lineWidth=1/g.view.scale;a.strokeStyle="#ccc";a.beginPath();a.rect(g.start.x,g.start.y,g.end.x-g.start.x,g.end.y-g.start.y);a.stroke()})}
Oc.prototype={log:t("DrawShape"),Gb:function(){this.log("Entering DrawShapeBehaviour");this.view.canvas.style.cursor="crosshair"},Jb:function(){this.log("Leaving DrawShapeBehaviour");this.node&&(this.view.ka.removeNode(this.node),this.view.update(),this.node=null)},ub:function(a){"cancel"===a&&G(this.view)},Wa:function(a){var b;"touchstart"===a.type?(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.La(b.x,b.y)):"touchmove"===a.type?(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.Na(b.x,
b.y,a)):"touchend"===a.type&&(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.Oa(b.x,b.y,a))},La:function(a,b){"initial"===this.state&&(this.start=this.view.Ta(new y(a,b)),this.state="predraw",this.log("initial -> predraw"))},Na:function(a,b,c){a=this.view.Ta(new y(a,b));"predraw"===this.state&&10<this.start.pb(a)&&(Pc(this),this.state="drawing",this.log("predraw -> drawing"));"drawing"===this.state&&(this.transform(this.start,a,c.ctrlKey),this.end=a,this.view.update(!1,this.ba))},Oa:function(a,
b,c){"predraw"===this.state?(Pc(this),this.transform(this.start,null,c.ctrlKey),this.ya(),this.view.fa.get("autoPickTool")&&G(this.view),this.state="initial"):"drawing"===this.state&&(this.transform(this.start,this.view.Ta(new y(a,b)),c.ctrlKey),this.ya(),this.view.fa.get("autoPickTool")&&G(this.view),this.state="initial")},transform:function(a,b,c){var d,e;if(b)if("circle"===this.aa)d=a,a=a.pb(b),e=2*a/this.width,a=2*a/this.height;else if("rectangle-tl"===this.aa)a=a.clone(),b=b.clone(),a.x>b.x&&
(e=a.x,a.x=b.x,b.x=e),a.y>b.y&&(e=a.y,a.y=b.y,b.y=e),d=a,e=(b.x-a.x)/this.width,a=(b.y-a.y)/this.height;else{e=[a,b];if(0===e.length)d=new y(0,0);else{d=e[0].x;for(var f=e[0].y,g=1;g<e.length;g++)d+=e[g].x,f+=e[g].y;d=new y(d/e.length,f/e.length)}e=(b.x-a.x)/this.width;a=(b.y-a.y)/this.height}else d=a,a=e=1;c&&(a=e=Math.min(e,a));c=new E(d.x,d.y);c=c.multiply(new nc(e,a));Gc(this.node,c,c.inverse());Qc(this.view.ka,this.node.id)},ya:function(){this.ga.matrix=this.node.Ua();this.ga.inverse=Kc(this.node);
this.view.ka.removeNode(this.node);this.node=null;this.view.ya([new D(this.nodeType,this.ga)])},Bb:function(a){gb.prototype.Bb.call(this,a);this.ga[a.$c?"fillStyle":"strokeStyle"]=a.Sa},Qb:function(a,b){gb.prototype.Qb.call(this,a,b);var c=b?"fillStyle":"strokeStyle",d=Rc(this.ga[c]);this.ga[c]=d},Nb:function(){return this.aa}};function Pc(a){a.node=Sc(a.nodeType,a.view.ka.hb,a.view.ka);Tc(a.node,a.ga);Uc(a.view.ka,a.node)};function Vc(a){this.view=a;this.ba=!1;this.aa=this.$=null;this.la=a.fa.get("multilineText");this.ha="normal";a.fa.get("iPadNoScrollText")&&null!==navigator.userAgent.match(/iPad/i)&&(this.ha="top")}
Vc.prototype={log:t("Text"),Gb:function(){this.log("Entering text mode");this.view.canvas.style.cursor="text"},Jb:function(){this.ba&&Wc(this);this.view.canvas.style.cursor="default";this.log("Leaving text mode");this.$&&(this.$.parentNode.removeChild(this.$),this.$=null)},Wa:function(a){for(var b=0;b<a.touches.length;b++){var c=a.touches[b],c=x(this.view,c.pageX,c.pageY);"touchstart"===a.type&&this.La(c.x,c.y,a)}},La:function(a,b){if(this.ba&&(this.log("Editing somewhere else on mousedown; submit that first."),
Wc(this),this.view.fa.get("autoPickTool"))){G(this.view);return}var c=this.view.ka.gb(a,b,this.view.Ja);Xc(this,c,a,b)},cancel:function(){this.$&&(this.$.parentNode.removeChild(this.$),this.view.ua.emit("edit-text-hidden"));this.$=null;this.ba=!1;this.Ca&&(this.Ca.Tc(!1),this.view.na())},Na:function(){},ub:function(a){this.log("keyboard: %s",a);"cancel"===a&&null===this.$&&(G(this.view),this.view.qb.emit("goto-toolbar"))},Bb:function(a){this.log("Set text colour to %s",a.Sa);this.view.setProperty("textFillStyle",
a.Sa)},Qb:function(a,b){Yc(this.view,a,b)},Nb:function(){return"text"}};
function Wc(a){var b=a.$.value;a.cancel();if(a.Ca&&a.Ca.qa("text")===b)a.log("Text was not changed.");else if(null===a.Ca&&""===b)a.log("No text entered.");else if(a.Ca)a.log("Update text in node %s",a.Ca.id),a.view.ya([new Zc([a.Ca.id],"text",b)]);else{a.log("Create new text node.");var c=a.view.ka.hb,d=new E(a.aa.x,a.aa.y+a.view.va.fontSize);a.view.ya([new D("TextNode",{text:b,fontSize:a.view.va.fontSize,fontName:a.view.va.fontName,bold:a.view.va.bold,italic:a.view.va.italic,textFillStyle:a.view.va.textFillStyle,
strokeStyle:a.view.va.textStrokeStyle,lineWidth:a.view.va.textLineWidth,layer:a.view.Ja,wrap:a.view.fa.get("multilineText")}),new Hc([c],d,d.inverse())])}}
function Xc(a,b,c,d){function e(){a.$&&(a.log("Set editBox height to %s",""+a.$.scrollHeight+"px"),a.$.style.height=""+a.$.scrollHeight+"px",a.$.style.width=""+a.$.scrollWidth+"px");n=null}var f,g,h,k,l=0;b&&"TextNode"===b.type()||b&&"PathNode"===b.type()&&a.view.fa.get("allowTextInShape")?(a.Ca=b,"top"!==a.ha&&"TextNode"===b.type()&&a.Ca.Tc(!0),a.view.na(),a.aa=new y(b.rect.x,b.rect.y),f=b.qa("fontName"),g=b.qa("fontSize"),h=b.qa("bold"),k=b.qa("italic"),l=b.kb().width*a.view.scale,l=Math.max(l,
200)):(a.Ca=null,a.aa=new y(c,d),f=a.view.va.fontName,g=a.view.va.fontSize,h=a.view.va.bold,k=a.view.va.italic);a.$=document.createElement("textarea");b=p(a.$).height();l&&(a.$.style.width=""+l+"px");l=bd(a.view,a.aa.x,a.aa.y);a.$.style.position="absolute";a.$.style.fontFamily=f;a.$.style.fontSize=""+g*a.view.scale+"px";a.$.style.overflow="auto";a.$.style.fontWeight=h?"bold":"normal";a.$.style.fontStyle=k?"italic":"normal";a.$.style.zIndex=a.view.sc()+1;"top"===a.ha?(f=p(a.view.canvas).offset(),g=
p(a.view.canvas).width(),l=p(a.$).width(),a.$.style.left=""+(f.left+g/2-l/2)+"px",a.$.style.top=""+f.top+"px"):(a.$.style.left=""+Math.round(l.x)+"px",a.$.style.top=""+Math.round(l.y)+"px");a.$.style.WebkitTransitionDuration="0";a.$.style.MozTransitionDuration="0";a.$.style.ba="0";a.$.style.aa="0";a.$.style.transitionDuration="0";document.body.appendChild(a.$);dd(a.$);a.ba=!0;a.aa=new y(c,d+b);a.Ca&&(a.$.value=a.Ca.qa("text"));var n=null,n=setTimeout(e,0);p(a.$).bind("keydown",function(b){27===b.keyCode&&
a.la||13===b.keyCode&&(b.shiftKey||!a.la)?(a.log("Enter pressed. create text."),Wc(a),a.view.Ea.fb&&ed(a.view),a.view.qb.rc("goto-canvas"),a.view.fa.get("autoPickTool")&&G(a.view)):27===b.keyCode?(a.log("ESC pressed; cancel."),a.cancel(),G(a.view),a.view.qb.emit("goto-toolbar")):13===b.keyCode&&(n||(n=setTimeout(e,0)))});setTimeout(function(){a.$&&a.$.focus()},200);a.$.focus();a.view.ua.emit("edit-text-shown",a.$)};function fd(a,b,c,d){this.node=a;this.xa=b;this.$=c;this.origin=d;a=this.xa.apply(c.x,c.y);this.x=a.x;this.y=a.y}fd.prototype={Dc:function(a){var b=1,c=1,d=this.xa.inverse(),e=d.apply(this.x+a.x,this.y+a.y);a=new y(this.$.x-this.origin.x,this.$.y-this.origin.y);e=new y(e.x-this.origin.x,e.y-this.origin.y);e=(e.x*a.x+e.y*a.y)/(a.x*a.x+a.y*a.y);0!==a.x&&0!==a.y?c=b=e:0!==a.x?b=e:c=e;return this.xa.multiply(new nc(b,c,this.origin.x,this.origin.y)).multiply(d)}};
function Ec(a,b,c,d,e){this.node=a;this.xa=b;this.origin=this.xa.apply(d.x,d.y);a=this.xa.apply(c.x,c.y);this.x=a.x;this.y=a.y;this.aa=Math.atan2(this.y-this.origin.y,this.x-this.origin.x);this.$=e}Ec.prototype={log:t("RotationSelHandle"),Dc:function(a){a=Math.atan2(this.y+a.y-this.origin.y,this.x+a.x-this.origin.x)-this.aa;if(this.$){var b=Math.PI/16;a=Math.floor(a/b)*b}return new oc(-a,this.origin.x,this.origin.y)}};function gd(a,b){this.node=a;this.xa=b;this.y=this.x=0}
gd.prototype={Dc:function(a){return new E(a.x,a.y)}};function hd(){}hd.prototype={Dc:function(){return new M}};function id(){this.text="";this.font="10px Arial";this.la="Arial";this.fontSize=10;this.$=[];this.rect=new L(0,0,0,this.fontSize);this.ba="left";this.aa="top";this.oa=this.ha=!1}m=id.prototype;m.log=t("TextBox");function jd(a,b,c){switch(b){case "left":case "centre":case "right":a.aa=b;break;case null:break;default:a.log("Unknnown alignment: %s",b)}switch(c){case "top":case "middle":case "bottom":a.ba=c;break;case null:break;default:a.log("Unknnown alignment: %s",c)}}
m.format=function(a,b,c){this.font=""+this.fontSize+'px "'+this.la+'"';this.ha&&(this.font="bold "+this.font);this.oa&&(this.font="italic "+this.font);this.$.length=0;var d,e;a.font=this.font;var f=0;this.rect.width=0;if(0===b){var g=this.text.split("\n");for(d=0;d<g.length;d++){var h=g[d];e=a.measureText(h).width;f+=this.fontSize;this.$.push({x:0,y:f,width:e,text:h});this.rect.width=Math.max(this.rect.width,e)}}else{var h=g=0,k=!1;for(d=0;d<this.text.length;d++){var l=this.text.charAt(d);e=a.measureText(this.text.substr(g,
d-g+1)).width;"\n"===l?k=!0:e>b?h?(d=h,k=!0):d>g&&(--d,k=!0):" "===l&&(h=d);k&&(e=" "===this.text.charAt(d)?a.measureText(this.text.substr(g,d-g)).width:a.measureText(this.text.substr(g,d-g+1)).width,f+=this.fontSize,this.$.push({x:0,y:f,width:e,text:this.text.substr(g,d-g+1)}),g=d+1,h=0,k=!1,this.rect.width=Math.max(this.rect.width,e))}e&&(f+=this.fontSize,this.$.push({x:0,y:f,width:e,text:this.text.substr(g,d-g)}),this.rect.width=Math.max(this.rect.width,e))}this.rect.x=0;this.rect.y=0;this.rect.height=
f;if("centre"===this.aa)for(d=0;d<this.$.length;d++)a=this.$[d],a.x=this.rect.width/2-a.width/2;else if("right"===this.aa)for(d=0;d<this.$.length;d++)a=this.$[d],a.x=this.rect.width-a.width;b&&"centre"===this.aa?this.rect.x=b/2-this.rect.width/2:b&&"right"===this.aa&&(this.rect.x=b-this.rect.width);c&&"middle"===this.ba?this.rect.y=c/2-this.rect.height/2:c&&"bottom"===this.ba&&(this.rect.y=c-this.rect.height)};m.na=function(a,b,c){this.fillText(a,b,c)};
m.fillText=function(a,b,c){a.textBaseline="alphabetic";a.font=this.font;for(var d=0;d<this.$.length;d++){var e=this.$[d];a.fillText(e.text,this.rect.x+e.x+b,this.rect.y+e.y+c)}};m.strokeText=function(a,b,c){a.textBaseline="alphabetic";a.font=this.font;for(var d=0;d<this.$.length;d++){var e=this.$[d];a.strokeText(e.text,this.rect.x+e.x+b,this.rect.y+e.y+c)}};function kd(a,b){ld(this,a,b,kd)}var md={fillStyle:"#cccccc",strokeStyle:"#000000",lineWidth:2,shadow:!1};
kd.prototype={log:t("BaseNode"),clip:function(){},md:function(){return!1},Id:function(){return null},Fd:function(){},ce:function(){return!1},Hd:function(){return"text"in this.ga},clone:function(a){a=new this.constructor(a(),this.ka);Tc(a,nd(this));return a},type:function(){return"BaseNode"},Ua:function(){return this.ga.matrix},setProperty:function(a,b){if(a in this.ga||"tag"===a||"locked"===a||"lockSize"===a||"lockRotation"===a||"lockPosition"===a||"lockEditMode"===a||"rotationHandles"===a||"lockAspectRatio"===
a||"zIndex"===a)this.ga[a]=b},qa:function(a){return this.ga[a]},kb:function(){return this.rect},Yd:function(){return new Bc(this.rect)},sc:function(){return this.qa("zIndex")||0},transform:function(a,b){this.ga.matrix=a.multiply(this.ga.matrix);this.ga.inverse=this.ga.inverse.multiply(b)},format:function(){},gb:function(a,b){var c=Kc(this).apply(a,b);return this.oa||this.qa("locked")||!this.Fb.Ub(c.x,c.y)?null:this},Tc:function(a){this.oa=a},yc:function(){},ge:function(){},ie:function(){},na:function(a){a.save();
var b=this.ga.matrix;a.transform(b.m11,b.m21,b.m12,b.m22,b.Aa,b.Ba);"erase"===this.ga.strokeStyle?(a.strokeStyle="#000000",a.globalCompositeOperation="destination-out"):a.strokeStyle=this.ga.strokeStyle;a.fillStyle=this.ga.fillStyle;a.lineWidth=this.ga.lineWidth;this.ga.shadow&&(a.shadowOffsetX=3,a.shadowOffsetY=3,a.shadowBlur=5,a.shadowColor="rgba(0,0,0,0.5)");this.oc(a);a.restore()},oc:function(){}};function Gc(a,b,c){a.ga.matrix=b;a.ga.inverse=c}function Kc(a){return a.ga.inverse}
function od(a){return null!==a.parent&&null!==a.parent.parent&&"PageNode"!==a.parent.type()}function pd(a){return void 0!==a.children}function qd(a){return(a=a.qa("layer"))?""+a:"default"}function Tc(a,b){for(var c in b)b.hasOwnProperty(c)&&a.setProperty(c,b[c])}function nd(a){var b={},c;for(c in a.ga)a.ga.hasOwnProperty(c)&&(b[c]=a.qa(c));return b}function rd(a,b){for(var c in b)b.hasOwnProperty(c)&&(a.ga[c]=b[c])}
function ld(a,b,c,d){a.id=b;a.ka=c;a.ga={};rd(a,md);a.rect=new L(0,0,1,1);a.ga.matrix=new M;a.ga.inverse=new M;a.ga.layer="default";a.parent=null;a.constructor=d;a.oa=!1;a.Fb=new L(0,0,1,1)}var sd={};function td(a,b,c){var d=[{},kd.prototype];c&&d.push(c.prototype);d.push(b.prototype);b.prototype=p.$.apply(null,d);sd[a]=b}function Sc(a,b,c){return a in sd?new sd[a](b,c):null};function ud(a,b){ld(this,a,b,ud);this.parent=null;this.children=[]}m=ud.prototype;m.type=function(){return"GroupNode"};m.clone=function(a){for(var b=new ud(a(),this.ka),c=0;c<this.children.length;c++){var d=this.children[c].clone(a);d.parent=b;b.children.push(d)}return b};m.format=function(a,b){for(var c=0;c<this.children.length;c++)this.children[c].format(a,b),0===c?this.rect=this.children[c].rect.clone():jc(this.rect,this.children[c].rect)};m.na=function(a){for(var b=0;b<this.children.length;b++)this.children[b].na(a)};
m.gb=function(a,b){for(var c=this.children.length-1;0<=c;c--){var d=this.children[c].gb(a,b);if(d)return d}return null};function vd(a,b){for(var c=0;c<a.children.length;c++)if(b===a.children[c])return c;return-1}td("GroupNode",ud);function wd(a,b){ld(this,a,b,wd);this.children=[]}wd.prototype={log:t("PAGE",!0),type:function(){return"PageNode"},format:function(){},gb:function(){return null},na:function(){}};td("PageNode",wd,ud);function xd(a,b){ld(this,a,b,xd);this.log("New BrushNode created.");this.ga.points=[];this.ga.strokeStyle="#ff00ff";this.ga.lineWidth=10;this.ta=[];this.ha=[];this.inverse=null}
xd.prototype={log:t("BRUSH",!0),type:function(){return"BrushNode"},setProperty:function(a,b){"fillStyle"===a&&(a="strokeStyle");a in this.ga||"dashes"===a?this.ga[a]=b:kd.prototype.setProperty.call(this,a,b)},qa:function(a){"fillStyle"===a&&(a="strokeStyle");return kd.prototype.qa.call(this,a)},format:function(){var a,b,c,d;this.ta.length=0;b=this.ga.points;a=c=0;for(d=b.length-1;c<=d;a=c+=2)this.ta.push(new y(b[a],b[a+1]));a=dc(this.ta);this.Fb=a.clone();a.Pb(this.ga.lineWidth+3,this.ga.lineWidth+
3);a=new Bc(a);a.transform(this.ga.matrix);this.rect=dc(a.ta);this.inverse=this.ga.matrix.inverse();this.ha=[];if("dashes"in this.ga)for(b=this.ga.dashes.split(","),a=0;a<b.length;a++)c=parseFloat(b[a]),isNaN(c)||this.ha.push(c)},gb:function(a,b){var c;if(this.rect.Ub(a,b)){c=this.inverse.apply(a,b);var d;a:{d=this.ta;var e=c.x;c=c.y;for(var f=this.ga.lineWidth/2,f=f*f,g=1;g<d.length;g++){var h=d[g-1].x,k=d[g-1].y,l=d[g].x-h,n=d[g].y-k,q=((e-h)*l+(c-k)*n)/(l*l+n*n);1<q?q=1:0>q&&(q=0);h=h+q*l-e;k=
k+q*n-c;if(h*h+k*k<=f){d=!0;break a}}d=!1}if(d)return this}return null},oc:function(a){var b,c,d,e;c=this.ga.points;if(0!==c.length){a.save();a.beginPath();a.lineCap="round";a.lineJoin="round";if(1<this.ha.length){if(b=this.ta,d=this.ha,0!==b.length){a.moveTo(b[0].x,b[0].y);e=0;for(var f=1,g=d[0],h=b[0].clone(),k;f<b.length;)k=h.pb(b[f]),0===k?f+=1:k<=g?(h=b[f].clone(),e&1?a.moveTo(h.x,h.y):a.lineTo(h.x,h.y),g-=k,f+=1):(h.x+=(b[f].x-h.x)*g/k,h.y+=(b[f].y-h.y)*g/k,e&1?a.moveTo(h.x,h.y):a.lineTo(h.x,
h.y),e=(e+1)%d.length,g=d[e])}}else for(a.moveTo(c[0],c[1]),b=d=2,e=c.length-1;d<=e;b=d+=2)a.lineTo(c[b],c[b+1]);a.stroke();if(yd){a.beginPath();b=d=0;for(e=c.length-1;d<=e;b=d+=2)a.rect(c[b]-2,c[b+1]-2,4,4);a.fillStyle="#ff0000";a.fill()}a.restore()}}};var yd=!1;td("BrushNode",xd);function zd(a,b,c,d){this.$=c;this.view=a;this.ha=d;this.Pa=!1;this.de=!0;this.aa=[];this.la={};var e=this;e.qd=function(){Ad(e,e.$.lineWidth/2)}}
zd.prototype={log:t("Brush"),Gb:function(){this.view.canvas.style.cursor="crosshair";Ad(this,this.$.lineWidth/2);p(window).on("resize",this.qd)},Jb:function(){this.view.canvas.style.cursor="default";this.view.na();p(window).Ac("resize",this.qd)},reset:function(){this.Pa=!1;this.aa=[];this.la={}},Sc:function(a){this.$.strokeStyle=a},Wa:function(a){var b,c,d,e,f;if("touchstart"===a.type)for(f=a.changedTouches,d=0,e=f.length;d<e;d++)c=f[d],a=x(this.view,c.pageX,c.pageY),this.aa.push([a]),c.identifier&&
(this.la[c.identifier]=this.aa[this.aa.length-1]);else if("touchmove"===a.type){f=a.changedTouches;d=0;for(e=f.length;d<e;d++){c=f[d];a=x(this.view,c.pageX,c.pageY);if(c.identifier)c.identifier in this.la?b=this.la[c.identifier]:(b=[a],this.aa.push(b),this.la[c.identifier]=b);else{c=a;var g=b=void 0,h=void 0;b=null;for(h=0;h<this.aa.length;h++){var k=this.aa[h],l=k[k.length-1].pb(c);if(null===b||l<g)b=k,g=l}}b?a.x===b[b.length-1].x&&a.y===b[b.length-1].y||b.push(a):this.log("WARNING: Can't find path for touch!")}this.view.na()}else"touchend"===
a.type&&0===a.touches.length&&this.ya()},La:function(a,b){var c;c=this.view.Ta(new y(a,b));this.Pa=!0;this.aa.push([c])},he:function(a){var b,c,d,e,f,g,h,k=Bd(this.view);"erase"===this.$.strokeStyle?(a.strokeStyle="#000000",a.globalCompositeOperation="destination-out"):a.strokeStyle=this.$.strokeStyle;a.lineCap="round";a.lineJoin="round";a.lineWidth=this.$.lineWidth;a.beginPath();g=this.aa;d=0;for(f=g.length;d<f;d++)for(c=g[d],a.moveTo(c[0].x,c[0].y),b=e=1,h=c.length-1;e<=h;b=e+=1)b=c[b],a.lineTo(b.x,
b.y);a.stroke();a.globalCompositeOperation="source-over";k&&a.restore()},Na:function(a,b){var c;"freehand"===this.ha?c=new y(a,b):c=this.view.Ta(new y(a,b));this.Pa&&(this.ba=this.aa[0][this.aa[0].length-1],c.x!==this.ba.x||c.y!==this.ba.y)&&(this.aa[0].push(c),this.view.na())},Oa:function(a,b){this.Na(a,b);this.Pa=!1;this.ya()},ya:function(){var a,b,c,d,e,f,g,h,k,l;a=[];k=this.aa;var n=this.view.ka.hb;f=0;for(h=k.length;f<h;f++)if(e=k[f],"brush"===this.ha){if(c=[],1===e.length&&e.push(new y(e[0].x+
.1,e[0].y+.1)),1<e.length){d=b=0;for(g=e.length-1;b<=g;d=b+=1)c.push(e[d].x),c.push(e[d].y);a.push(new D("BrushNode",p.$({points:c,layer:this.view.Ja},this.$)))}}else{if("shapebrush"===this.ha){e=Ac(e,20);c=e;g=l=b=e=l=d=void 0;if(!(3>c.length)){e=c[0];b=c[c.length-1];g=40>e.pb(b);for(d=0;d<c.length;d++){var q=c[d];for(l=d+1;l<c.length;l++){var r=c[l];20>Math.abs(q.x-r.x)?r.x=q.x:20>Math.abs(q.y-r.y)&&(r.y=q.y)}}q=hc(dc(c));for(d=0;d<c.length;d++)l=c[d],20>Math.abs(l.x-q.x)&&(l.x=q.x),20>Math.abs(l.y-
q.y)&&(l.y=q.y);g&&(e.x=b.x,e.y=b.y)}e=c}else if("freehand"===this.ha)c=e,c=Ac(c,2),c=Cc(c,4),e=c=Ac(c,.5);else if("quadratic"===this.ha){e=Ac(e,10);b=Nc(e);c=b.ea[1];d=b.ea[2];l=b.ea[4];g=b.ea[5];e=b.ea[8];b=b.ea[9];l=((3*l-c)/2+(3*l-e)/2)/2;g=((3*g-d)/2+(3*g-b)/2)/2;q=new uc;q.moveTo(c,d);q.quadraticCurveTo(l,g,e,b);e=q;c=new N;d=0;for(e=e.ea;d<e.length;){switch(e[d]){case Lb:c.moveTo(e[d+1],e[d+2]);break;case Mb:c.lineTo(e[d+1],e[d+2]);break;case 2:c.aa(e[d+1],e[d+2],e[d+3],e[d+4],e[d+5],e[d+6]);
break;case 3:c.ba(e[d+1],e[d+2],e[d+3],e[d+4]);break;case Ob:c.close()}d+=Pb[e[d]]}c=c.ea;a.push(new D("PathNode",p.$({commands:c,fillStyle:this.view.Xa,sloppiness:0,layer:this.view.Ja},this.$)));continue}1===e.length&&"freehand"===this.ha&&e.push(new y(e[0].x+.1,e[0].y+.1));if(1<e.length){c=new N;c.moveTo(e[0].x,e[0].y);b=e[0].Wb(e[e.length-1]);d=g=1;for(l=e.length-1;g<=l;d=g+=1)c.lineTo(e[d].x,e[d].y);b&&c.close();a.push(new D("PathNode",p.$({commands:c.Eb(),fillStyle:this.view.Xa,sloppiness:0,
layer:this.view.Ja},this.$)))}}this.view.ya(a);this.view.Za();f=A(this.view.ka,n);a.length&&"quadratic"===this.ha?(this.view.Ca=f,G(this.view)):this.view.fa.get("singleStrokeBrush")?(Cd(this.view,f),G(this.view)):this.reset();P(this.view)},Bb:function(a){this.$.strokeStyle=a.Sa;var b;a.$c?(this.view.Xa=a.Sa,this.view.ib=a.Sa,b="fillStyle"):(this.view.bb=a.Sa,b="strokeStyle");this.view.setProperty(b,a.Sa)},Qb:function(a){this.view.ib=Rc(this.view.ib,a);this.$.strokeStyle=Rc(this.$.strokeStyle,a);this.view.Xa=
this.view.ib},ub:function(a){this.log("keyboard: %s",a);"cancel"===a&&(this.log("ESC pressed. Abort brush and go back to toolbar."),G(this.view),this.view.qb.emit("goto-toolbar"))},Nb:function(){return"circle"===this.ha?"ellipse":this.ha}};
function Ad(a,b){var c=document.createElement("canvas");b*=window.devicePixelRatio||1;var d=Math.ceil(b+1);c.width=2*d+2;c.height=2*d+2;var e=c.getContext("2d");e.beginPath();e.arc(d+1,d+1,d,0,2*Math.PI);e.lineWidth=2;e.strokeStyle="#ffffff";e.stroke();e.lineWidth=1;e.strokeStyle="#000000";e.stroke();c=c.toDataURL();a.view.canvas.style.cursor="url("+c+") "+(d+1)+" "+(d+1)+", auto"};function Dd(a,b){ld(this,a,b,Dd);this.$=null}
Dd.prototype={log:t("CUSTOM"),type:function(){return"CustomNode"},setProperty:function(a,b){var c;null===this.$&&"type"===a&&(c=Ed[b],this.$=new c);this.$&&this.$.setProperty?this.$.setProperty(a,b):kd.prototype.setProperty.call(this,a,b)},qa:function(a){return this.$&&this.$.setProperty?this.$.getProperty(a):kd.prototype.qa.call(this,a)},format:function(a){"format"in this.$?this.$.format(a):alert("Error: custom item must have a format(ctx) function");a=this.$.rect;this.rect=new L(a.x,a.y,a.width,
a.height)},na:function(a){this.$.draw(a)}};td("CustomNode",Dd);function Fd(a,b){ld(this,a,b,Fd);this.ga.data="";this.ga.locked=!1;this.element=null;this.ha=void 0;this.ba=null;this.$=new M;this.la=!1}
Fd.prototype={log:t("DomNode",!0),type:function(){return"DomNode"},setProperty:function(a,b){if("data"===a)this.element&&(p(this.element).remove(),this.ha=this.element=null);else if("border"===a||"lockSize"===a||"lockRotate"===a){this.ga[a]=b;return}kd.prototype.setProperty.call(this,a,b)},me:function(a){this.log("Node %s receives DOM element and requests reformat",this.id);this.element=a;this.element.style.position="absolute";"IFRAME"!==a.tagName&&(this.element.style.pointerEvents="none");this.yc(this.la);
this.width=this.element.offsetWidth;this.height=this.element.offsetHeight;this.element.style.top="0px";this.element.style.left="0px";Gd(this,"transformOrigin","top left");this.aa.emit("reformat",this)},Tc:function(a){kd.prototype.Tc.call(this,a);this.element&&(this.element.style.visibility=this.oa?"hidden":"visible")},yc:function(a){this.la=a;this.element&&this.aa&&(a?Pa(p(this.element),p(this.aa.canvas)):ba(p(this.element),p(this.aa.canvas)))},format:function(a,b){null===this.element&&this.ha!==
this.qa("data")&&b&&(this.ha=this.qa("data"),this.aa=b,this.log("DomNode %s requests conversion to DOM element",this.id),this.aa.emit("convert-dom-request",this.ha,this.id));if(this.element){var c=this.$,c=c.multiply(this.Ua());1===c.m11&&1===c.m22&&0===c.m12&&0===c.m21?(Gd(this,"transform",""),this.element.style.left=""+c.Aa+"px",this.element.style.top=""+c.Ba+"px"):(this.element.style.left="0px",this.element.style.top="0px",Gd(this,"transform","matrix("+c.m11+","+c.m21+","+c.m12+","+c.m22+","+c.Aa+
","+c.Ba+")"));this.rect.x=0;this.rect.y=0;this.rect.width=this.width;this.rect.height=this.height;this.element.style.visibility=this.oa?"hidden":"visible"}else this.rect.x=0,this.rect.y=0,this.rect.width=100,this.rect.height=22;this.ba=new Bc(this.rect);this.Fb=this.rect.clone();this.rect.transform(this.Ua());this.ba.transform(this.Ua());if(c=this.ga.border)this.rect.Pb(c),this.sa=this.ba.clone(),this.sa.Pb(c/2),this.ba.Pb(c)},oc:function(a){!a.ac||a.ac.m11===this.$.m11&&a.ac.m21===this.$.m21&&a.ac.m12===
this.$.m12&&a.ac.m22===this.$.m22&&a.ac.Aa===this.$.Aa&&a.ac.Ba===this.$.Ba||(this.log("Moving DOM element as result of draw zooming"),this.$=a.ac,this.format(a,null));if(this.element){var b=this.ga.border;if(b){var c=this.sa;a.setTransform(1,0,0,1,0,0);a.beginPath();a.lineWidth=b;a.strokeStyle="#cccccc";a.moveTo(c.ta[0].x,c.ta[0].y);a.lineTo(c.ta[1].x,c.ta[1].y);a.lineTo(c.ta[2].x,c.ta[2].y);a.lineTo(c.ta[3].x,c.ta[3].y);a.lineTo(c.ta[0].x,c.ta[0].y);a.closePath();a.stroke()}}else a.beginPath(),
a.lineWidth=1,a.fillStyle="#888888",a.strokeStyle="#CCCCCC",a.rect(0,0,100,22),a.stroke(),a.font="20px Arial",a.textBaseline="top",a.fillText("DomNode",0,0)},gb:function(a,b){return!this.ga.locked&&this.rect.Ub(a,b)&&this.ba.Ub(a,b,3)?this:null},ge:function(){this.element&&ba(p(this.element),p(this.aa.canvas))},ie:function(){this.log("Removed DOM NODE");this.element&&p(this.element).remove()}};
function Gd(a,b,c){for(var d=b.charAt(0).toUpperCase()+b.substr(1),e=["ms","Webkit","O","Moz"],f=0;f<e.length;f++)a.element.style[e[f]+d]=c;a.element.style[b]=c}td("DomNode",Fd);function Hd(a,b){ld(this,a,b,Hd);this.ga.url="";this.Qa=null;this.width=100;this.height=20;this.ha=new Bc;this.ba=[];this.aa=new L(0,0,this.width,this.height);this.$=new L(0,0,this.width,this.height)}
Hd.prototype={log:t("IMAGE",!0),type:function(){return"ImageNode"},setProperty:function(a,b){kd.prototype.setProperty.call(this,a,b);if("url"===a)this.Qa=null;else if("allowCrop"===a||"crop"===a||"blendMode"===a)this.ga[a]=b},format:function(a,b){function c(a,b,c){l.ba.push({x:l.$.x+a*l.$.width,y:l.$.y+b*l.$.height,Ob:c})}var d,e,f,g,h,k=this;null===this.Qa&&"ImageSurface"in window?(this.Qa=new ImageSurface(this.ga.url),this.aa=new L(0,0,this.Qa.width,this.Qa.height)):null===this.Qa?(this.aa=new L(0,
0,this.width,this.height),b.add(this,"image",this.ga.url,null,function(a){k.log("Got image response.");k.Qa=a;return b.emit("reformat",k)})):this.aa=new L(0,0,this.Qa.width,this.Qa.height);this.$=Id(this);this.rect=this.$.clone();if(d=this.qa("boundingPolygon")){f=[];e=g=0;for(h=d.length-1;g<=h;e=g+=2)f.push(new y(d[e],d[e+1]));this.ha=new Bc(f)}else this.ha=new Bc(this.rect);this.Fb=this.rect.clone();this.ha.transform(this.ga.matrix);this.rect.transform(this.ga.matrix);this.ba.length=0;var l=this;
c(.5,0,!0);c(1,.5,!1);c(.5,1,!0);c(0,.5,!1)},Yd:function(){return this.ha},gb:function(a,b){return!this.ga.locked&&this.ha.Ub(a,b,3)?this:null},oc:function(a){var b,c,d,e,f=!1;if(this.Qa)try{var g=a.globalCompositeOperation,h=this.qa("blendMode");h&&(a.globalCompositeOperation=""+h,this.log("Using globalCompsiteOperation=%s (requested %s)",a.globalCompositeOperation,h));a.drawImage(this.Qa,this.$.x,this.$.y,this.$.width,this.$.height,this.$.x,this.$.y,this.$.width,this.$.height);a.globalCompositeOperation=
g;if(Jd){c=this.ha.ta;a.save();a.setTransform(1,0,0,1,0,0);a.beginPath();a.lineWidth=2;a.strokeStyle="#000000";a.moveTo(c[0].x,c[0].y);b=d=1;for(e=c.length-1;d<=e;b=d+=1)a.lineTo(c[b].x,c[b].y);a.closePath();a.stroke();a.restore()}}catch(k){this.log("Error drawing image: %s",k.message),f=k}if(null===this.Qa||f)a.save(),a.lineWidth=1,a.strokeStyle="#cccccc",a.strokeRect(0,0,this.width,this.height),a.restore()},md:function(){return!1!==this.qa("allowCrop")&&!0!==this.qa("lockEditMode")},Fd:function(a,
b){a.save();a.beginPath();a.lineWidth=1*b;a.strokeStyle="#0050B7";a.globalCompositeOperation="xor";for(var c=this.Ua(),d=0;d<this.ba.length;d++){var e=this.ba[d],f=c.apply(e.x,e.y),g,h,k,l;e.Ob?(g=20,k=h=0,l=3,e=f.x-10,f=f.y-6):(g=0,h=20,k=3,l=0,e=f.x-6,f=f.y-10);for(var n=0;5>n;n++)a.moveTo(e,f),a.lineTo(e+g*b,f+h*b),e+=k*b,f+=l*b}a.stroke();a.restore()},Id:function(a,b,c){var d=this.Ua();c=10*c;for(var e=0;e<this.ba.length;e++){var f=this.ba[e],f=d.apply(f.x,f.y);if(f.x-c<=a&&a<f.x+c&&f.y-c<=b&&
b<f.y+c)return e}return null},Zd:function(a){a=this.ba[a];return this.Ua().apply(a.x,a.y)},Gc:function(a,b,c){var d=Id(this);b=Kc(this).apply(b,c);0===a&&0<=b.y?(d.height-=b.y-d.y,d.y=b.y):1===a&&b.x<this.aa.width?d.width=b.x-d.x:2===a&&b.y<this.aa.height?d.height=b.y-d.y:3===a&&0<=b.x&&(d.width-=b.x-d.x,d.x=b.x);d.x=Math.max(d.x,0);d.y=Math.max(d.y,0);d.width=Math.min(d.width,this.aa.width);d.height=Math.min(d.height,this.aa.height);d.width=Math.max(1,d.width);d.height=Math.max(1,d.height);this.ga.crop=
[d.x,d.y,d.width,d.height].join()}};function Id(a){var b=a.ga.crop;a=new L(0,0,a.aa.width,a.aa.height);b&&(b=b.split(","),a.x=parseFloat(b[0])|0,a.y=parseFloat(b[1])|0,a.width=parseFloat(b[2])|0,a.height=parseFloat(b[3])|0);return a}var Jd=!1;td("ImageNode",Hd);function Kd(a,b){ld(this,a,b,Kd);this.aa="UnknownNode";this.width=100;this.height=20;this.$=new id;jd(this.$,"centre","middle")}
Kd.prototype={log:t("UNKNOWN",!0),type:function(){return this.aa},setProperty:function(a,b){this.ga[a]=b},format:function(a){this.log("Formatting placeholder for %s",this.aa);this.rect=new L(0,0,this.width,this.height);this.rect.transform(this.ga.matrix);this.$.format(a,this.width,this.height)},oc:function(a){this.log("Drawing placeholder for for %s",this.aa);a.save();a.lineWidth=1;a.fillStyle="#888888";a.fillRect(0,0,this.width,this.height);a.fillStyle="#000000";this.$.na(a,0,0);a.restore()}};
td("UnknownNode",Kd);function Ld(a,b){ld(this,a,b,Ld);rd(this,Md);this.ga.text="lorum ipsum dolor";this.$=new id;this.ae=0}
Ld.prototype={log:t("TEXT",!0),type:function(){return"TextNode"},setProperty:function(a,b){this.log("setProperty %s=%s",a,b);this.ga[a]=b;if("fontName"===a||"text"===a)this.path=null;"textFillStyle"===a?this.ga.fillStyle=b:"fillStyle"===a&&(this.ga.textFillStyle=b)},format:function(a){var b,c=this.$;b=this.ga.fontSize;var d=this.ga.bold,e=this.ga.italic;c.la=this.ga.fontName;c.fontSize=b;c.ha=d;c.oa=e;c=this.ga.text;c.length&&10===c.charCodeAt(c.length-1)&&(this.log("Lastchar=%s; remove trailing newline",
c.charCodeAt(c.length-1)),c=c.substr(0,c.length-1));this.$.text=c;b=this.ga.matrix;c=b.apply(0,0);b=b.apply(1,0);c=c.pb(b);b=this.qa("wrap");d=!1!==this.qa("scaleFont");jd(this.$,this.ga.textAlign,"top");b?(b=this.ga.baseWidth,void 0===b&&(this.$.format(a,0,0),b=Math.max(this.$.rect.width,10),500<b&&(b=500),this.ga.baseWidth=b,this.log("Formatting text for first time; baseWidth=%s",b)),c=Math.ceil(c*b),this.$.format(a,c,0),a=this.$.rect.height,this.Fb=new L(0,0,b,a)):d?(this.$.format(a,0,0),c=this.$.rect.width,
a=this.$.rect.height,this.Fb=new L(0,-(0+this.qa("fontSize")),c,a)):(this.$.format(a,0,0),c=this.$.rect.width,a=this.$.rect.height,this.Fb=new L(0,0,c,a));a=new Bc(this.Fb);a.transform(this.Ua());this.rect=dc(a.ta);this.ae=this.rect.height;this.rect.height+=1.3*this.ga.fontSize;a=this.qa("lineWidth")+0;this.rect.Pb(a,a)},Ua:function(){return!1===this.qa("scaleFont")?kc(kd.prototype.Ua.call(this)):kd.prototype.Ua.call(this)},na:function(a){if(0!==this.ga.text.length){a.save();this.qa("wrap")?lc(kc(this.Ua()),
a):lc(this.Ua(),a);a.strokeStyle=this.ga.strokeStyle;a.fillStyle=this.ga.fillStyle;a.lineWidth=this.ga.lineWidth;var b=0;this.ga.wrap||!1===this.qa("scaleFont")||(b=-(0+this.qa("fontSize")));this.ga.shadow&&(a.shadowOffsetX=3,a.shadowOffsetY=3,a.shadowBlur=5,a.shadowColor="rgba(0,0,0,0.5)");0<this.ga.lineWidth&&this.$.strokeText(a,0,b);this.$.fillText(a,0,b);a.restore()}}};Ld.prototype=p.$({},kd.prototype,Ld.prototype);
var Md={textFillStyle:"#000000",fontName:"Arial",fontSize:20,lineWidth:0,fillStyle:"#000000",wrap:!1,textAlign:"left",bold:!1,italic:!1};td("TextNode",Ld);function Nd(a,b){ld(this,a,b,Nd);rd(this,Od);this.ga.closed=!1;this.ga.commands=[];this.$=[];this.sa=0;this.ga.seed=0;this.aa=new Ld(0,b);this.aa.setProperty("text",this.ga.text);this.la=[];this.Ka=!1}
var Od={strokeStyle:"#000000",fillStyle:"#ffffff",textFillStyle:"#000000",fontName:"Arial",fontSize:20,lineWidth:2,dashes:"",shapeWidth:0,smoothness:.3,sloppiness:0,shadow:!1,closed:!1,arrowSize:0,arrowXOffset:null,arrowStyle:"simple",doubleArrow:!1,text:"",roundRadius:0,wrap:!1,angleArcs:0},Q=[2,2,4,5,6,2,4,0,6];m=Nd.prototype;m.log=t("PATHNODE");m.moveTo=function(a,b){var c=this.ga.commands;c.push(0);c.push(a);c.push(b)};m.type=function(){return"PathNode"};m.Hd=function(){return!0===this.ga.closed};
m.setProperty=function(a,b){kd.prototype.setProperty.apply(this,arguments);"fontName"===a||"fontSize"===a||"text"===a||"wrap"===a?this.aa.setProperty(a,b):"textFillStyle"===a?this.aa.setProperty("fillStyle",b):"spotHighlight"===a&&(this.ga.spotHighlight=!0)};m.Zd=function(a){for(var b=0,c=this.ga.commands,d=a/3|0,e=0;e<d|0;e++)b+=Q[c[b]]+1;e=a%3*2+1;d=c[b+e];b=c[b+e+1];this.log("getEditHandle(%s) = (%s, %s)",a,d,b);return this.Ua().apply(d,b)};
m.Gc=function(a,b,c){for(var d=0,e=this.ga.commands,f=a/3|0,g=0;g<f;g++)d+=Q[e[d]]+1;f=this.ga.inverse.apply(b,c);g=a%3*2+1;e[d+g]=f.x;e[d+g+1]=f.y;if(0===a&&this.ga.closed){for(a=null;d<e.length;)f=Q[e[d]],2<=f&&(a=d),d+=f+1;a&&(d=a,f=this.ga.inverse.apply(b,c),e[d+1]=f.x,e[d+2]=f.y)}};
m.format=function(a,b){this.origin=null;this.$.length=0;for(var c=new y(0,0),d=this.ga.commands,e=null,f,g,h=this.ga.matrix,k=new ia(this.ga.seed),l=0;l<d.length;){switch(d[l++]){case 0:c=h.apply(d[l++],d[l++]);this.$.push(new Ab(0,c));null===this.origin&&(this.origin=c);break;case 1:c=h.apply(d[l++],d[l++]);this.$.push(new Bb(e,c,k,this.ga.sloppiness,this.ga.roundRadius));break;case 2:c=h.apply(d[l++],d[l++]);e=h.apply(d[l++],d[l++]);this.$.push(new Eb(0,e,c));break;case 3:c=h.apply(d[l++],d[l++]);
e=h.apply(d[l++],d[l++]);f=d[l++];this.$.push(new Fb(0,e,c,f));break;case 4:c=h.apply(d[l++],d[l++]);f=h.apply(d[l++],d[l++]);g=h.apply(d[l++],d[l++]);this.$.push(new Gb(e,f,g,c));break;case 8:c=h.apply(d[l++],d[l++]);f=h.apply(d[l++],d[l++]);g=h.apply(d[l++],d[l++]);this.$.push(new Hb(e,f,g,c));break;case 5:c=h.apply(d[l++],d[l++]);this.$.push(new Db(e,c,this.ga.smoothness));break;case 6:c=h.apply(d[l++],d[l++]);f=h.apply(d[l++],d[l++]);this.$.push(new Ib(e,f,c,k,this.ga.sloppiness));break;case 7:this.ga.closed=
!0;break;default:l++}e=this.$[this.$.length-1]}this.ga.closed&&3<=this.$.length&&this.$[1].Uc&&(this.$[1].Uc(e),e.ja=this.origin);this.sa=this.$.length;Pd(this,k);this.rect.x=this.origin.x;this.rect.y=this.origin.y;this.rect.width=0;this.rect.height=0;c=this.ga.dashes.split(",");this.ha=[];for(l=0;l<c.length;l++)d=parseFloat(c[l]),isNaN(d)||this.ha.push(d);l=this.ha.length?2:8;c=new uc;for(d=0;d<this.$.length;d++)this.$[d].na(c);this.ga.closed&&c.close();f=e=d=0;for(h=new uc;d<c.ea.length;){switch(c.ea[d]){case Lb:e=
c.ea[d+1];f=c.ea[d+2];h.moveTo(e,f);break;case Mb:e=c.ea[d+1];f=c.ea[d+2];h.lineTo(e,f);break;case 2:g=k=[];var n=c.ea[d+5],q=c.ea[d+6];qc(g,e,f,c.ea[d+1],c.ea[d+2],c.ea[d+3],c.ea[d+4],n,q,l*l);g.push(new y(n,q));2===k.length&&1E-4>e*(k[0].y-k[1].y)+k[0].x*(k[1].y-f)+k[1].x*(f-k[0].y)&&(k[0]=k[1],k.length=1);for(e=0;e<k.length;e++)h.lineTo(k[e].x,k[e].y);e=c.ea[d+5];f=c.ea[d+6];break;case 3:g=k=[];n=c.ea[d+3];q=c.ea[d+4];sc(g,e,f,c.ea[d+1],c.ea[d+2],n,q,l*l);g.push(new y(n,q));for(e=0;e<k.length;e++)h.lineTo(k[e].x,
k[e].y);e=c.ea[d+3];f=c.ea[d+4];break;case Ob:h.close()}d+=Pb[c.ea[d]]}this.ba=h;c=0+this.qa("shapeWidth");if(0<c){h=this.ba;this.log("ConvertToRects: width=%s",c);var d=0,h=h.ea,r,u;for(f=new uc;d<h.length;){this.log("cmd %s %s %s",h[d],h[d+1],h[d+2]);switch(h[d]){case Lb:r=h[d+1];u=h[d+2];break;case Mb:k=h[d+1],e=h[d+2],this.log("(%s,%s-%s,%s)",r,u,k,e),0<Cb(r,u,k,e)&&(n=K(r,u,k,e),g=n.y*c/2,n=-n.x*c/2,f.moveTo(r+g,u+n),f.lineTo(k+g,e+n),f.lineTo(k-g,e-n),f.lineTo(r-g,u-n),f.close()),r=k,u=e}d+=
Pb[h[d]]}this.ba=f}this.rect=xc(this.ba,l);r=this.rect.width-2*(this.ga.lineWidth/2+1);u=this.ga.lineWidth;l=this.ba.clone();l.transform(Kc(this));this.Fb=xc(l,3);this.Fb.Pb(2*u+1,2*u+1);this.rect.Pb(2*u+1,2*u+1);8>this.rect.width&&(this.rect.x+=this.rect.width/2-4,this.rect.width=8);8>this.rect.height&&(this.rect.y+=this.rect.height/2-4,this.rect.height=8);this.ga.closed&&(u=hc(this.rect),this.aa.setProperty("textAlign","centre"),this.aa.setProperty("baseWidth",r),this.aa.format(a,b),r=u.x-this.aa.rect.x-
this.aa.rect.width/2,u=u.y-this.aa.rect.y-this.aa.ae/2,this.aa.transform(new E(r,u),new E(-r,-u)),this.aa.format(a,b));this.Ka=0===Qd(this.ga.fillStyle).values[3];this.la.length=0;0<this.ga.angleArcs&&(this.la.push(new Jb(this)),this.la[this.la.length-1].Xb=this.ga.angleArcs);for(l=0;l<this.la.length;l++)this.la[l].format(a)};m.kd=function(){return this.ba};
function Pd(a,b){function c(a,c){var h,q,r,u;h=a.x-c.x*f;q=a.y-c.y*f;r=h+c.y*e/2;u=q-c.x*e/2;h+=-c.y*e/2;q+=c.x*e/2;d.$.push(new Ab(0,new y(h,q)));d.$.push(new Db(d.$[d.$.length-1],a,g));d.$.push(new Db(d.$[d.$.length-1],new y(r,u),g));"solid"===d.ga.arrowStyle&&d.$.push(new Bb(d.$[d.$.length-1],new y(h,q),b,d.ga.smoothness,0))}a.Ra=0<a.ga.arrowSize&&!a.ga.closed&&0<a.$.length;if(a.Ra){var d=a,e=a.ga.arrowSize,f=a.ga.arrowXOffset,g=a.ga.smoothness;null===f&&(f=e);var h=a.$[a.$.length-1];c(h.ja,h.Lb());
a.ga.doubleArrow&&c(a.$[0].ja,cc(a.$[1].nc()))}}m.close=function(){this.ga.commands.push(7)};m.clip=function(a){if(this.ga.closed){this.log("Clipping to a path");for(var b=0;b<this.$.length;b++)this.$[b].na(a);a.closePath()}};
m.oc=function(a){if(!this.ga.spotHighlight){var b=this.ga.inverse;a.save();a.lineJoin="round";a.transform(b.m11,b.m21,b.m12,b.m22,b.Aa,b.Ba);a.beginPath();a.lineCap="round";for(b=0;b<this.$.length;b++)this.$[b].na(a);this.ga.closed&&(a.closePath(),a.fill(),a.shadowColor="rgba(0,0,0,0.0)");this.ha.length&&0<this.ga.lineWidth?(a.beginPath(),wc(this.ba,a,this.ha),a.lineCap="butt"):0<0+this.qa("shapeWidth")&&(a.beginPath(),this.ba.na(a));0<this.ga.lineWidth&&a.stroke();if(this.ga.arrowSize&&"solid"===
this.ga.arrowStyle){a.beginPath();for(b=this.sa;b<this.$.length;b++)this.$[b].na(a);a.fillStyle=this.ga.strokeStyle;a.fill()}this.ga.closed&&this.aa.na(a);for(b=0;b<this.la.length;b++)this.la[b].na(a);a.restore()}};
m.gb=function(a,b){if(this.oa||this.qa("locked"))return null;var c=12+this.ga.shapeWidth/2+this.ga.lineWidth/2;if(a>=this.rect.x-c&&a<this.rect.x+c+this.rect.width&&b>=this.rect.y-c&&b<this.rect.y+c+this.rect.height)if(this.ga.closed&&!this.Ka){if(tc(yc(this.ba),a,b))return this}else{a:{for(var d=this.ba,e=0,f=0,g=0,h,k,l,n,q;g<d.ea.length;){switch(d.ea[g]){case Lb:e=d.ea[g+1];f=d.ea[g+2];break;case Mb:h=d.ea[g+1];k=d.ea[g+2];n=h-e;l=k-f;q=n*n+l*l;q=((a-e)*n+(b-f)*l)/q;1<q?q=1:0>q&&(q=0);e+=q*n;l=
f+q*l;f=e-a;l=l-b;f=f*f+l*l;if(f<=c){c=!0;break a}e=h;f=k}g+=Pb[d.ea[g]]}c=!1}if(c)return this}return null};m.lineTo=function(a,b){var c=this.ga.commands;c.push(1);c.push(a);c.push(b)};m.fd=function(a,b){var c=this.ga.commands;c.push(5);c.push(a);c.push(b)};m.md=function(){return!1!==this.ga.editable&&!0!==this.ga.lockEditMode};
m.Id=function(a,b,c){c=8*c;if(a>=this.origin.x-c&&a<this.origin.x+c&&b>=this.origin.y-c&&b<this.origin.y+c)return 0;for(var d=0;d<this.sa;d++){var e=this.$[d];if(e.control){if(a>=e.control.x-c&&a<e.control.x+c&&b>=e.control.y-c&&b<e.control.y+c)return 3*d+1}else if(e.Fa){if(a>=e.Fa.x-c&&a<e.Fa.x+c&&b>=e.Fa.y-c&&b<e.Fa.y+c)return 3*d+1;if(a>=e.Ia.x-c&&a<e.Ia.x+c&&b>=e.Ia.y-c&&b<e.Ia.y+c)return 3*d+2}if(a>=this.$[d].ja.x-c&&a<this.$[d].ja.x+c&&b>=this.$[d].ja.y-c&&b<this.$[d].ja.y+c)return 3*d}return null};
m.Gd=function(a){var b=this.ga.commands;a=a/3;var c=0,d=!1,e=0,f,g;for(f=0;f<b.length;){g=b[f];if(7===g){d=!0;break}e+=1;f+=Q[b[f]]+1}0===a&&d&&(a=e-1);for(f=0;f<b.length;c++){var h;switch(b[f]){case 0:h="move_to";break;case 1:h="line_to";break;case 2:h="quadratic_to"}if(a===c)return h;f+=Q[b[f]]+1}return null};m.ce=function(){return!0};
m.Fd=function(a,b,c){a.save();a.lineWidth=1*b;a.strokeStyle="#0050B7";a.fillStyle="#0050B7";b=8*b;0===c?a.fillRect(this.origin.x-b,this.origin.y-b,2*b,2*b):a.strokeRect(this.origin.x-b,this.origin.y-b,2*b,2*b);var d=this.$.length;this.ga.closed&&--d;for(d=1;d<this.sa;d++){var e=this.$[d];a.beginPath();if(e.control)a.arc(this.$[d].control.x,this.$[d].control.y,b,0,2*Math.PI),a.arc(this.$[d].control.x,this.$[d].control.y,2*b,0,2*Math.PI),c===3*d+1?a.fill():a.stroke();else if(e instanceof Gb||e instanceof
Hb){var f,g,h;f=e.Fa;g=e.Ia;h=e instanceof Gb?e.wa.ja:e.ja;f&&(a.moveTo(h.x,h.y),a.lineTo(f.x,f.y),a.moveTo(f.x+b,f.y),a.arc(f.x,f.y,b,0,2*Math.PI),c===3*d+1?a.fill():a.stroke());a.beginPath();a.moveTo(e.ja.x,e.ja.y);a.lineTo(g.x,g.y);a.moveTo(g.x+b,g.y);a.arc(g.x,g.y,b,0,2*Math.PI);c===3*d+2?a.fill():a.stroke()}c===3*d?a.fillRect(this.$[d].ja.x-b,this.$[d].ja.y-b,2*b,2*b):a.strokeRect(this.$[d].ja.x-b,this.$[d].ja.y-b,2*b,2*b)}a.restore()};function N(a){void 0===a?this.ea=[]:this.ea=a}
N.prototype={ha:function(a,b,c){for(var d=0,e=0;e<a;e++)d+=Q[this.ea[d]]+1;this.ea[d+1]=b;this.ea[d+2]=c},moveTo:function(a,b){this.ea.push(0);this.ea.push(a);this.ea.push(b)},lineTo:function(a,b){this.ea.push(1);this.ea.push(a);this.ea.push(b)},fd:function(a,b){this.ea.push(5);this.ea.push(a);this.ea.push(b)},ba:function(a,b,c,d){this.ea.push(2);this.ea.push(c);this.ea.push(d);this.ea.push(a);this.ea.push(b)},$:function(a,b,c,d){this.ea.push(6);this.ea.push(c);this.ea.push(d);this.ea.push(a);this.ea.push(b)},
aa:function(a,b,c,d,e,f){this.ea.push(4);this.ea.push(e);this.ea.push(f);this.ea.push(a);this.ea.push(b);this.ea.push(c);this.ea.push(d)},arcTo:function(a,b,c,d,e){this.ea.push(3);this.ea.push(c);this.ea.push(d);this.ea.push(a);this.ea.push(b);this.ea.push(e)},la:function(){for(var a=[],b=0;b<this.ea.length;){for(var c=this.ea[b],d=0;d<Q[c];d+=2)a.push(new y(this.ea[b+1+d],this.ea[b+1+d+1]));b+=Q[c]+1}a=dc(a);return{x:a.x,y:a.y,width:a.width,height:a.height}},translate:function(a,b){for(var c=0;c<
this.ea.length;){for(var d=this.ea[c],e=0;e<Q[d];e+=2)this.ea[c+1+e]+=a,this.ea[c+2+e]+=b;c+=Q[d]+1}},close:function(){this.ea.push(7)},Eb:function(){return this.ea}};function Rd(){var a=new y(0,0),b=new N;b.moveTo(a.x,a.y-50);b.$(a.x+50,a.y-50,a.x+50,a.y);b.$(a.x+50,a.y+50,a.x,a.y+50);b.$(a.x-50,a.y+50,a.x-50,a.y);b.$(a.x-50,a.y-50,a.x,a.y-50);b.close();return b.Eb()}td("PathNode",Nd);function Sd(a,b,c,d,e){this.view=a;this.node=null;this.type=b;this.url=c||"";this.ga=d||{};this.ba=e;"wrap"in this.ga||(this.ga.wrap=this.view.fa.get("multilineText"));"fontSize"in this.ga||(this.ga.fontSize=this.view.fa.get("defaultFontSize"))}
Sd.prototype={Gb:function(){this.log("Entering DrawLinesBehaviour");this.view.canvas.style.cursor="crosshair";this.view.fa.Kb()||Td(this.view,"click-to-place-first-point-of-line");this.view.na();this.$=new y(0,0);this.aa=new y(0,0);this.node=null;this.state="start"},log:t("DRAWLINES"),reset:function(){this.Gb()},Wa:function(a){var b;"touchstart"===a.type?(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.La(b.x,b.y,a)):"touchmove"===a.type?(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),
this.Na(b.x,b.y,a)):"touchend"===a.type&&(b=a.changedTouches[0],b=x(this.view,b.pageX,b.pageY),this.Oa(b.x,b.y,a))},ub:function(a){"cancel"===a&&(null!==this.node&&this.view.Kf&&"curve"===this.type&&this.ya(),null!==this.node&&this.view.ka.removeNode(this.node),this.view.Ea.fb?this.view.qb.emit("goto-toolbar"):G(this.view))},done:function(){this.view.fa.get("autoPickTool")?G(this.view):this.state="start"},La:function(a,b){var c=this.view.Ta(new y(a,b));if("start"===this.state)if(this.$=new y(a,b),
"stampline"===this.type)this.node=Sc("StampLineNode",Ud(this.view.ka),this.view.ka),this.node.setProperty("x1",c.x),this.node.setProperty("y1",c.y),this.node.setProperty("x2",c.x),this.node.setProperty("y2",c.y),this.node.setProperty("url",this.url),Uc(this.view.ka,this.node),Td(this.view,"click-to-set-the-end-of-the-line"),this.view.update(),this.index=3;else{this.node=new Nd(Ud(this.view.ka),this.view.ka);this.node.setProperty("seed",Math.round(65535*Math.random()));this.node.setProperty("strokeStyle",
this.view.bb);this.node.setProperty("lineWidth",this.view.va.lineWidth);this.node.setProperty("sloppiness",this.view.va.sloppiness);this.node.setProperty("smoothness",this.view.va.smoothness);for(var d in this.ga)this.ga.hasOwnProperty(d)&&this.node.setProperty(d,this.ga[d]);Uc(this.view.ka,this.node);"arrow"===this.type&&(this.node.setProperty("arrowSize",this.view.fa.ra.defaultArrowSize),this.node.setProperty("arrowStyle",this.view.fa.ra.defaultArrowStyle));this.node.moveTo(c.x,c.y);Vd(this,c.x,
c.y);this.index=3;this.view.update();this.state="predrag"}else if("placing"===this.state)if("arrow"!==this.type&&8>this.$.pb(new y(a,b))&&3<this.index)this.log("Clicked close to start; automatically closing path"),this.node.close(),this.ya(),this.done();else if(8>this.aa.pb(new y(a,b))){if(3<this.index){for(var c=this.node.ga.commands,e=d=0;e<this.index/3;e++)d+=Q[c[d]]+1;c.splice(d,Q[c[d]]+1);this.ya()}else this.cancel();this.done()}else{if(this.ba){this.ya();this.done();return}Vd(this,c.x,c.y);
this.index+=3;Qc(this.view.ka,this.node.id);this.view.update()}else throw"Invalid state";this.aa=new y(a,b)},Oa:function(a,b){var c=this.$.pb(new y(a,b));this.log("onMouseUp (%s,%s) %s",a,b,this.state);"predrag"===this.state&&(this.log("MovedBy: %s",c),10<c?(this.ya(),this.done()):(this.state="placing",Td(this.view,"click-to-place-another-point-or-double-click-to-end-the-line")))},Na:function(a,b){var c=this.view.Ta(new y(a,b));a=c.x;b=c.y;this.node&&(this.node.Gc(this.index,a,b),this.node.format(this.view.ma,
this.view.request),this.view.na())},ya:function(){var a=this.node,b=a.$[a.$.length-1];8>=Cb(b.ja.x,b.ja.y,a.origin.x,a.origin.y)&&a.close();this.view.ka.removeNode(this.node);a=this.view.fa.ra.defaultArrowSize;b=this.node.qa("commands");if("linear-bezier"===this.type){for(var c=0,d=[],e,f,g,h,k,l;c<b.length;){var n=b[c];switch(n){case 0:g=b[c+1];h=b[c+2];d.push(n,g,h);break;case 1:e=b[c+1],f=b[c+2],void 0!==k&&d.push(4,e,f,(k+g)/2,(l+h)/2,(g+e)/2,(h+f)/2),k=g,l=h,g=e,h=f}c+=Q[n]+1}b=d}g={arrowSize:"arrow"===
this.type?a:0,arrowStyle:this.view.fa.ra.defaultArrowStyle,commands:b,seed:this.node.qa("seed"),fillStyle:this.view.Xa,strokeStyle:this.view.bb,lineWidth:this.view.va.lineWidth,sloppiness:this.view.va.sloppiness,smoothness:this.view.va.smoothness,layer:this.view.Ja};for(var q in this.ga)this.ga.hasOwnProperty(q)&&(g[q]=this.ga[q]);this.view.ya([new D("PathNode",g)]);this.node=null},cancel:function(){this.node&&(this.view.ka.removeNode(this.node),this.node=null)},Jb:function(){this.view.canvas.style.cursor=
"default";Td(this.view,null);this.view.na()},Bb:function(a){var b;a.$c?(this.view.Xa=a.Sa,this.view.ib=a.Sa,b="fillStyle",this.log("We are drawing lines. Set strokeStyle instead of fillStyle")):b="strokeStyle";this.view.bb=a.Sa;this.view.setProperty(b,a.Sa)},Qb:function(a,b){b?(this.view.Xa=Rc(this.view.Xa,a),this.view.ib=Rc(this.view.ib,a)):this.view.bb=Rc(this.view.bb,a);Yc(this.view,a,b)},Nb:function(){return this.type}};
function Vd(a,b,c){"curve"===a.type||"arrow"===a.type||"linear-bezier"===a.type?a.node.fd(b,c):a.node.lineTo(b,c)};function Wd(){}Wd.prototype={xb:"Action",je:function(a){var b,c,d,e;this.id&&(this.id=a(this.id));if(this.$&&0<this.$.length){e=[];b=c=0;for(d=this.$.length-1;0<=d?c<=d:c>=d;b=0<=d?++c:--c)e.push(this.$[b]=a(this.$[b]));return e}},log:t("ACTION"),toString:function(){return""+this.xb+"()"}};Wd.prototype=p.$({},lb.prototype,Wd.prototype);function D(a,b,c,d){this.type=a;this.aa=c;this.index=d;this.ga=b;this.id=0}
D.prototype={xb:"CreateAction",rb:function(a){this.id=this.id||Ud(a);this.node=Sc(this.type,this.id,a);if(!this.node)if(this.type in Ed)this.node=new Dd(this.id,a),this.node.setProperty("type",this.type);else{this.log("Bad node type: %s",this.type);var b=this.node=Sc("UnknownNode",this.id,a),c=this.type;b.aa=c;b.$.text=c;b.log("Creating placeholder for node type %s",c)}Tc(this.node,this.ga);if(void 0===this.aa||void 0===this.index)this.aa=a.$[a.ob].id,this.index=-1;b=A(a,this.aa);R(a,b,this.node,
this.index);this.log("Add %s id %s to parent %s index %s",this.node.type(),this.id,b.type(),this.index)},toString:function(){return""+this.xb+"("+this.type+", "+JSON.stringify(this.ga)+", parent="+this.aa+", index="+this.index+")"},Va:function(a){a.removeNode(this.node)}};D.prototype=p.$({},Wd.prototype,D.prototype);function Xd(a){this.$=a;this.aa=[]}
Xd.prototype={xb:"DeleteAction",rb:function(a){var b,c,d,e;this.aa.length=0;e=this.$;c=0;for(d=e.length;c<d;c++)b=e[c],b=A(a,b),this.aa.push({node:b,parent:b.parent,index:a.removeNode(b)})},Va:function(a){var b,c,d,e;if(0!==this.aa.length)for(e=this.aa,c=0,d=e.length;c<d;c++)b=e[c],R(a,b.parent,b.node,b.index)}};Xd.prototype=p.$({},Wd.prototype,Xd.prototype);function Zc(a,b,c){this.$=a;this.name=b;this.value=c;this.aa=[]}
Zc.prototype={xb:"SetAction",rb:function(a){var b,c,d,e;this.aa.length=0;e=this.$;c=0;for(d=e.length;c<d;c++)b=e[c],b=A(a,b),this.aa.push(b.qa(this.name)),b.setProperty(this.name,this.value)},Va:function(a){var b,c,d,e;if(0!==this.$.length)for(b=d=0,e=this.$.length-1;0<=e?d<=e:d>=e;b=0<=e?++d:--d)c=A(a,this.$[b]),c.setProperty(this.name,this.aa[b])},ee:function(a){if(this.name!==a.name)return!1;this.$.sort();a.$.sort();if(this.$.length!==a.$.length)return!1;for(var b=0;b<this.$.length;b++)if(this.$[b]!==
a.$[b])return!1;this.log("Merging property change %s",this.name);this.value=a.value;return!0}};Zc.prototype=p.$({},Wd.prototype,Zc.prototype);function Hc(a,b,c){this.$=a;this.xa=b;this.inverse=c}
Hc.prototype={xb:"TransformAction",rb:function(a){this.log("Execute transformAction");var b,c,d,e;e=this.$;c=0;for(d=e.length;c<d;c++)b=e[c],b=A(a,b),b.transform(this.xa,this.inverse)},Va:function(a){var b,c,d,e;e=this.$;c=0;for(d=e.length;c<d;c++)b=e[c],b=A(a,b),b.transform(this.inverse,this.xa)},je:function(a){var b,c,d;if(0!==this.$.length)for(b=c=0,d=this.$.length-1;0<=d?c<=d:c>=d;b=0<=d?++c:--c)this.$[b]=a(this.$[b])}};Hc.prototype=p.$({},Wd.prototype,Hc.prototype);
function fb(a,b,c,d,e,f){this.id=a;this.aa=b;this.ba=c;this.ha=d;this.x=e;this.y=f}fb.prototype={xb:"MoveEditHandleAction",rb:function(a){A(a,this.id).Gc(this.aa,this.x,this.y)},Va:function(a){A(a,this.id).Gc(this.aa,this.ba,this.ha)}};fb.prototype=p.$({},Wd.prototype,fb.prototype);function Yd(a){this.id=0;this.$=a;this.aa=[]}
Yd.prototype={xb:"GroupAction",rb:function(a){var b,c,d,e;this.aa.length=0;e=this.$;c=0;for(d=e.length;c<d;c++)b=e[c],b=A(a,b),this.aa.push({node:b,parent:b.parent,index:vd(b.parent,b)});this.id=this.id||Ud(a);this.node=a.qc(this.id,this.$)},Va:function(a){var b,c;if(0!==this.$.length){for(b=c=this.$.length-1;0<=c&&!(0>b);b=c+=-1)b=this.aa[b],R(a,b.parent,b.node,b.index);a.removeNode(this.node)}},toString:function(){return"GroupAction("+JSON.stringify(this.$)+")"}};
Yd.prototype=p.$({},Wd.prototype,Yd.prototype);function Zd(a){this.$=a;this.aa=[]}
Zd.prototype={xb:"UngroupAction",rb:function(a){var b,c,d,e,f,g,h,k,l;d={};k=this.$;e=0;for(g=k.length;e<g;e++)if(b=k[e],b=A(a,b),pd(b)&&!(b.id in d))for(d[b.id]=!0,c={node:b,parent:b.parent,children:b.children.concat(),index:a.removeNode(b)},this.aa.push(c),l=c.children,f=0,h=l.length;f<h;f++)b=l[f],R(a,c.parent,b,-1)},Va:function(a){var b,c,d,e;if(0!==this.aa.length){for(b=d=this.aa.length-1;0<=d&&!(0>b);b=d+=-1)if(b=this.aa[b],0!==b.children.length){for(c=e=b.children.length-1;0<=e&&!(0>c);c=e+=
-1)R(a,b.node,b.children[c],-1);R(a,b.parent,b.node,b.index)}a.hd()}}};Zd.prototype=p.$({},Wd.prototype,Zd.prototype);function $d(a,b,c){var d,e,f;if(pd(a))for(f=a.children,d=0,e=f.length;d<e;d++)a=f[d],$d(a,b,c);else a.transform(b,c)}function ae(a,b){this.$=a;this.offset=b;this.za=[];this.aa=[]}
ae.prototype={xb:"DuplicateAction",rb:function(a){var b,c,d,e,f,g,h;e=new E(this.offset,this.offset);c=e.inverse();this.za.length=0;var k=this;d=this.aa.length?function(){return k.aa[f]}:function(){var b=Ud(a);k.aa.push(b);return b};h=this.$;f=0;for(g=h.length;f<g;f++)b=h[f],b=A(a,b).clone(d),$d(b,e,c),Uc(a,b),this.za.push(b)},Va:function(a){var b,c;if(0!==this.za.length)for(b=c=this.za.length-1;0<=c&&!(0>b);b=c+=-1)a.removeNode(this.za[b])}};ae.prototype=p.$({},Wd.prototype,ae.prototype);
function be(a,b){this.$=a;this.type=b;this.za=[];this.aa=[]}
be.prototype={xb:"ChangeOrderAction",rb:function(a){var b,c,d,e,f,g;this.aa.length=0;this.za.length=0;g=this.$;e=0;for(f=g.length;e<f;e++)switch(b=g[e],b=A(a,b),d=b.parent,c=a.removeNode(b),this.aa.push(c),this.za.push(b),this.type){case ce:R(a,d,b,-1);break;case de:R(a,d,b,0);break;case ee:0<c?R(a,d,b,c-1):R(a,d,b,c);break;case fe:c<d.children.length?R(a,d,b,c+1):R(a,d,b,c)}},Va:function(a){var b,c,d,e;if(0!==this.$.length)for(b=e=this.$.length-1;0<=e&&!(0>b);b=e+=-1)c=this.za[b],d=c.parent,a.removeNode(c),
R(a,d,c,this.aa[b])}};var ce=0,de=1,fe=2,ee=3;be.prototype=p.$({},Wd.prototype,be.prototype);function ge(a){this.ga=a}ge.prototype={xb:"SetDocumentPropertiesAction",rb:function(a){var b;this.aa={};for(b in this.ga)this.ga.hasOwnProperty(b)&&(this.aa[b]=a.qa(b),a.setProperty(b,this.ga[b]))},Va:function(a){for(var b in this.aa)this.aa.hasOwnProperty(b)&&a.setProperty(b,this.aa[b])}};ge.prototype=p.$({},Wd.prototype,ge.prototype);function S(a,b){if(!a)throw b||"Assertion failed";}function he(a){S("number"===typeof a,"Expected a number")}function ie(a){return"object"===typeof a&&"[object Array]"===Object.prototype.toString.apply(a)}function je(a){return"string"===typeof a}function T(a){return"number"===typeof a};function V(a){this.keys={};1===arguments.length&&this.add(arguments[0]);1===arguments.length&&"object"===typeof arguments[0]&&this.add(arguments[0])}
V.prototype={contains:function(a){return a in this.keys},add:function(a){var b,c;if("string"===typeof a||"number"===typeof a)this.keys[a]=!0;else if("object"===typeof a)if("[object Array]"===Object.prototype.toString.apply(a))for(c=0;c<a.length;c++)b=a[c],this.keys[b]=!0;else for(b in a)a.hasOwnProperty(b)&&(this.keys[b]=!0);else return S(!1,"Arg must be an array")},remove:function(a){delete this.keys[a]},Eb:function(){var a,b;b=[];for(a in this.keys)this.keys.hasOwnProperty(a)&&b.push(a);return b}};
function ke(a){var b,c;c=[];for(b in a.keys)a.keys.hasOwnProperty(b)&&c.push(parseFloat(b));return c}function le(a,b){var c,d;S(b instanceof V);d=new V;for(c in a.keys)b.contains(c)||d.add(c);return d};function me(a){J.apply(this,arguments);this.la=new kb;this.za={};this.sa=new V;this.hd=this.Ya=!0;this.hb=0;this.ha=new V;this.ba=new V;this.oa=new V;this.root=new ud(Ud(this),this);this.za[this.root.id]=this.root;this.tb=0;this.sb="magenta";this.cb=this.la.next;this.ga={};this.Ka=new V;this.Ab=new V;this.Da=[];this.$=[];this.ob=0;a||(ne(this,this.root),this.lb(this.Ec(0)))}
me.prototype={log:t("DOC"),empty:function(){return 0===this.root.children.length},ec:function(){return this.cb!==this.la.next},ya:function(a,b){this.ha=new V;this.ba=new V;this.oa=new V;if(b){this.log("Performing actions without adding to undo stack");for(var c=0;c<a.length;c++)a[c].rb(this)}else this.la.ya(a,!1,this);return{zb:ke(this.ha),Yb:ke(this.ba),$b:ke(le(le(this.oa,this.ha),this.ba))}},Va:function(){this.ha=new V;this.ba=new V;this.oa=new V;this.la.Va(this);return{zb:ke(this.ha),Yb:ke(this.ba),
$b:ke(le(le(this.oa,this.ha),this.ba))}},Sb:function(){this.ha=new V;this.ba=new V;this.oa=new V;this.la.Sb(this);return{zb:ke(this.ha),Yb:ke(this.ba),$b:ke(le(le(this.oa,this.ha),this.ba))}},cc:function(){return this.la.cc()},bc:function(){return this.la.bc()},format:function(a,b){var c,d,e,f,g;d=this.Ya?this.za:this.sa.keys;e=[];for(c in d)d.hasOwnProperty(c)&&e.push(this.za[c]);g=oe(this,e);d=0;for(f=g.length;d<f;d++)c=g[d],c.format(a,b);this.sa.keys={};this.Ya=!1;return e.length},na:function(a){function b(b){pe(f,
a,b);qe(f,function(c){f.Ka.contains(qd(c))||c.sc()===b&&(c.oa||c.na(a))})}var c,d,e,f=this;c=ke(this.Ab);c.sort(function(a,b){return a-b});d=0;for(e=c.length;d<e;d++)b(c[d])},gb:function(a,b,c){var d;d=null;qe(this,function(e){qd(e)===c&&e.gb(a,b)&&(null===d||d.sc()<=e.sc())&&(d=e)});return d},jb:function(a,b){var c;c=function(d){var e,f,g;if(d.children)for(a&&b(d),g=d.children,e=0,f=g.length;e<f;e++)d=g[e],c(d);else b(d)};c(this.root)},qc:function(a,b){var c,d,e,f;c=new ud(a,this);Uc(this,c);e=0;
for(f=b.length;e<f;e++)d=b[e],R(this,c,this.za[d],-1);return c},removeNode:function(a,b){var c,d,e=this;void 0===b&&(b=!0);c=vd(a.parent,a);0<=c&&(a.parent.children.splice(c,1),a.parent=null,b&&(d=function(b){var c,h,k,l;delete e.za[b.id];a.ie();e.sa.remove(b.id);if(pd(b))for(l=b.children,h=0,k=l.length;h<k;h++)c=l[h],d(c);b.qa("spotHighlight")&&re(e.Da,b)},d(a)));"PageNode"===a.type()&&(this.$.splice(c,1),c===this.ob&&(this.log("Removed current page."),this.lb(Math.min(c,this.$.length-1))));this.ba.add(a.id);
return c},kb:function(){var a,b,c,d,e;a=e=d=b=null;this.jb(!1,function(c){if(null===b||c.rect.x<b)b=c.rect.x;if(null===d||c.rect.right()>d)d=c.rect.right();if(null===e||c.rect.y<e)e=c.rect.y;if(null===a||c.rect.bottom()>a)a=c.rect.bottom()});c=null===b?new L(0,0,10,10):new L(b,e,d-b,a-e);this.log("getDrawingRectangle: %s",c);return c},qa:function(a){return this.ga[a]},setProperty:function(a,b){void 0===b?a in this.ga&&delete this.ga[a]:this.ga[a]=b},Vc:function(a,b){this.log("showLayer(%s, %s)",a,
b);b?this.Ka.remove(a):this.Ka.add(a)},Jd:function(a){return!this.Ka.contains(a)},Ec:function(a){this.log("Adding page to document with index %s",a);if(a>this.$.length)return this.log("Error: Can insert page with index %s",a),-1;var b=Sc("PageNode",Ud(this),this);R(this,this.root,b,a);return a},Mb:function(){return this.$.length},lb:function(a){if(0<=a&&a<this.$.length)return this.log("Set current page to %s/%s",a,this.$.length),this.ob=a,!0;this.log("Tried to set page to non-existing %s",a);return!1},
yc:function(a){this.jb(!1,function(b){b.yc(a)})}};function se(a){var b=816,c=1056;"width"in a.ga&&(b=a.ga.width);"height"in a.ga&&(c=a.ga.height);return new bc(b,c)}function te(a){return"width"in a.ga?new L(0,0,a.ga.width,a.ga.height):a.kb()}function re(a,b){var c;"function"!==typeof b?c=function(a){return a===b}:c=b;for(var d=0,e=0;e<a.length;e++)c(a[e])?d+=1:d&&(a[e-d]=a[e]);a.length-=d}
function R(a,b,c,d){c.parent&&a.removeNode(c,!1);-1===d?b.children.push(c):b.children.splice(d,0,c);ne(a,c);a.hd=!0;"PageNode"===c.type()&&(-1===d?a.$.push(c):a.$.splice(d,0,c));c.parent=b}
function ue(a,b,c){var d,e,f,g,h,k,l,n,q,r;0===b.indexOf("zwibblerclip.")&&(b=b.substr(13));f=JSON.parse(b);b=[];h=a.hb;q=0;for(r=f.length;q<r;q++)if(e=f[q],"GroupAction"===e.type)b.push(new Yd(e.members)),c.push(h++);else if("CreateAction"===e.type){n=e.properties;k={};for(g in n)n.hasOwnProperty(g)&&(l=n[g],"[object Array]"===Object.prototype.toString.apply(l)&&"Matrix"===l[0]&&(l.splice(0,1),l=new M(l)),k[g]=l);b.push(new D(e.node,k));c.push(h++)}d=a.hb;g=function(b){a.log("Remap %s -> %s",b,b+
d);return b+d};e=0;for(f=b.length;e<f;e++)c=b[e],c.je(g);return b}function ve(a,b,c,d){var e,f,g,h;if(pd(b)){e=[];h=b.children;f=0;for(g=h.length;f<g;f++)b=h[f],d=ve(a,b,c,d),e.push(d-1);c.push({type:"GroupAction",members:e})}else{a=nd(b);g={};for(e in a)a.hasOwnProperty(e)&&(f=a[e],f instanceof M&&(f=["Matrix",f.m11,f.m12,f.m21,f.m22,f.Aa,f.Ba]),g[e]=f);c.push({type:"CreateAction",node:b.type(),properties:g})}return d+1}
function we(a,b){var c;c=0;a.hd&&(a.hd=!1,a.jb(!0,function(a){a.Da=c++}));b.sort(function(a,b){return a.Da-b.Da})}function qe(a,b){function c(a){if(a.children)for(var e=0;e<a.children.length;e++)c(a.children[e]);else"PageNode"!==a.type()&&b(a)}c(a.$[a.ob])}function oe(a,b){var c,d,e,f,g;e=[];c={};f=0;for(g=b.length;f<g;f++){for(d=b[f];od(d);)d=d.parent;d.id in c||(c[d.id]=!0,e.push(d))}we(a,e);return e}function xe(a,b){var c=[];qe(a,function(a){b.contains(a.kb())&&c.push(a)});return c}
function pe(a,b,c){if(0!==a.Da.length&&c===a.tb){b.save();b.beginPath();c=te(a);b.moveTo(c.x,c.y);b.lineTo(c.x,c.bottom());b.lineTo(c.right(),c.bottom());b.lineTo(c.right(),c.y);b.closePath();for(var d=0;d<a.Da.length;d++)a.Da[d].clip(b);b.clip();b.fillStyle=a.sb;b.fillRect(c.x,c.y,c.width,c.height);b.restore()}}function ye(a){a.la=new kb}function A(a,b){var c;he(b);return b in a.za?(c=a.za[b],a.sa.add(b),a.oa.add(b),c):null}function Uc(a,b){R(a,a.$[a.ob],b,-1)}
function Qc(a,b){he(b);a.oa.add(b);a.sa.add(b)}function ne(a,b,c){var d,e,f,g;void 0===c&&(c=!0);S("id"in b,"Must be a node");if(!(b.id in a.za)&&(a.za[b.id]=b,a.ha.add(b.id),pd(b)))for(g=b.children,e=0,f=g.length;e<f;e++)d=g[e],ne(a,d,c);b.yc(!1);c&&a.sa.add(b.id);a.Ab.add(b.sc());b.qa("spotHighlight")&&"PathNode"===b.type()&&a.Da.push(b);b.ge()}function Ud(a){a.log("nextId bumped to %s",a.hb+1);return a.hb++}p.$({},J.prototype,me.prototype);function ze(a){var b=this;this.Cb=0;"string"===typeof a?(this.getUint8=function(){S(b.Cb<b.data.length);return b.data.charCodeAt(b.Cb++)&255},this.data=a):this.data=new Uint8Array(a)}
ze.prototype={log:t("BinaryReader"),seek:function(a){S(0<=a&&a<=this.data.length);var b=this.Cb;this.Cb=a;return b},getUint8:function(){S(this.Cb<this.data.length);return this.data[this.Cb++]},getUint16:function(){return(this.getUint8()<<8|this.getUint8())>>>0},getUint32:function(){return Ae(this)>>>0},getInt16:function(){var a=this.getUint16();a&32768&&(a-=65536);return a},getDate:function(){var a=1E3*(4294967296*this.getUint32()+this.getUint32())+Date.UTC(1904,1,1);return new Date(a)}};
function Be(a,b){for(var c="",d=0;d<b;d++)c+=String.fromCharCode(a.getUint8());return c}function Ae(a){return a.getUint8()<<24|a.getUint8()<<16|a.getUint8()<<8|a.getUint8()}function Ce(a){this.format=0;this.$=[];for(var b=0;256>b;b++){var c=a.getUint8();this.log("   Glyph[%s] = %s",b,c);this.$.push(c)}}Ce.prototype={log:t("CMAP0"),map:function(a){return 0<=a&&255>=a?this.$[a]:0}};
function De(a){this.format=4;var b,c=[],d=a.getUint16()/2;a.getUint16();a.getUint16();a.getUint16();for(b=0;b<d;b++)c.push({Wd:a.getUint16()});a.getUint16();for(b=0;b<d;b++)c[b].Nd=a.getUint16();for(b=0;b<d;b++)c[b].Jf=a.getUint16();for(b=0;b<d;b++){var e=a.getUint16();e?c[b].nd=a.Cb-2+e:c[b].nd=0}this.$=c;this.aa={};this.ba=a}
De.prototype={log:t("CMAP4"),map:function(a){if(!(a in this.aa)){for(var b=0;b<this.$.length;b++){var c=this.$[b];if(c.Nd<=a&&c.Wd>=a){var d,e;c.nd?(e=c.nd+2*(a-c.Nd),this.ba.seek(e),d=this.ba.getUint16()):d=c.Jf+a&65535;this.log("Charcode %s is between %s and %s; maps to %s (%s) roffset=%s",a,c.Nd,c.Wd,e,d,c.nd);this.aa[a]=d;break}}b===this.$.length&&(this.aa[a]=0)}return this.aa[a]}};
function Ee(a,b,c){this.ba=b&&!c||!b&&c;this.offset=a.Cb;this.aa=a.getUint16();a.getUint16();a.getUint16();a.getUint16();this.map={};for(b=0;b<this.aa;b++){c=a.getUint16();var d=a.getUint16(),e=a.getInt16();this.map[c<<16|d]=e}this.reset()}Ee.prototype={log:t("KERN0"),reset:function(){this.$=-1},get:function(a){var b=0;if(0<=this.$){var c=this.$<<16|a;c in this.map&&(b=this.map[c])}this.$=a;return this.ba?{x:0,y:b}:{x:b,y:0}}};
function Fe(a){this.aa=new ze(a);this.la=[];this.Fc=[];a=this.aa;var b={};a.getUint32();var c=a.getUint16();a.getUint16();a.getUint16();a.getUint16();for(var d=0;d<c;d++){var e=Be(a,4);b[e]={kf:a.getUint32(),offset:a.getUint32(),length:a.getUint32()};"head"!==e&&this.log("Table %s has checksum 0x%s",e,b[e].kf.toString(16))}this.$=b;a=this.aa;S("head"in this.$);a.seek(this.$.head.offset);this.version=Ae(a)/65536;Ae(a);a.getUint32();this.Da=a.getUint32();S(1594834165===this.Da);a.getUint16();this.oa=
a.getUint16();a.getDate();a.getDate();this.Cg=a.getInt16();this.Eg=a.getInt16();this.Bg=a.getInt16();this.Dg=a.getInt16();a.getUint16();a.getUint16();a.getInt16();this.sa=a.getInt16();a.getInt16();a=this.aa;S("name"in this.$);b=this.$.name.offset;a.seek(b);a.getUint16();c=a.getUint16();d=a.getUint16();for(e=0;e<c;e++){var f=a.getUint16(),g=a.getUint16(),h=a.getUint16(),k=a.getUint16(),l=a.getUint16(),n=a.getUint16(),n=a.seek(b+d+n),q;if(0===f||3===f){q=a;for(var r="",u=0;u<l;u+=2)r+=String.fromCharCode(q.getUint16());
q=r}else q=Be(a,l);this.log("Name %s/%s id %s language %s: %s",f,g,k,h,q);a.seek(n);switch(k){case 1:this.fontFamily=q;break;case 4:this.ba=q}}a=this.aa;S("cmap"in this.$);b=this.$.cmap.offset;a.seek(b);a.getUint16();c=a.getUint16();for(d=0;d<c;d++)e=a.getUint16(),g=a.getUint16(),f=a.getUint32(),this.log("CMap platformid=%s specificid=%s offset=%s",e,g,f),3===e&&1>=g&&(e=a,f=e.seek(b+f),g=e.getUint16(),h=e.getUint16(),e.getUint16(),k=void 0,this.log("    Cmap format %s length %s",g,h),0===g?k=new Ce(e):
4===g&&(k=new De(e)),k&&this.la.push(k),e.seek(f));a=this.aa;S("hhea"in this.$);a.seek(this.$.hhea.offset);Ae(a);a.getInt16();a.getInt16();a.getInt16();a.getUint16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();this.ha=a.getUint16();a=this.aa;if("kern"in this.$)for(a.seek(this.$.kern.offset),h=a.getUint16(),b=a.getUint16(),this.log("Kern Table version: %s",h),this.log("Kern nTables: %s",b),c=0;c<b;c++)h=
a.getUint16(),d=a.getUint16(),k=a.getUint16(),e=k>>8,f=k&4,g=0===(k&1),this.log("Kerning subtable version %s format %s length %s coverage: %s",h,e,d,k),h=null,0===e?h=new Ee(a,g,f):(this.log("Unknown format -- skip"),a.seek(a.Cb+d)),h&&this.Fc.push(h);S("maxp"in this.$);a=this.aa.seek(this.$.maxp.offset+4);b=this.aa.getUint16();this.aa.seek(a);this.length=b}Fe.prototype={log:t("TrueType"),transform:function(a,b){a.scale(b/this.oa,-b/this.oa)}};
function Ge(a,b){function c(b,c,e){for(var h=0,k=0;k<f;k++){var v=g[k];v&c?h=v&e?h+a.getUint8():h-a.getUint8():~v&e&&(h+=a.getInt16());d[k][b]=h}}b.type="simple";b.Vb=[];for(var d=b.ta=[],e=0;e<b.Hc;e++)b.Vb.push(a.getUint16());a.seek(a.getUint16()+a.Cb);if(0!==b.Hc){for(var f=Math.max.apply(null,b.Vb)+1,g=[],e=0;e<f;e++){var h=a.getUint8();g.push(h);d.push({tc:0<(h&1)});if(h&8){var k=a.getUint8();S(0<k);for(e+=k;k--;)g.push(h),d.push({tc:0<(h&1)})}}c("x",2,16);c("y",4,32)}}
function He(a,b){var c;S("loca"in a.$);c=a.$.loca;var d=a.aa,e,f;1===a.sa?(e=d.seek(c.offset+4*b),c=d.getUint32(),f=d.getUint32()):(e=d.seek(c.offset+2*b),c=2*d.getUint16(),f=2*d.getUint16());d.seek(e);c=c===f?0:c+a.$.glyf.offset;d=a.aa;if(0===c||c>=a.$.glyf.offset+a.$.glyf.length)return null;S(c>=a.$.glyf.offset);S(c<a.$.glyf.offset+a.$.glyf.length);d.seek(c);c={Hc:d.getInt16(),Cg:d.getInt16(),Eg:d.getInt16(),Bg:d.getInt16(),Dg:d.getInt16()};S(-1<=c.Hc);if(-1===c.Hc){var g,h,k,l,n;c.type="simple";
var q=32;c.Vb=[];for(c.ta=[];q&32;){var r,u,q=d.getUint16();n=d.getUint16();e=1;g=f=0;h=1;l=k=0;q&1?(r=d.getInt16(),u=d.getInt16()):(r=d.getUint8(),u=d.getUint8());q&2&&(k=r,l=u);q&8?h=e=d.getInt16()/16384:q&64?(e=d.getInt16()/16384,h=d.getInt16()/16384):q&128&&(e=d.getInt16()/16384,f=d.getInt16()/16384,g=d.getInt16()/16384,h=d.getInt16()/16384);a.log("Read component glyph index %s",n);a.log("Transform: [%s %s %s %s %s %s]",e,f,g,h,k,l);r=d.Cb;if(n=He(a,n)){var v=c.ta.length;for(u=0;u<n.Vb.length;u++)c.Vb.push(n.Vb[u]+
v);for(u=0;u<n.ta.length;u++){var v=n.ta[u].x,w=n.ta[u].y,v=e*v+f*w+k,w=g*v+h*w+l;c.ta.push({x:v,y:w,tc:n.ta[u].tc})}}d.seek(r)}c.Hc=c.Vb.length;q&256&&d.seek(d.getUint16()+d.Cb)}else Ge(d,c);return c}function Ie(){J.call(this);this.fonts={};this.error=null;this.$=0}
Ie.prototype={log:t("FontCollection"),add:function(a,b){this.$+=1;var c=this;p.aa({url:a,ig:function(d){var e=b;c.log("Got font %s; result is %s bytes",a,d.length);for(var f="",g=0;g<d.length;g++)f+=String.fromCharCode(d.charCodeAt(g)&255);d=new Fe(f);c.log("Loaded '%s'",d.ba);for(g=0;g<d.ba.length;g++)c.log("   %s, %s",d.ba.charAt(g),d.ba.charCodeAt(g));e=e||d.ba;c.fonts[e]={name:d.ba,url:a,data:f,font:d};--c.$;0===c.$&&c.emit("done")},error:function(){c.log("Error fetching "+a)},jf:function(a,b){b.overrideMimeType("text/plain; charset=x-user-defined")}})},
get:function(a){this.log("Lookup font %s",a);for(var b=0;b<a.length;b++)this.log("   %s, %s",a.charAt(b),a.charCodeAt(b));if(a in this.fonts)return this.fonts[a].font;this.log("Lookup font %s; not found",a)}};Ie.prototype=p.$({},J.prototype,Ie.prototype);function W(a,b){this.type=a;this.values=b;if(4>this.values.length)throw"Bad value";}var Je;
function Qd(a,b){a.toLowerCase()in Ke&&(a=Ke[a.toLowerCase()]);var c=/\#([0-9a-f])([0-9a-f])([0-9a-f])/i,d=/rgb\( *([0-9]+) *, *([0-9]+) *, *([0-9]+) *\)/,e=/rgba\( *([0-9]+) *, *([0-9]+) *, *([0-9]+) *, *([0-9\.]+) *\)/,f;f=/\#([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])/i.exec(a);if(null!==f)c=parseInt(f[1],16)/255,d=parseInt(f[2],16)/255,e=parseInt(f[3],16)/255,f=1;else if(f=e.exec(a),null!==f)c=parseFloat(f[1])/255,d=parseFloat(f[2])/255,e=parseFloat(f[3])/255,f=parseFloat(f[4]);else{f=
d.exec(a);if(null!==f)c=parseFloat(f[1])/255,d=parseFloat(f[2])/255,e=parseFloat(f[3])/255;else if(f=c.exec(a),null!==f)c=parseInt(f[1],16),c=(16*c+c)/255,d=parseInt(f[2],16),d=(16*d+d)/255,e=parseInt(f[2],16),e=(16*e+e)/255;else{if(b)return null;c=1;d=0;e=1}f=1}return new W(0,[c,d,e,f])}
W.prototype={toString:function(){function a(a){a=Math.round(255*a);return 16>a?"0"+a.toString(16):a.toString(16)}var b=Le(this,0);return 1===b.values[3]?"#"+a(b.values[0])+a(b.values[1])+a(b.values[2]):"rgba("+Math.round(255*b.values[0])+","+Math.round(255*b.values[1])+","+Math.round(255*b.values[2])+","+b.values[3]+")"},pb:function(a){a.type!==this.type&&(a=Le(a,this.type));if(2===this.type){var b=this.values[0],c=a.values[0],b=b>c?Math.min(b-c,c-b+360):Math.min(c-b,b-c+360),b=b/360;return Math.pow(b*
b+(this.values[1]-a.values[1])*(this.values[1]-a.values[1])+(this.values[2]-a.values[2])*(this.values[2]-a.values[2]),.5)}return Math.pow((this.values[0]-a.values[0])*(this.values[0]-a.values[0])+(this.values[1]-a.values[1])*(this.values[1]-a.values[1])+(this.values[2]-a.values[2])*(this.values[2]-a.values[2]),.5)}};function Le(a,b){return Je[a.type][b](a)}
(function(){function a(a){var b=a.values[0],c=a.values[1],d=a.values[2];0>b&&(b+=360);var e=b/60-Math.floor(b/60),f=d*(1-c),g=d*(1-e*c),c=d*(1-(1-e)*c),h,k,l;switch(Math.floor(b/60)%6){case 0:h=d;k=c;l=f;break;case 1:h=g;k=d;l=f;break;case 2:h=f;k=d;l=c;break;case 3:h=f;k=g;l=d;break;case 4:h=c;k=f;l=d;break;case 5:h=d,k=f,l=g}return new W(0,[h,k,l,a.values[3]])}function b(a){var b,c=a.values[0],d=a.values[1],e=a.values[2],f=Math.max(c,d,e),g=Math.min(c,d,e);f===g?b=0:f===c?b=(60*(d-e)/(f-g)+360)%
360:f===d?b=60*(e-c)/(f-g)+120:f===e&&(b=60*(c-d)/(f-g)+240);return new W(2,[b,0===f?0:1-g/f,f,a.values[3]])}function c(a){function b(a){return a>6/29*(6/29)*(6/29)?Math.pow(a,1/3):1/3*(29/6)*(29/6)*a+4/29}var c=b(a.values[1]/l.wd);return new W(3,[116*c-16,500*(b(a.values[0]/l.vd)-c),200*(c-b(a.values[2]/l.xd)),a.values[3]])}function d(a){var b=(a.values[0]+16)/116,c=b+a.values[1]/500,d=b-a.values[2]/200,e=6/29;return new W(1,[c>e?l.vd*c*c*c:3*(c-16/116)*e*e*l.vd,b>e?l.wd*b*b*b:3*(b-16/116)*e*e*l.wd,
d>e?l.xd*d*d*d:3*(d-16/116)*e*e*l.xd,a.values[3]])}function e(a){for(var b=[],c=0;3>c;c++)b[c]=.04045>=a.values[c]?a.values[c]/12.92:Math.pow((a.values[c]+.055)/1.055,2.4);return new W(1,[.4124*b[0]+.3576*b[1]+.1805*b[2],.2126*b[0]+.7152*b[1]+.0722*b[2],.0193*b[0]+.1192*b[1]+.9505*b[2],a.values[3]])}function f(a){var b=[],c=[];b[0]=3.241*a.values[0]-1.5374*a.values[1]-.4986*a.values[2];b[1]=-.9692*a.values[0]+1.876*a.values[1]+.0416*a.values[2];b[2]=.0556*a.values[0]-.204*a.values[1]+1.057*a.values[2];
for(var d=0;3>d;d++)c[d]=.0031308>=b[d]?12.92*b[d]:1.055*Math.pow(b[d],1/2.4)-.055;c[3]=a.values[3];return new W(0,c)}function g(a){return new W(a.type,a.values.concat())}function h(a){return c(e(a))}function k(a){return b(f(a))}var l={vd:.9505,wd:1,xd:1.089};Je=[[g,e,b,h],[f,g,k,c],[a,function(b){return e(a(b))},g,function(b){return h(a(b))}],[function(a){return f(d(a))},d,function(a){return k(d(a))},g]]})();
var Ke={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",
darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",
gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",
lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",
orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",
snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",transparent:"rgba(0,0,0,0.0)",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};var Me=t("MISC");function Ne(a){window.jQuery&&a instanceof window.jQuery&&(a=a[0]);return p(a)}function Oe(a){var b=document.createElement("canvas");a&&a.appendChild(b);"G_vmlCanvasManager"in window&&(Me("Emulating canvas in IE"),G_vmlCanvasManager.initElement(b),p(b).bind("selectstart",function(a){Me("Cancelled selectstart on canvas");a.stopPropagation();a.preventDefault()}));b.style.background="transparent";return b}var Pe=/MSIE ([0-9]{1,}[\.0-9]{0,})/,Qe=null;
function Re(){var a;if(null!==Qe)a=Qe;else{a=-1;if("Microsoft Internet Explorer"===navigator.appName){var b=Pe.exec(navigator.userAgent);null!==b&&(a=parseFloat(b[1]))}Qe=a;Me("IE version is %s",a)}return 0<=a&&9>a}function Se(a){for(var b=0;a;)try{var c=parseInt(p(a).da("z-index"),10);c&&(b=Math.max(b,c));a=a.parentNode}catch(d){break}return b}
function Te(){if(null===Ue){var a=document.createElement("div");a.style.visibility="hidden";a.style.width="100px";document.body.appendChild(a);var b=a.offsetWidth;a.style.overflow="scroll";var c=document.createElement("div");c.style.width="100%";a.appendChild(c);c=c.offsetWidth;a.parentNode.removeChild(a);Ue=b-c;Me("ScrollbarWidth calculated as %spx",Ue)}return Ue}var Ue=null;function Rc(a,b){var c=Qd(a);c.values[3]=b;return c.toString()}
function Ve(a){var b=atob(a.split(",")[1]);a=a.split(",")[0].split(":")[1].split(";")[0];for(var c=new ArrayBuffer(b.length),d=new Uint8Array(c),e=0;e<b.length;e++)d[e]=b.charCodeAt(e);return new Blob([c],{type:a})}function We(){var a=document.documentElement,b=a.scrollHeight>p(a).height(),a=a.scrollWidth>p(a).width(),b=b?Te():0,a=a?Te():0;return{width:p(window).width()-b,height:p(window).height()-a,x:document.body.scrollLeft,y:document.body.scrollTop}}
function dd(a){var b=We();a=p(a);var c=a.offset();c.left=Math.min(c.left,b.x+b.width-a.outerWidth());c.top=Math.min(c.top,b.y+b.height-a.outerHeight());a.offset(c)};function Xe(a,b,c,d){Ye(this,a,b,c,d)}
function Ye(a,b,c,d,e){function f(a){for(var b=30;100>b;b+=20)a.values[2]=b/100,g.$.push(a.toString())}J.call(a);a.canvas=p(Oe(b[0]));a.ia=a.canvas;a.canvas.da("position","absolute");a.canvas.da("border","none");a.canvas.da("border-top","1px solid black");a.canvas.da("display","block");a.ma=a.canvas[0].getContext("2d");a.size=c;a.Kb=d;a.la=e;a.$="rgba(0,0,0,0.0) rgba(0,0,0,0.5) #000000 #ffffff #000088 #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" ");var g=
a;f(new W(2,[0,0,0,1]));for(b=0;720>b;b+=35)c=new W(2,[b,.5,0,1]),f(c);Ze(a,100);a.canvas.bind("touchstart",function(a){var b=g.canvas.offset();g.vb(a.touches[0].pageX-b.left-0,a.touches[0].pageY-b.top-0,1);a.preventDefault();a.stopPropagation()});Ka(a.canvas,function(a){var b=g.canvas.offset();g.vb(a.pageX-b.left-0,a.pageY-b.top-0,a.which)||(a.preventDefault(),a.stopPropagation())});a.canvas.bind("contextmenu",function(a){a.preventDefault();a.stopPropagation();return!1})}m=Xe.prototype;m.log=t("COLOURPANEL");
m.Zb=function(a,b){this.size=a;this.Kb=b;this.format();this.na()};function $e(a,b){a.$=b.slice(0);a.log("Set colours to %s len=%s",a.$,a.$.length);a.format();a.na()}function Ze(a,b){a.width=b;a.canvas.ab("width",""+a.width);a.format();a.na()}function af(a,b){a.ha=b;a.canvas.ab("height",""+(a.ha-1))}m.height=function(){return this.ha};m.moveTo=function(a,b){this.canvas.da("left",""+a+"px");this.canvas.da("top",""+b+"px")};
m.format=function(){this.ba=Math.floor(this.width/this.size);var a=Math.ceil(this.$.length/this.ba);this.log("Format to width=%s; height=%s wrap=%s, cpr=%s",this.width,a*this.size,this.la,this.ba);this.la?af(this,a*this.size):af(this,this.size)};function bf(a,b,c,d){a.fillStyle="#ffffff";a.fillRect(b,c,d,d);a.beginPath();a.strokeStyle="#000000";a.moveTo(b,c);a.lineTo(b+d,c+d);a.moveTo(b+d,c);a.lineTo(b,c+d);a.stroke()}
function cf(a,b,c,d){for(var e,f=0;f<d;f+=5){e=0===f/5%2;for(var g=0;g<d;g+=5)a.fillStyle=e?"#000000":"#ffffff",e=!e,a.fillRect(b+g,c+f,5,5)}e=a.createLinearGradient(b+d,c+d,b,c);e.addColorStop(0,"rgba(255, 255, 255, 1.0)");e.addColorStop(1,"rgba(255, 255, 255, 0.0)");a.fillStyle=e;a.fillRect(b,c,d,d)}
m.na=function(){for(var a=0,b=0,c=0;c<this.$.length;c++){var d=Qd(this.$[c]);this.ma.fillStyle=this.$[c];this.ma.fillRect(a,b,this.size,this.size);0===d.values[3]?bf(this.ma,a,b,this.size):.5===d.values[3]&&cf(this.ma,a,b,this.size);a+=this.size;a>=this.width&&(b+=this.size,a=0)}};m.Ma=function(){this.canvas.Ma()};m.show=function(){this.canvas.show()};
m.vb=function(a,b,c){a=Math.floor(a/this.size);var d=Math.floor(b/this.size);b=d*this.ba+a;this.log("row=%s col=%s index=%s coloursPerRow=%s",d,a,b,this.ba);c=1===c;return 0===b?(this.emit("opacity",0,c),!0):1===b?(this.emit("opacity",.5,c),!0):b<this.$.length?(this.emit("colour",{Sa:this.$[b],$c:c}),!0):!1};p.$(Xe.prototype,J.prototype);function df(a,b,c){var d=this;J.call(this);this.ha=b;this.ia=p(a);b||(this.ia.da("overflow-y","scroll"),this.ia.da("text-align","center"));b||c||(a=p("<input>").ab("type","button").ab("value","Add Page"),this.ia.append(a),a.click(function(){d.ua.mc(d.ua.Ec(d.ua.gc()+1))}),a=p("<input>").ab("type","button").ab("value","Delete Page"),this.ia.append(a),a.click(function(){d.ua.Ud(d.ua.gc())}),this.ba=!1);this.$=[]}
df.prototype={log:t("PageSelector"),lb:function(a){this.log("Set page %s",a);this.page<this.$.length&&p(this.$[this.page]).da("border-color","transparent");this.page=a;this.page<this.$.length&&p(this.$[this.page]).da("border-color","#9fb3e7")}};
function ef(a,b){var c=Oe(a.ia[0]);a.ha||(p(c).da("margin-left","10px"),p(c).da("margin-right","10px"),p(c).da("margin-top","5px"),p(c).da("margin-bottom","5px"));p(c).da("border-width","3px");a.log("Make canvas for page %s, currentPage is %s",b,a.page);b===a.page?p(c).da("border-color","#9fb3e7"):p(c).da("border-color","transparent");p(c).da("border-style","solid");a.$.push(c);c.page=b;p(c).click(function(){a.ua.mc(c.page)});return c}
function ff(a){a.log("Regenerate page views.");var b=a.ia.width()-6-10-Te(),c=a.ia.height()-6,d=a.ua.Mb(),e=a.ua.Cc();c>b?c=b/e.width*e.height:b=c/e.height*e.width;for(var f=0;f<d;f++){var g;g=f===a.$.length?ef(a,f):a.$[f];g.width=b;g.height=c;g=g.getContext("2d");g.save();g.fillStyle="#ffffff";g.fillRect(0,0,b,c);g.scale(b/e.width,b/e.width);g.translate(-e.x,-e.y);a.ua.na(g,{page:f});g.restore()}for(;f<a.$.length;f++)p(a.$[f]).remove();a.$.length=d}
function gf(a,b){function c(){null===e&&d.ba&&(e=setTimeout(function(){ff(d);d.lb(d.ua.gc());e=null},100))}var d=a,e=null;a.ua=b;b.on("document-changed",function(){c()});b.on("resource-loaded",function(){c()});b.on("set-page",function(a){d.lb(a)})}function hf(a,b){a.ba=b;a.ba&&a.ua&&setTimeout(function(){ff(a)},10)}df.prototype=p.$({},J.prototype,df.prototype);function jf(a,b,c){kf(this,a,b,c)}
function kf(a,b,c,d){J.call(a);a.Ra=!0;a.id=b;a.canvas=Oe(document.body);a.canvas.style.position="absolute";a.canvas.style.border="none";a.ma=a.canvas.getContext("2d");a.Ob=c;a.width=32;a.height=500;a.canvas.width=a.width;a.canvas.height=a.height;p(a.canvas).bind("click",function(b){a.vb(b)});p(a.canvas).bind("mousedown",function(b){a.La(b)});d.bind(p(document.body),"mousemove",function(b){a.Na(b)});d.bind(p(document.body),"mouseup",function(b){a.Oa(b)});p(a.canvas).bind("touchstart",function(b){a.Wa(b)});
d.bind(p(document.body),"touchmove",function(b){a.Wa(b)});d.bind(p(document.body),"touchend",function(b){a.Wa(b)});a.$=null;a.Pa=!1;a.sa="#c0c0c0";a.oa="#808080";a.borderWidth=1;a.ha=0;a.ba=100;a.la=10;a.position=5;a.format()}m=jf.prototype;m.log=t("SCROLLBAR",!0);m.moveTo=function(a,b){this.canvas.style.left=""+a+"px";this.canvas.style.top=""+b+"px"};m.Zb=function(a,b){this.width=a;this.height=b;this.canvas.width=this.width;this.canvas.height=b;this.format();this.na()};
m.Ma=function(){this.canvas.style.display="none"};m.show=function(){this.canvas.style.display="block"};m.format=function(){var a;a=this.Ob?this.width:this.height;var b=this.la/this.ba*a;a=(this.position-this.ha)/this.ba*a;this.$=this.Ob?new L(a,0,b-1,this.height-1):new L(0,a,this.width-1,b-1);this.$.x=Math.round(this.$.x)+.5;this.$.y=Math.round(this.$.y)+.5;this.$.width=Math.round(this.$.width);this.$.height=Math.round(this.$.height)};
m.na=function(){this.ma.beginPath();this.ma.fillStyle=this.sa;this.ma.strokeStyle=this.oa;this.ma.lineWidth=this.borderWidth;this.ma.rect(this.borderWidth/2,this.borderWidth/2,this.width-this.borderWidth,this.height-this.borderWidth);this.ma.fill();this.ma.stroke();this.ma.beginPath();this.ma.fillStyle=this.oa;this.ma.strokeStyle="#000000";this.ma.rect(this.$.x,this.$.y,this.$.width,this.$.height);this.ma.fill();this.ma.stroke()};
function lf(a,b){var c=p(a.canvas).offset();if("touchstart"===b.type||"touchend"===b.type||"touchmove"===b.type)b=b.changedTouches[0];return new y(b.pageX-c.left,b.pageY-c.top)}m.Wa=function(a){switch(a.type){case "touchstart":this.La(a);break;case "touchend":this.Oa(a);break;case "touchmove":this.Na(a)}};m.vb=function(){};function mf(a,b){var c;c=a.Ob?b.x/a.width*a.ba+a.ha:b.y/a.height*a.ba+a.ha;c=Math.min(c,a.ba-a.la+a.ha);return c=Math.max(c,a.ha)}
m.La=function(a){a.preventDefault();a=lf(this,a);this.$.Ub(a.x,a.y)?this.Ob?(this.offset=a.x-this.$.x,a.x-=this.offset):(this.offset=a.y-this.$.y,a.y-=this.offset):(this.position=mf(this,a),this.offset=0,this.Ob?this.$.x=(this.position-this.ha)/this.ba*this.width:this.$.y=(this.position-this.ha)/this.ba*this.height,this.emit("scroll",this.position),this.na());this.Pa=!0};
m.Na=function(a){this.Pa&&(this.Pa&&"mousemove"===a.type&&("buttons"in a&&0===a.buttons||0===a.which)?this.Pa=!1:(a.preventDefault(),a=lf(this,a),this.Ob?a.x-=this.offset:a.y-=this.offset,this.position=mf(this,a),this.emit("scroll",this.position),this.format(),this.na()))};m.Oa=function(){this.Pa&&(this.Pa=!1)};function nf(a){return a.Ob?a.height:a.width}jf.prototype=p.$({},J.prototype,jf.prototype);function of(a,b){this.ia=a;this.canvas=document.createElement("canvas");this.height=this.width=b;this.canvas.width=this.width;this.canvas.height=this.height;this.canvas.style.cursor="crosshair";this.sa=0;this.ia.appendChild(this.canvas);"G_vmlCanvasManager"in window&&window.G_vmlCanvasManager.initElement(this.canvas);this.ma=this.canvas.getContext("2d");var c=document.createElement("input");c.setAttribute("type","range");this.la=document.createElement("input");this.la.setAttribute("type","checkbox");
"range"===c.type?(this.ia.appendChild(document.createElement("br")),this.ia.appendChild(c),c.min=0,c.max=255,c.value=255,this.ba=c):(this.ba=null,c="colourcheckbox"+this.sa,this.la.setAttribute("id",c),this.ia.appendChild(document.createElement("br")),this.ia.appendChild(this.la),this.sa+=1,c=p("<label>").ab("for",c).text("Transparent"),this.ia.appendChild(c[0]));this.$=this.height;this.ha=.8*this.height;if(of[b])this.data=of[b];else{for(var c=this.ma.getImageData(0,0,this.$,this.$),d=this.$/2,e=
this.ha/2,f,g=0;g<this.$;g++){var h=Math.sqrt(d*d-(g-d)*(g-d)),k=Math.floor(-h+d),l=Math.floor(h+d),n=e*e-(g-d)*(g-d);if(0<=n){for(var h=Math.sqrt(n),n=Math.floor(-h+d),q=Math.floor(h+d),h=g*this.$*4+4*k;k<=n;k++)f=Math.atan2(g-d,k-d),f=new W(2,[f/Math.PI*180,1,1,1]),f=Le(f,0),c.data[h++]=255*f.values[0],c.data[h++]=255*f.values[1],c.data[h++]=255*f.values[2],c.data[h++]=255;h=g*this.$*4+4*q;k=q}else h=g*this.$*4+4*k;for(;k<=l;k++)f=Math.atan2(g-d,k-d),f=new W(2,[f/Math.PI*180,1,1,1]),f=Le(f,0),c.data[h++]=
255*f.values[0],c.data[h++]=255*f.values[1],c.data[h++]=255*f.values[2],c.data[h++]=255}this.data=c;of[b]=c}this.aa=new W(2,[20,1,1,1]);this.update();this.na();var r=this;r.Da=!1;r.oa="";Ka(p(this.canvas),function(a){var b=p(r.canvas).offset(),c=a.pageX-b.left,b=a.pageY-b.top;r.Da=!0;pf(r,c,b);a.stopPropagation();a.preventDefault()});Ia(p(this.canvas),function(a){if(r.Da){var b=p(r.canvas).offset();pf(r,a.pageX-b.left,a.pageY-b.top)}a.stopPropagation();a.preventDefault()});Ja(function(){r.Da=!1;r.oa=
""});null!==this.ba&&Ea(p(this.ba),function(){r.aa.values[3]=r.ba.value/255;r.update();r.na()});Ea(p(this.la),function(){r.aa.values[3]=r.la.checked?0:1;r.update();r.na()})}
of.prototype={update:function(){this.Ka&&this.Ka(this.aa.toString())},na:function(){this.ma.save();this.ma.lineWidth=1;this.ma.fillStyle="rgb(128, 128, 128)";this.ma.fillRect(0,0,this.width,this.height);this.ma.putImageData(this.data,0,0);var a=this.aa.values[0]/180*Math.PI;this.ma.beginPath();var b={x:Math.cos(a)*this.ha/2+this.$/2,y:Math.sin(a)*this.ha/2+this.$/2},c={x:Math.cos(a+2*Math.PI/3)*this.ha/2+this.$/2,y:Math.sin(a+2*Math.PI/3)*this.ha/2+this.$/2},d={x:Math.cos(a+4*Math.PI/3)*this.ha/2+
this.$/2,y:Math.sin(a+4*Math.PI/3)*this.ha/2+this.$/2},e=Math.cos(a)*this.$/2+this.$/2,a=Math.sin(a)*this.$/2+this.$/2,f=c.x+(d.x-c.x)/2,g=c.y+(d.y-c.y)/2;this.ma.moveTo(b.x,b.y);this.ma.lineTo(c.x,c.y);this.ma.lineTo(d.x,d.y);this.ma.lineTo(b.x,b.y);var h=this.ma.createLinearGradient(c.x,c.y,d.x,d.y);h.addColorStop(0,"#ffffff");h.addColorStop(1,"#000000");this.ma.fillStyle=h;this.ma.fill();h=this.ma.createLinearGradient(b.x,b.y,f,g);f=Le(this.aa,2);f.values[1]=1;f.values[2]=1;f=Le(f,0);f.values[3]=
1;h.addColorStop(0,f.toString());f.values[3]=0;h.addColorStop(1,f.toString());this.ma.fillStyle=h;this.ma.fill();this.strokeStyle="#000000";this.ma.beginPath();this.ma.moveTo(b.x,b.y);this.ma.lineTo(e,a);this.ma.stroke();a=1-this.aa.values[2];e=this.aa.values[1]*b.x+a*d.x+(1-this.aa.values[1]-a)*c.x;a=this.aa.values[1]*b.y+a*d.y+(1-this.aa.values[1]-a)*c.y;this.ma.beginPath();this.ma.arc(e,a,4,0,2*Math.PI,!1);this.ma.stroke();this.ma.restore();this.Ra=b;this.Ya=c;this.cb=d}};
function pf(a,b,c){var d=Math.sqrt((b-a.$/2)*(b-a.$/2)+(c-a.$/2)*(c-a.$/2));if("ring"===a.oa||"triangle"!==a.oa&&d>=a.ha/2&&d<=a.$/2)a.aa.values[0]=Math.atan2(a.$/2-c,a.$/2-b)/Math.PI*180+180,0===a.aa.values[1]&&(a.aa.values[1]=1,a.aa.values[2]=1),a.oa="ring";else{var e,f=a.Ra,d=a.Ya,g=a.cb;e=(f.x-g.x)*(d.y-g.y)-(d.x-g.x)*(f.y-g.y);d=((d.y-g.y)*(b-g.x)-(d.x-g.x)*(c-g.y))/e;b=1-Math.max(0,d)-Math.max(0,(-(f.y-g.y)*(b-g.x)+(f.x-g.x)*(c-g.y))/e);a.aa.values[1]=Math.min(Math.max(d,0),1);a.aa.values[2]=
1-Math.min(Math.max(b,0),1);a.oa="triangle"}0===a.aa.values[3]&&(a.aa.values[3]=1,null!==a.ba&&(a.ba.value=255));a.na();a.update()}function qf(a,b){a.aa=Le(Qd(b),2);null!==a.ba&&(a.ba.value=Math.round(255*a.aa.values[3]));a.la.checked=0===a.aa.values[3]?!0:!1;a.na();a.update()}function rf(){var a=document.createElement("canvas");"G_vmlCanvasManager"in window&&window.G_vmlCanvasManager.initElement(a);return a.getContext&&a.getContext("2d").getImageData};function sf(){return"localStorage"in window&&null!==window.localStorage}var tf={};function uf(a,b,c,d){this.view=a;this.Ba=this.Aa=0;this.Pa=!1;this.$=b;this.La(c,d)}
uf.prototype={log:t("SELECT"),Wa:function(a){"touchmove"===a.type?(a=vf(this.view,a.changedTouches[0]),this.Na(a.x,a.y)):"touchend"===a.type&&(a=vf(this.view,a.changedTouches[0]),this.Oa(a.x,a.y))},La:function(a,b){this.Aa=a;this.Ba=b;this.Pa=!0},Na:function(a,b){if(this.Pa){var c=this.view.ma,d=this;this.view.na(function(){c.save();c.strokeStyle="#0050B7";c.lineWidth=2/d.view.scale;c.fillStyle="rgba(0, 80, 183, 0.2)";var e=new L(d.Aa+.5,d.Ba+.5,a-d.Aa,b-d.Ba);c.fillRect(e.x,e.y,e.width,e.height);
c.strokeRect(e.x,e.y,e.width,e.height);c.restore()})}},Oa:function(a,b){this.Pa=!1;this.view.Za();for(var c=this.view,d=xe(c.ka,new L(this.Aa,this.Ba,a-this.Aa,b-this.Ba)),e=0;e<d.length;e++)Cd(c,d[e]);P(this.view);this.view.na();this.view.pa=this.$}};function gb(a){this.view=a;Td(this.view,"");this.Kb=this.view.fa.Kb();this.ha=1;this.Kb&&(this.ha=2)}
gb.prototype={log:t("DefaultBehaviour"),Gb:function(){this.log("Entering pick tool.");this.view.canvas.style.cursor="default"},Jb:function(){this.log("Leaving pick tool.")},Wa:function(a){for(var b,c=0;c<a.touches.length;c++){b=a.touches[c];b=x(this.view,b.pageX,b.pageY);if("touchstart"===a.type)return this.La(b.x,b.y,a);if("touchend"===a.type)return this.Oa(b.x,b.y)}return!1},La:function(a,b,c){var d,e;this.log("onMouseDown");if(this.view.fa.get("readOnly"))(d=this.view.ka.gb(a,b,this.view.Ja))?
(this.log("layer=%s active=%s",qd(d),this.view.Ja),this.view.ua.emit("node-clicked",d.id)):this.log("readOnly mode: Ignoring click.");else{d=this.view;if(d.Ca)e=null;else{e=d.qe/d.scale;for(var f=null,g=Number.MAX_VALUE,h=0;h<d.Da.length;h++){var k=d.Da[h],l=Cb(k.x,k.y,a,b);l<e&&l<g&&(g=l,f=k)}e=f}if(e)C(this.view,new Dc(this.view,e,!1,a,b));else{if(d=this.view.selection.length)d=this.view,g=wf(d),h=p(d.canvas).offset(),f=nf(d.$),"changedTouches"in c?(e=c.changedTouches[0].pageX-h.left-g,g=c.changedTouches[0].pageY-
h.top-g):(e=c.pageX-h.left-g,g=c.pageY-h.top-g),h=d.nb,d=d.Ka&&e>h.width-d.Ka.width-f&&g<d.Ka.height;d&&xf(this.view);if(this.view.Ca&&(d=this.view.Ca,e=d.Id(a,b,1/this.view.scale*this.ha),null!==e)){C(this.view,new eb(this.view,d,e,a,b));return}if(d=this.view.ka.gb(a,b,this.view.Ja))this.log("layer=%s active=%s",qd(d),this.view.Ja),this.view.ua.emit("node-clicked",d.id);if(d&&qd(d)===this.view.Ja)e=d===this.view.Ca,f=d.wb===this.view.wb,this.log("wasEditNode: %s, wasSelected: %s",e,f),f||(c.shiftKey||
this.view.Za(),Cd(this.view,d),P(this.view)),C(this.view,new Dc(this.view,this.view.xc?new gd(d,d.Ua()):new hd,!e&&f,a,b));else if(c=this.view,c.selection.length&&c.bd.Ub(a,b))C(this.view,new Dc(this.view,this.view.xc?new gd(this.view.selection[0],this.view.selection[0].Ua()):new hd,!0,a,b));else if(c=this.view.fa,"auto"===c.ra.allowSelectBox?(d=c.Kb(),e=document.documentElement.clientHeight,f=window.innerHeight,g=!d||d&&0<f-e+50,c.log("Allowing select box: %s (useTouch=%s, documentHeight=%s, windowHeight=%s)",
g,d,e,f),c=g):c=c.ra.allowSelectBox,c)this.view.Ca=null,C(this.view,new uf(this.view,this,a,b));else return this.log("Disabled select box -- mobile touch active."),this.view.Ca=null,this.view.Za(),P(this.view),this.view.na(),!1}}},Oa:function(){this.log("onMouseUp")},ub:function(a,b){this.log("keyboard: %s",a);var c=!0,d=this.view.fa.get("nudge");b&&b.ctrlKey&&(d=this.view.fa.get("preciseNudge"));switch(a){case "bring-to-front":this.view.Bc();break;case "send-to-back":this.view.Rc();break;case "left":yf(this.view,
-1,0,d)||(this.view.Ha=Math.min(this.view.Ha+16,0),H(this.view),this.view.na());break;case "right":yf(this.view,1,0,d)||(d=this.view.nb.width,this.view.Ha=Math.max(-(d*this.view.scale-d),this.view.Ha-16),H(this.view),this.view.na());break;case "up":yf(this.view,0,-1,d)||(this.view.Ga=Math.min(this.view.Ga+16,0),H(this.view),this.view.na());break;case "down":yf(this.view,0,1,d)||(d=this.view.nb.height,this.view.Ga=Math.max(-(d*this.view.scale-d),this.view.Ga-16),H(this.view),this.view.na());break;
case "select-none":this.view.Za();P(this.view);this.view.na();this.view.Ea.fb&&this.view.qb.emit("goto-toolbar");break;case "select-all":var e=[];qe(this.view.ka,function(a){e.push(a)});this.view.selectNodes(e);this.view.na();this.view.Ea.fb&&this.view.qb.emit("goto-toolbar");break;case "duplicate":this.view.duplicate();break;case "move-up":this.view.pd();break;case "move-down":this.view.od();break;case "delete":xf(this.view);break;case "curve-tool":zf(this.view);break;case "line-tool":Af(this.view);
break;case "group":this.view.group();break;case "ungroup":this.view.Zc();break;case "undo":this.view.Va();break;case "redo":this.view.Sb();break;case "cut":this.view.Ed();break;case "copy":this.view.dc();break;case "paste":this.view.Jc();break;case "zoom-normal":this.view.fa.get("allowZoom")?(d=Bf(this.view),this.view.scale=1,this.view.Ha=-d.x,this.view.Ga=-d.y,H(this.view),this.view.na()):this.log("Zooming is disabled.");break;case "zoom-in":this.view.fa.get("allowZoom")?this.view.cd():this.log("Zooming is disabled.");
break;case "zoom-out":this.view.fa.get("allowZoom")?this.view.dd():this.log("Zooming is disabled.");break;default:c=!1}c&&(b.preventDefault(),b.stopPropagation())},Bb:function(a){var b;a.$c?(this.view.Xa=a.Sa,this.view.ib=a.Sa,b="fillStyle"):(this.view.bb=a.Sa,b="strokeStyle");this.view.setProperty(b,a.Sa)},Qb:function(a,b){b?(this.view.Xa=Rc(this.view.Xa,a),this.view.ib=Rc(this.view.ib,a)):this.view.bb=Rc(this.view.bb,a);Yc(this.view,a,b)},hc:function(a,b){this.log("onDoubleClick");var c=this.view.ka.gb(a,
b,this.view.Ja);this.log("hittest: %s, hasText: %s",null!==c,null!==c&&c.Hd());this.view.ua.emit("double-click",a,b,c?c.id:null);c&&"PathNode"===c.type()&&!this.view.fa.get("allowTextInShape")?this.log("Editing text in shape is disabled."):c&&c.Hd()&&(this.log("Text double-clicked."),Cf(this.view),Xc(this.view.pa,c,a,b))},Nb:function(){return"pick"}};for(var Df,Ef=[],Ff=0;4>Ff;Ff++)Ef.push(String.fromCharCode(">2$-".charCodeAt(Ff)^"zwibbler3".charCodeAt(Ff%9)));Df=Ef.join("");for(var Gf,Hf=[115,116,114,111,107,101,84,101,120,116],If=[],Jf=0;Jf<Hf.length;Jf++)If.push(String.fromCharCode(Hf[Jf]));Gf=If.join("");
function Kf(a,b,c,d,e,f,g,h){this.fa=e;this.te=f;this.aa=c;this.qb=d;this.sb=h;this.canvas=a[0];this.ma=this.canvas.getContext("2d");this.ua=g;this.Ra=!0===e.get("pageView");Lf(this);this.Ea={fb:!1,Pa:!1,Cd:!1,x:100,y:100};this.pa=new gb(this);this.ic=null;this.ba=new jf("horizontal",!0,this.sb);this.canvas.parentNode.appendChild(this.ba.canvas);this.$=new jf("vertical",!1,this.sb);this.canvas.parentNode.appendChild(this.$.canvas);this.sa="none";this.cb=0;this.xc=this.zc=this.Rb=!0;this.Da=[];this.Ja=
"default";this.jc=Mf(this);this.nb=new bc(this.canvas.width/this.jc,this.canvas.height/this.jc);var k=this;this.request=new xb;this.request.canvas=this.canvas;this.request.on("reformat",function(a){k.log("Node %s requests reformat",a.id);a.id in k.ka.za&&(k.log("   Reformatting... zoom=%s",k.sa),Qc(k.ka,a.id),k.update(),Nf(k),k.ua.emit("resource-loaded"))});this.request.on("convert-dom-request",function(a,b){k.ua.emit("convert-dom-request",b,a)});this.Ca=this.la=null;e.on("useTouch",function(){e.Kb()?
(k.Ka=document.createElement("img"),k.Ka.setAttribute("src",X(e,"wd-trash.png")),k.qe=16):(k.Ka=null,k.qe=8)});this.$.on("scroll",function(a){k.Ga=-a*k.scale;k.na()});this.ba.on("scroll",function(a){k.Ha=-a*k.scale;k.na()});Of(this);Pf(this,b);(a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)?(this.log("Using requestAnimationFrame"),this.ed=a):this.log("Emulating requestAnimationFrame");this.Yc=!1;this.Ib=null;this.fa.on("update",function(a,b){k.Ic(a,
b)});this.sb.bind(p(document),"webkitfullscreenchange",function(){0<=navigator.userAgent.search("Safari")&&0>navigator.userAgent.search("Chrome")&&(k.log("SAFARI WORKAROUND: Disabling requestAnimationFrame."),k.ed=Kf.prototype.ed)});this.Ya=!1;G(this)}
Kf.prototype={log:t("VIEW"),ed:function(a){a()},Vc:function(a,b){this.ka.Vc(a,b);b||a!==this.Ja||(this.Za(),P(this));this.na()},Ic:function(a,b){var c=!1;switch(a){case "allowResize":Lc(this);this.na();break;case "defaultBrushColour":this.ib=b;this.pa&&void 0!==this.pa.de&&this.pa.Sc(b);break;case "defaultFillStyle":this.Xa=this.va.fillStyle=b;break;case "defaultStrokeStyle":this.bb=b;this.va.strokeStyle=b;break;case "defaultLineWidth":this.va.lineWidth=b;break;case "defaultFont":this.va.fontName=
b;break;case "defaultBold":this.va.bold=b;break;case "defaultItalic":this.va.italic=b;break;case "defaultFontSize":this.va.fontSize=b;break;case "defaultTextFillStyle":this.va.textFillStyle=b;break;case "defaultTextStokeStyle":this.va.textStrokeStyle=b;break;case "defaultTextLineWidth":this.va.textLineWidth=b;break;case "defaultBrushWidth":this.tb=b;if(this.pa&&this.pa.de){var d=this.pa;d.$.lineWidth=b;Ad(d,b/2)}break;case "defaultZoom":Qf(this,b);break;case "pageView":this.Ra=b;c=!0;break;case "pagePlacement":Qf(this,
this.sa);break;case "snap":case "background":case "gridSpacing":case "gridBlocks":case "gridColour":Of(this);c=!0;break;case "pageShadow":case "symmetry":case "outsidePageColour":c=!0;break;case "readOnly":!0===b&&(G(this),this.Za(),P(this),c=!0),this.ka.yc(b)}this.pa.Ic&&this.pa.Ic(a,b);c&&this.na()},ub:function(a,b){var c;if(this.Ea.fb){var d=0,e=0,f=this.fa.get("nudge");switch(a){case "right":d=f;break;case "left":d=-f;break;case "down":e=f;break;case "up":e=-f;break;case "enter":this.pa.vb?(this.Ea.Pa=
!1,c="click"):(this.Ea.Pa=!this.Ea.Pa,c=this.Ea.Pa?"mousedown":"mouseup")}if(d||e)c=this.nb,this.Ea.x+=d,this.Ea.x=Math.max(this.Ea.x,0),this.Ea.x=Math.min(c.width,this.Ea.x),this.Ea.y+=e,this.Ea.y=Math.max(this.Ea.y,0),this.Ea.y=Math.min(c.height,this.Ea.y),this.na(),c="mousemove";c?(b.preventDefault(),b.stopPropagation(),this.na(),e=p(this.canvas).offset(),d=this.Ea.x+e.left,e=this.Ea.y+e.top,this.log("Simulate a %s at (%s,%s)",c,d,e),f=document.createEvent("MouseEvents"),f.initMouseEvent(c,!0,
!0,window,0,d,e,d,e,!1,!1,!1,!1,this.Ea.Pa?1:0,null),this.canvas.dispatchEvent(f),c=!0):c=!1}else c=!1;if(!c){this.pa.ub&&this.pa.ub(a,b);switch(a){case "next-page":this.lb(this.ka.ob+1);break;case "previous-page":this.lb(this.ka.ob-1);break;case "zoom-to-page":this.fa.get("allowZoom")&&Qf(this,"page");break;case "zoom-to-width":this.fa.get("allowZoom")&&Qf(this,"width")}b.preventDefault();b.stopPropagation()}},Kf:function(){return this.Ea.fb},Ta:function(a){var b=this.fa.get("snap"),c;0<b?(c=Math.round(a.x/
b)*b,a=Math.round(a.y/b)*b):(c=a.x,a=a.y);return new y(c,a)},pd:function(){var a=Rf(this);a.length&&this.ya([new be(a,fe)])},od:function(){var a=Rf(this);a.length&&this.ya([new be(a,ee)])},Bc:function(){var a=Rf(this);a.length&&this.ya([new be(a,ce)])},Rc:function(){var a=Rf(this);a.length&&this.ya([new be(a,de)])},setProperty:function(a,b){var c=Rf(this,!0);this.va[a]=b;if(c.length){var d=[new Zc(c,a,b)];if("fillStyle"===a)for(var e=0;e<c.length;e++){var f=A(this.ka,c[e]);this.log("nodeType=%s closed=%s",
f.type(),f.qa("closed"));"PathNode"===f.type()&&!1===f.qa("closed")&&d.push(new Zc([c[e]],"strokeStyle",b))}this.ya(d)}0<this.selection.length&&"lineWidth"===a&&"BrushNode"===this.selection[0].type()?this.tb=b:"textFillStyle"===a&&(this.va.textFillStyle=b)},group:function(){var a=Rf(this);a.length&&this.ya([new Yd(a)])},Zc:function(){var a=Rf(this);a.length&&this.ya([new Zd(a)])},Za:function(){0<this.selection.length&&(this.wb+=1,this.selection.length=0,this.log("Clear selection. selectGeneration=%s",
this.wb));null!==this.oa&&this.ua.emit("selected-edit-handle",null,null);this.Ca&&(this.log("Clear selection."),this.oa=this.Ca=null)},selectNodes:function(a){this.Za();for(var b=0;b<a.length;b++)a[b].qa("locked")||"PageNode"===a[b].type()||Cd(this,a[b]);P(this)},ya:function(a,b){if(this.fa.get("readOnly"))this.log("readOnly mode: Ignoring change.");else{var c=this.ka.ya(a,b);this.log("Commit added %s nodes",c.zb.length);var d;this.ka.format(this.ma,this.request);if(c.zb.length){var e=[];for(d=0;d<
c.zb.length;d++)e.push(A(this.ka,c.zb[d]));this.fa.get("autoPickTool")&&this.selectNodes(e)}else if(this.selection.length||this.Ca){e=0;this.wb+=1;for(d=0;d<this.selection.length;d++)d!==e&&(this.selection[e]=this.selection[d]),this.selection[e].id in this.ka.za&&(this.selection[e].wb=this.wb,e++);this.selection.length!==e&&(this.selection.length=e);!this.Ca||this.Ca.id in this.ka.za||(this.log("EditNode %s no longer exists",this.Ca.id),this.Ca=null,null!==this.oa&&this.ua.emit("selected-edit-handle",
null,null),this.oa=null);0!==this.selection.length||this.Ca||this.Za();P(this)}Nf(this);this.na();this.ua.emit("document-changed");c.zb.length&&this.ua.emit("nodes-added",c.zb);c.$b.length&&this.ua.emit("nodes-changed",c.$b);c.Yb.length&&this.ua.emit("nodes-removed",c.Yb)}},update:function(a,b){if(this.ka.format(this.ma,this.request)||a)Lc(this),this.na(b)},qd:function(){var a=p(this.canvas),b=a.offset(),c=p(this.canvas.parentNode).offset(),d=a.width(),a=a.height(),e=b.left-c.left,b=b.top-c.top,c=
wf(this);this.$.moveTo(e+d-20+c,b+c);this.$.Zb(20,a-20);this.ba.moveTo(e+c,b+a-20+c);this.ba.Zb(d-20,20);Nf(this);this.na()},na:function(a){if(!Sf(this)&&(this.Ib=a,!this.Yc)){this.Yc=!0;var b=this;this.ed.call(window,function(){b.Yc=!1;var a=Mf(b);a!==b.jc&&(b.log("Detected DPR change; resize canvas now"),Tf(b,b.nb.width,b.nb.height),b.jc=a);var d=Uf(b),e=d.x,f=d.y,g=d.width,h=d.height;b.ma.setTransform(1,0,0,1,0,0);b.ma.clearRect(0,0,b.canvas.width,b.canvas.height);b.Ra&&(b.ma.fillStyle=b.fa.get("outsidePageColour"),
b.ma.fillRect(0,0,b.canvas.width,b.canvas.height));b.ma.scale(a,a);b.ma.translate(b.Ha,b.Ga);b.ma.scale(b.scale,b.scale);d=new E(b.Ha,b.Ga);d=d.multiply(new nc(b.scale,b.scale));b.ma.ac=d;b.log("translateX=%s translateY=%s",b.Ha,b.Ga);b.log("Set drawmatrix to %s",d);b.Ra?(e=b.ma,f=se(b.ka),e.beginPath(),e.fillStyle="#FFFFFF",b.fa.get("pageShadow")&&(e.shadowOffsetX=3/b.scale,e.shadowOffsetY=3/b.scale,e.shadowBlur=5/b.scale,e.shadowColor="rgba(0,0,0,1.0)"),e.rect(0,0,f.width,f.height),e.fill(),e.shadowColor=
"rgba(0,0,0,0.0)",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0,Vf(b,e,0,0,f.width,f.height),b.la&&b.la(e,0,0,f.width,f.height)):b.la?(b.ma.save(),b.la(b.ma,e,f,g,h),b.ma.restore()):Vf(b,b.ma,e,f,Math.max(g,g-e),Math.max(h,h-e));e=Bd(b);f=b.fa.ra.symmetry;if(1<f){g=2*Math.PI/f;h=b.Ta(new y(b.canvas.width/a/2,b.canvas.height/a/2));f&1&&(d=new oc(g,h.x,h.y));for(b.ma.save();g<2*Math.PI-1E-8;)0===(f&1)&&(d=new pc(g,h.x,h.y)),b.ma.transform(d.m11,d.m21,d.m12,d.m22,d.Aa,d.Ba),b.ka.na(b.ma),g+=2*Math.PI/
f;b.ma.setTransform(1,0,0,1,0,0);b.ma.fillStyle="rgba(255,255,255,0.3)";b.ma.fillRect(0,0,b.canvas.width,b.canvas.height);b.ma.restore()}b.ka.na(b.ma);b.ua.Ib&&(b.ma.save(),b.ua.Ib(b.ma),b.ma.restore());if(0<b.selection.length){b.ma.save();d=b.ma;d.lineWidth=1/b.scale;d.strokeStyle="#888888";d.beginPath();for(f=0;f<b.selection.length;f++)h=b.selection[f],g=h.Ua(),h=new uc(h.Fb),h.transform(g),wc(h,d,[3/b.scale,3/b.scale]);d.stroke();g=b.scale;for(f=0;f<b.Da.length;f++){var h=b.Da[f],k=b.lc.apply(h.x,
h.y);h instanceof Ec?b.ad&&(d.beginPath(),d.strokeStyle="#008000",d.lineWidth=3/g,d.moveTo(k.x,k.y),d.arc(k.x,k.y,6/g,0,1.5*Math.PI,!1),d.stroke()):(d.beginPath(),d.strokeStyle="#000",d.lineWidth=1/g,d.rect(k.x-4/g,k.y-4/g,4/g*2,4/g*2),d.stroke())}b.ma.restore()}e&&b.ma.restore();b.Ca&&b.Ca.Fd(b.ma,1/b.scale,b.oa);b.Ab&&b.fa.get("showHints")&&(b.ma.save(),b.ma.font=10/b.scale+"px Arial",b.ma.fillStyle="#000000",b.ma.textBaseline="top",b.ma.fillText(b.Ab,0,0),b.ma.restore());e=b.ma;b.Ea.fb&&(d=b.Ea.x,
f=b.Ea.y,g=Mf(b),e.save(),e.setTransform(g,0,0,g,0,0),e.beginPath(),b.Ea.Cd?(e.moveTo(d-3,f-10),e.lineTo(d+3,f-10),e.moveTo(d-3,f+10),e.lineTo(d+3,f+10),e.moveTo(d,f-10),e.lineTo(d,f+10)):(e.moveTo(d,f-3),e.lineTo(d,f-15),e.moveTo(d,f+3),e.lineTo(d,f+15),e.moveTo(d-3,f),e.lineTo(d-15,f),e.moveTo(d+3,f),e.lineTo(d+15,f)),b.Ea.Pa&&b.ma.arc(d,f,8,0,2*Math.PI,!1),e.lineWidth=2,e.strokeStyle="#000000",e.stroke(),e.restore());b.pa.he&&b.pa.he(b.ma);b.Ib&&b.Ib(b.ma);b.ua.rc("draw",b.ma);0<b.selection.length&&
b.Ka&&(b.ma.setTransform(1,0,0,1,0,0),b.ma.drawImage(b.Ka,b.canvas.width-b.Ka.width-nf(b.$),0));b.ma.setTransform(a,0,0,a,0,0);b.ma.beginPath();b.ma.font="20px Arial";g=b.ma.measureText(Df).width;a=b.canvas.width/a/g;b.ma.scale(a,a);b.ma.textBaseline="top";b.ma.lineWidth=4/a;b.ma.strokeStyle="rgba(128, 128, 128, 0.1)";b.ma[Gf](Df,0,0)})}},Va:function(){if(this.fa.get("readOnly"))this.log("readOnly mode: Ignoring undo.");else if(this.ka.cc()){var a=this.ka.Va();this.ka.format(this.ma,this.request);
Wf(this);Lc(this);Nf(this);H(this);this.na();this.ua.emit("document-changed");a.zb.length&&this.ua.emit("nodes-added",a.zb);a.$b.length&&this.ua.emit("nodes-changed",a.$b);a.Yb.length&&this.ua.emit("nodes-removed",a.Yb)}},Sb:function(){if(this.fa.get("readOnly"))this.log("readOnly mode: Ignoring redo.");else if(this.ka.bc()){var a=this.ka.Sb();this.ka.format(this.ma,this.request);Wf(this);Lc(this);Nf(this);H(this);this.na();this.ua.emit("document-changed");a.zb.length&&this.ua.emit("nodes-added",
a.zb);a.$b.length&&this.ua.emit("nodes-changed",a.$b);a.Yb.length&&this.ua.emit("nodes-removed",a.Yb)}},Ed:function(){this.dc();xf(this)},dc:function(a){var b=Jc(this);if(0!==b.length){var c;c=this.ka;var d,e,f,g,h;d=[];e=0;h=oe(c,b);f=0;for(g=h.length;f<g;f++)b=h[f],e=ve(c,b,d,e);c="zwibblerclip."+JSON.stringify(d);!0!==a&&(sf()?window.localStorage.setItem("clipboard",c):tf.clipboard=""+c);this.log("Reset paste offset to 0");this.cb=0;return c}},duplicate:function(){var a=Rf(this);0<a.length&&this.ya([new ae(a,
10)])},Jc:function(a){var b=[];a||(a=sf()?window.localStorage.getItem("clipboard"):tf.clipboard);a=ue(this.ka,a,b);var c=this.fa.get("pasteOffset");0!==c&&(this.cb+=c,this.log("Using paste offset %s",this.cb),c=new E(this.cb,this.cb),a.push(new Hc(b,c,c.inverse())));this.ya(a);this.update()},sc:function(){return Se(this.canvas)},Bb:function(a,b){this.pa.Bb?(this.log("Simulating click of colour %s",a),this.pa.Bb({Sa:a,$c:b})):this.log("A colour is not needed for this tool.")},lb:function(a){this.ka.lb(a)&&
(this.Za(),P(this),this.na(),this.ua.emit("set-page",a))},cd:function(){Qf(this,1.1*this.scale)},dd:function(){Qf(this,this.scale/1.1)}};function Sf(a){a.Ya&&a.log("Updates are locked. Ignoring draw/format request");return a.Ya}function Xf(a,b){!a.Ya&&b?(a.log("Locking updates."),a.Ya=!0):a.Ya&&!b&&(a.log("Resuming updates"),a.Ya=!1,Nf(a),H(a),a.na())}function Uf(a){var b=a.nb;return new L((0-a.Ha)/a.scale,(0-a.Ga)/a.scale,b.width/a.scale,b.height/a.scale)}
function Tf(a,b,c){var d=Mf(a);a.canvas.width=b*d;a.canvas.height=c*d;a.canvas.style.width=b+"px";a.canvas.style.height=c+"px";a.nb.width=b;a.nb.height=c}function Mf(a){var b,c;b=window.devicePixelRatio||1;c=a.ma.Lg||a.ma.Hg||a.ma.Ig||a.ma.Jg||a.ma.Gg||1;var d=b/c;a.log("devicePixelRatio=%s backingStoreRatio=%s combined=%s",b,c,d);return d}
function Yf(a,b,c,d){if(!d)if(0===b.length)d=new y(0,0);else{d=b[0].kb().clone();for(var e=1;e<b.length;e++)jc(d,b[e].kb());d=hc(d)}c=new pc(c,d.x,d.y);a.ya([new Hc(Zf(a,b),c,c.inverse())])}function $f(a,b){var c,d;c=a.ka.hb;d=a.Ta(new y(100,100));d=new E(d.x,d.y);a.ya([new D("ImageNode",{url:b,layer:a.Ja}),new Hc([c],d,d.inverse())]);return G(a)}
function ag(a,b){b=p.$({},{commands:Rd(),fillStyle:a.Xa,strokeStyle:a.bb,seed:Math.round(65535*Math.random()),lineWidth:a.va.lineWidth,sloppiness:a.va.sloppiness,layer:a.Ja,wrap:a.fa.get("multilineText"),fontSize:a.fa.get("defaultFontSize")},b);var c;c="radial"===a.fa.get("drawCircleStyle")?"circle":"rectangle";C(a,new Oc(a,"PathNode",b,100,100,c))}
function bg(a,b){b=b||{};var c,d,e,f,g;e=new N;f=new y(-50,-50);g=new y(50,-50);d=new y(50,50);c=new y(-50,50);e.moveTo(f.x,f.y);e.lineTo(g.x,g.y);e.lineTo(d.x,d.y);e.lineTo(c.x,c.y);e.lineTo(f.x,f.y);e.close();b=p.$({},{commands:e.Eb(),fillStyle:a.Xa,strokeStyle:a.bb,seed:Math.round(65535*Math.random()),lineWidth:a.va.lineWidth,sloppiness:a.va.sloppiness,layer:a.Ja,wrap:a.fa.get("multilineText"),fontSize:a.fa.get("defaultFontSize")},b);a.log("Create an item on layer %s",a.Ja);C(a,new Oc(a,"PathNode",
b,100,100,"rectangle"))}function yf(a,b,c,d){if(a.xc)return b*=d/a.scale,c*=d/a.scale,a.log("Nudge selection by %s, %s",b,c),d=Rf(a),d.length&&(b=new E(b,c),a.ya([new Hc(d,b,b.inverse())])),0<d.length;a.log("Can't nudge; selection motion is locked.")}function cg(a,b,c,d){a.log("Set document size %s,%s",b,c);null===b&&(b=void 0);null===c&&(c=void 0);d?d.push(new ge({width:b,height:c})):(a.ka.setProperty("width",b),a.ka.setProperty("height",c),H(a),Nf(a),a.ua.emit("document-changed"))}
function H(a){if(!Sf(a))if(a.fa.get("scrollbars")){var b=a.nb,c=Bf(a),d=Uf(a),e=!1,f=!1;if(d.y<=c.y&&d.bottom()>=c.bottom())a.$.Ma();else{a.$.show();var e=a.$,g=Math.min(d.y,c.y),h=Math.max(d.bottom(),c.bottom()),k=d.height,l=-a.Ga/a.scale;e.ha=g;e.ba=h-g;e.la=k;e.position=l;e.format();e.na();e=!0}d.x<=c.x&&d.right()>=c.right()?a.ba.Ma():(a.ba.show(),f=a.ba,g=Math.min(d.x,c.x),c=Math.max(d.right(),c.right()),d=d.width,h=-a.Ha/a.scale,f.ha=g,f.ba=c-g,f.la=d,f.position=h,f.format(),f.na(),f=!0);f&&
e?(a.$.Zb(20,b.height-20),a.ba.Zb(b.width-20,20)):e?a.$.Zb(20,b.height):f&&a.ba.Zb(b.width,20)}else a.$.Ma(),a.ba.Ma()}function Bf(a){a.Ra?(a=se(a.ka),a=new L(0,0,a.width,a.height),a.Pb(20,20)):a=te(a.ka);return a}function dg(a,b,c){a.fa.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):C(a,new Sd(a,"arrow",void 0,b,c))}function zf(a,b){a.fa.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):C(a,new Sd(a,"curve",void 0,b))}
function eg(a,b,c){a.fa.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(b.lineWidth=b.lineWidth||a.tb,b.strokeStyle=b.strokeStyle||a.ib,C(a,new zd(a,0,b,c)))}function fg(a,b){a.fa.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(b.lineWidth=b.lineWidth||a.tb,b.strokeStyle=b.strokeStyle||a.ib,C(a,new zd(a,0,b,"shapebrush")))}
function gg(a,b){a.fa.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(b.lineWidth=b.lineWidth||a.tb,b.strokeStyle=b.strokeStyle||a.ib,C(a,new zd(a,0,b,"brush")))}function Af(a,b,c){a.fa.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):C(a,new Sd(a,"line",void 0,b,c))}function Cf(a){a.fa.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):C(a,new Vc(a))}function C(a,b){a.pa&&a.pa.Jb&&a.pa.Jb();a.pa=b;b.Gb&&b.Gb();b.Nb&&a.ua.emit("tool-changed",b.Nb())}
function G(a){C(a,new gb(a))}function Td(a,b){b?(a.Ab=a.te.get(b),a.ua.emit("hint",a.Ab)):(a.Ab=null,a.ua.emit("hint",""))}function Bd(a){if(a.Ra){var b=se(a.ka);a.ma.save();a.ma.beginPath();a.ma.rect(0,0,b.width,b.height);a.ma.clip()}return a.Ra}function Nf(a){if(!Sf(a)){var b=Bf(a),c=a.nb,c=new L(0,0,c.width,c.height);b.Wb(a.se)&&c.Wb(a.re)?a.log("No need to rezoom."):Qf(a,a.sa)?(a.log("Successfully rezoomed."),a.se=b,a.re=c):a.log("Failed to zoom")}}
function Vf(a,b,c,d,e,f){a.background?(b.fillStyle=a.ma.createPattern(a.background,"repeat"),b.fillRect(c,d,e,f)):a.la?a.la(b,c,d,e,f):"G_vmlCanvasManager"in window&&(b.fillStyle="rgba(0, 0, 0, 0.0)",b.fillRect(c,d,e,f))}
function Of(a){var b=a.fa.get("snap"),c=null,d,e;d=a.fa.get("background");var f=Qd(d,!0);a.la=null;if("grid"===d){var c=a.fa.get("gridBlocks"),b=a.fa.get("gridSpacing"),g=c*b,c=Oe(document.body);c.width=g;c.height=g;d=c.getContext("2d");d.beginPath();for(e=0;e<g;e+=b)e%g&&(d.moveTo(e+.5,0),d.lineTo(e+.5,g));for(e=0;e<g;e+=b)e%g&&(d.moveTo(0,e+.5),d.lineTo(g,e+.5));d.strokeStyle=a.fa.get("gridColour");d.lineWidth=.5;d.stroke();d.beginPath();for(e=0;e<=g;e+=g)d.moveTo(e,0),d.lineTo(e,g);for(e=0;e<=
g;e+=g)d.moveTo(0,e+.5),d.lineTo(g,e+.5);d.lineWidth=2;d.stroke()}else f?(a.log("Using background colour %s",f.toString()),a.la=function(a,b,c,d,e){a.fillStyle=f.toString();a.fillRect(b,c,d,e)}):0<b&&"clear"!==d&&(c=Oe(document.body),c.width=b,c.height=b,d=c.getContext("2d"),d.beginPath(),d.moveTo(0,0),d.arc(0,0,3,0,2*Math.PI,!1),d.moveTo(b,0),d.arc(b,0,3,0,2*Math.PI,!1),d.moveTo(b,b),d.arc(b,b,3,0,2*Math.PI,!1),d.moveTo(0,b),d.arc(0,b,3,0,2*Math.PI,!1),d.fillStyle="#c0c0c0",d.fill());c&&document.body.removeChild(c);
a.background=c}function Rf(a,b){var c=Jc(a);b||(c=oe(a.ka,c));return Zf(a,c)}function Zf(a,b){for(var c=[],d=0;d<b.length;d++)a.log("Selected id=%s",b[d].id),c.push(b[d].id);return c}function Jc(a){var b=a.selection.concat();a.Ca&&b.push(a.Ca);for(var c=0;c<b.length;c++)a.log("Selected node=%s",b[c].id);return b}
function Wf(a){for(var b=0,c=0;c<a.selection.length;c++)c!==b&&(a.selection[b]=a.selection[c]),a.selection[b].id in a.ka.za&&(b+=1);a.selection.length!==b&&(a.selection.length=b);!a.Ca||a.Ca.id in a.ka.za||(a.Ca=null,null!==a.oa&&a.ua.emit("selected-edit-handle",null,null),a.oa=null)}
function Lc(a){function b(a,b,c,d,e){!1!==f.Rb&&f.Da.push(new fd(a,c,new y(b.x+d*b.width,b.y+e*b.height),new y(b.x+(1-d)*b.width,b.y+(1-e)*b.height)))}var c;a.Rb=!0;a.zc=!0;a.xc=!0;var d=!1;a.Da.length=0;if(0!==a.selection.length){a.ha=a.selection[0].kb().clone();a.selection[0].qa("lockSize")&&(a.Rb=!1);a.selection[0].qa("lockRotation")&&(a.zc=!1);a.log("lockPosition: %s",a.selection[0].qa("lockPosition"));a.selection[0].qa("lockPosition")&&(a.xc=!1);a.selection[0].qa("lockAspectRatio")&&(d=!0);for(c=
1;c<a.selection.length;c++)jc(a.ha,a.selection[c].kb()),a.selection[c].qa("lockSize")&&(a.Rb=!1),a.selection[c].qa("lockRotation")&&(a.zc=!1),a.selection[c].qa("lockAspectRatio")&&(d=!0),a.selection[c].qa("lockPosition")&&(a.xc=!1);1===a.selection.length?a.bd=a.selection[0].Yd():a.bd=new Bc(a.ha);var e,f=a,g,h=0<a.fa.get("snap");a.log("snap=%s",a.fa.get("snap"));1<a.selection.length?(e=new M,g=null,c=a.ha):(g=a.selection[0],c=g.Fb,e=g.Ua());a.fa.get("allowResize")&&(d||(b(g,c,e,.5,0),b(g,c,e,1,.5),
b(g,c,e,.5,1),b(g,c,e,0,.5)),b(g,c,e,0,0),b(g,c,e,1,0),b(g,c,e,1,1),b(g,c,e,0,1));if(a.zc)if(g&&g.qa("rotationHandles"))for(a=g.qa("rotationHandles"),c=0;c<a.length;c+=4)f.Da.push(new Ec(g,e,new y(a[c],a[c+1]),new y(a[c+2],a[c+3]),h));else f.Da.push(new Ec(g,e,new y(c.x+.5*c.width,c.y-10/a.scale),new y(c.x+.5*c.width,c.y+.5*c.height),h))}}
function P(a){Lc(a);if(a.ic){var b=a.ic,c=a.selection;b.action=null;b.$.length=0;b.aa={};b.za=c.concat();for(var d=!1,e=0;e<c.length;e++){var f=c[e];od(f)&&(d=!0);var g=nd(f),h;for(h in g)if(g.hasOwnProperty(h)){var k=b,l=h,n=f,q=void 0,q=k.fa;l in k.aa?(q=k.aa[l],q.value!==n.qa(l)&&(q.value=null)):"locked"===l||"points"===l||!0===n.qa("closed")&&("arrowSize"===l||"arrowStyle"===l||"doubleArrow"===l)||!1===n.qa("closed")&&("fontName"===l||"fontSize"===l||"textFillStyle"===l||"text"===l||"fillStyle"===
l)||"ImageNode"===n.type()&&("fillStyle"===l||"strokeStyle"===l||"lineWidth"===l||"shadow"===l)||"BrushNode"===n.type()&&"fillStyle"===l||"TextNode"===n.type()&&"fillStyle"===l||"lockSize"===l||"lockRotate"===l||"rotateAround"===l||"layer"===l||0===l.indexOf("cell-")||"fontName"===l&&!q.get("showFontNameProperty")||"fontSize"===l&&!q.get("showFontSizeProperty")||"smoothness"===l&&!q.get("showSmoothnessProperty")||"sloppiness"===l&&!q.get("showSloppinessProperty")||(q={Ld:hg(k,n,l),value:n.qa(l)},
q.Ld.display&&0===q.Ld.display.indexOf("Display-")||(k.$.push(q),k.aa[l]=q))}}ig(b);if(b.fa.get("showKeyboardHelp"))for(f=d,d=Na(p("<div>"),"keydiv"),d.da("font-size","8pt"),d.da("color","#909090"),d.da("font-weight","normal"),p(b.ia).append(d),g=b.la.fc(),d.append("<h1>"+g("keyboard")+"</h1>"),e=[{key:b.fa.get("keyCurveTool"),description:g("draw-curves")},{key:b.fa.get("keyLineTool"),description:g("draw-lines")}],0<c.length&&e.push({key:b.fa.get("keyDelete"),description:g("delete-selection")},{key:b.fa.get("keyDuplicate"),
description:g("duplicate-selection")},{key:b.fa.get("keyMoveUp"),description:g("move-selection-closer")},{key:b.fa.get("keyMoveDown"),description:g("move-selection-away")}),1<c.length&&e.push({key:b.fa.get("keyGroup"),description:g("group-selection")}),f&&e.push({key:b.fa.get("keyUngroup"),description:g("break-apart-group")}),e.push({key:b.fa.get("keyZoomIn"),description:g("zoom-in")}),e.push({key:b.fa.get("keyZoomOut"),description:g("zoom-out")}),e.push({key:g("arrow-keys"),description:g("move-while-zoomed")}),
b=0;b<e.length;b++)c=Na(p("<a>").text(e[b].key),"key"),c.da("background","#d0d0d0"),c.da("border-left","1px solid #808080"),c.da("border-right","1px solid #e0e0e0"),c.da("border-top","1px solid #808080"),c.da("border-bottom","1px solid #e0e0e0"),c.da("padding-left","0.5em"),c.da("padding-right","0.5em"),c.da("margin-right","1em"),c.da("color","#4fa0d3"),c.da("font-weight","bold"),c=p("<p>").append(c),c[0].appendChild(document.createTextNode(e[b].description)),d.append(c)}a.ua.emit("selected-nodes")}
function Cd(a,b){a.Ca=null;if(b.wb!==a.wb&&qd(b)===a.Ja){a.selection.push(b);b.wb=a.wb;if(od(b)){for(var c=b.parent,d=0;d<c.children.length;d++)Cd(a,c.children[d]);Cd(a,c)}b.children&&0<b.children.length&&Cd(a,b.children[0])}}function xf(a){var b=Rf(a);b.length&&a.ya([new Xd(b)])}
function Yc(a,b,c){a.log("setSelectionOpacity(%s, fill=%s)",b,c);var d=Rf(a,!0),e=[];c=c?"fillStyle":"strokeStyle";for(var f=0;f<d.length;f++){var g=d[f],h=A(a.ka,g).qa(c);h&&(h=Rc(h,b),e.push(new Zc([g],c,h)),a.log("   set %s of %s to %s",c,g,h))}e.length&&a.ya(e);a.log("   Affected %s of %s nodes",e.length,d.length)}
function ed(a){a.Ea.fb=!0;a.Ea.Cd=!1;if(0<a.selection.length){a.log("showKeyboardCursorAndStartMoving()");a.Ea.Pa=!0;var b=hc(a.ha);a.Ea.x=b.x;a.Ea.y=b.y;G(a);C(a,new Dc(a,new gd(a.selection[0],a.selection[0].Ua()),!1,b.x-4,b.y-4))}a.na()}
function Lf(a){var b=wf(a),c=new Date;p(a.canvas).bind("touchstart",function(b){if(a.pa.Wa){var d=!0;300<(new Date).getTime()-c.getTime()?d=!1!==a.pa.Wa(b.eb):a.pa.hc&&(d=vf(a,b.eb.touches[0]),d=!1!==a.pa.hc(d.x,d.y,b.eb));d&&(b.stopPropagation(),b.preventDefault());c=new Date}});p(a.canvas).bind("touchmove",function(b){a.pa.Wa&&!1!==a.pa.Wa(b.eb)&&(b.stopPropagation(),b.preventDefault())});p(a.canvas).bind("touchend",function(b){a.pa.Wa&&!1!==a.pa.Wa(b.eb)&&(b.stopPropagation(),b.preventDefault())});
p(a.canvas).bind("gesturestart",function(b){a.log("GestureStart");a.pa.uc&&!1!==a.pa.uc(b.eb)&&(b.stopPropagation(),b.preventDefault())});p(a.canvas).bind("gesturechange",function(b){a.log("GestureChange");a.pa.uc&&!1!==a.pa.uc(b.eb)&&(b.stopPropagation(),b.preventDefault())});p(a.canvas).bind("gestureend",function(b){a.log("GestureEnd");a.pa.uc&&!1!==a.pa.uc(b.eb)&&(b.stopPropagation(),b.preventDefault())});var d=new y(0,0),e=0,f=!1;p(a.canvas).bind("pointerdown",function(c){a.log("PointerDown");
d=new y(c.pageX,c.pageY);e=(new Date).getTime();f=!0;if(a.pa.La){var g=p(a.canvas).offset();!1!==a.pa.La((c.pageX-g.left-b-a.Ha)/a.scale,(c.pageY-g.top-b-a.Ga)/a.scale,c.eb)&&(c.stopPropagation(),c.preventDefault())}});p(a.canvas).bind("pointermove",function(c){if(a.pa.Na){var d=p(a.canvas).offset();!1!==a.pa.Na((c.pageX-d.left-b-a.Ha)/a.scale,(c.pageY-d.top-b-a.Ga)/a.scale,c.eb)&&(c.stopPropagation(),c.preventDefault())}});a.sb.bind(p(document),"pointerup",function(c){a.log("PointerUp");var g,l;
a.pa.Oa&&f&&(g=p(a.canvas).offset(),l=(c.pageX-g.left-b-a.Ha)/a.scale,g=(c.pageY-g.top-b-a.Ga)/a.scale,!1!==a.pa.Oa(l,g,c.eb)&&(c.stopPropagation(),c.preventDefault()));f=!1;a.log("TimeDist=%s PixelDist=%s",(new Date).getTime()-e,d.pb(new y(c.pageX,c.pageY)));a.pa.vb&&200>(new Date).getTime()-e&&2>d.pb(new y(c.pageX,c.pageY))&&(a.log("Simulate mouseclick from pointerup"),g=p(a.canvas).offset(),l=(c.pageX-g.left-b-a.Ha)/a.scale,g=(c.pageY-g.top-b-a.Ga)/a.scale,!1!==a.pa.vb(l,g,c.eb)&&(c.stopPropagation(),
c.preventDefault()))});Ia(p(a.canvas),function(c){if(a.pa.Na){var d=p(a.canvas).offset();a.pa.Na((c.pageX-d.left-b-a.Ha)/a.scale,(c.pageY-d.top-b-a.Ga)/a.scale,c)}c.preventDefault()});Ka(p(a.canvas),function(c){var d=p(a.canvas).offset();f=!0;a.pa.La&&a.pa.La((c.pageX-d.left-b-a.Ha)/a.scale,(c.pageY-d.top-b-a.Ga)/a.scale,c);c.preventDefault()});a.sb.bind(p(document),"mouseup",function(c){var d=p(a.canvas).offset();a.pa.Oa&&f&&a.pa.Oa((c.pageX-d.left-b-a.Ha)/a.scale,(c.pageY-d.top-b-a.Ga)/a.scale,
c);f=!1;c.stopPropagation();c.preventDefault()});p(a.canvas).click(function(c){var d=p(a.canvas).offset();a.pa.vb&&a.pa.vb((c.pageX-d.left-b-a.Ha)/a.scale,(c.pageY-d.top-b-a.Ga)/a.scale,c);c.stopPropagation();c.preventDefault()});Ha(p(a.canvas),function(c){var d=p(a.canvas).offset();if(a.pa.hc||a.pa.vb){var e=(c.pageX-d.left-b-a.Ha)/a.scale,d=(c.pageY-d.top-b-a.Ga)/a.scale;Re()&&a.pa.vb&&(a.log("Insert false mouse click for IE"),a.pa.vb(e,d));a.pa.hc&&a.pa.hc(e,d,c)}c.stopPropagation();c.preventDefault()});
p(a.canvas).bind("mouseenter",function(a){a.stopPropagation();a.preventDefault()});p(a.canvas).bind("mouseleave",function(a){a.stopPropagation();a.preventDefault()});p(a.canvas).bind("mouseover",function(a){a.stopPropagation();a.preventDefault()});p(a.canvas).bind("mouseout",function(a){a.stopPropagation();a.preventDefault()});!window.parent&&a.fa.get("setFocus")&&p(a.canvas).focus();a.aa.bind("colour",function(b){a.pa.Bb&&a.pa.Bb(b)});a.aa.bind("opacity",function(b,c){a.pa.Qb&&a.pa.Qb(b,c)});var g=
"mousewheel";"onwheel"in document.createElement("div")&&(g="wheel");a.log("Binding to '%s' for mouse wheel",g);p(a.canvas).bind(g,function(c){var d=c.eb.wheelDelta||-40*c.eb.deltaY,e=d/120*32,f=p(a.canvas).offset(),g=(c.pageX-f.left-b-a.Ha)/a.scale,f=(c.pageY-f.top-b-a.Ga)/a.scale;a.pa.Kd&&!1!==a.pa.Kd(g,f,e,c.eb)||"block"!==a.$.canvas.style.display||(g=Bf(a),a.Ga=-120>=d?Math.max(a.Ga+e,-(g.bottom()*a.scale-a.canvas.height)):Math.min(a.Ga+e,-g.y*a.scale),H(a),a.na(),c.stopPropagation(),c.preventDefault())})}
function vf(a,b){return x(a,b.pageX,b.pageY)}function bd(a,b,c){var d=wf(a),e=p(a.canvas).offset();return new y(b*a.scale+a.Ha+e.left+d,c*a.scale+a.Ga+e.top+d)}function x(a,b,c){var d=wf(a),e=p(a.canvas).offset();return a.Ta(new y((b-e.left-d-a.Ha)/a.scale,(c-e.top-d-a.Ga)/a.scale))}
function Qf(a,b){var c;a.log("Zooming to: %s",b);var d=a.nb,e=d.width-20;c="width"in a.ka.ga;var f=!0;a.sa=b;c||(a.log("WARNING: Cannot zoom to page/width because the document size has not been set."),f=!1);if(T(b))a.scale=b;else if("none"===b||a.ka.empty()||!c)a.scale=1;else if("page"===b){c=Bf(a);var g=e=0;a.scale=Math.min(d.width/c.width,d.height/c.height);a.scale*c.width<d.width&&(e+=(d.width-a.scale*c.width)/2/a.scale);a.scale*c.height<d.height&&(g+=(d.height-a.scale*c.height)/2/a.scale);"centre"===
a.fa.get("pagePlacement")&&(a.Ha=-(c.x-e)*a.scale);a.Ga=-(c.y-g)*a.scale;a.log("RECT=%s scale=%s tx=%s",c,a.scale,a.Ha);a.sa=b}else"width"===b&&(c=Bf(a),a.scale=e/c.width,a.Ha=-c.x*a.scale,a.Ga=-c.y*a.scale,a.log("RECT=%s scale=%s tx=%s ty=%s",c,a.scale,a.Ha,a.Ga),a.sa=b);H(a);a.na();return f}function jg(a,b,c){a.va[b]=c;"fillStyle"===b?a.Xa=c:"strokeStyle"===b&&(a.bb=c)}
function Pf(a,b){a.log("setDocument()");G(a);a.ka=b;a.scale=1;a.Ha=0;a.Ga=0;a.selection=[];a.Ca=null;a.oa=null;a.wb=1;a.ha=new L(0,0,0,0);a.bd=new Bc(a.ha);a.lc=new M;a.ad=!0;a.Ab=null;a.Ja="default";a.Xa="#ffffff";a.ib=a.fa.ra.defaultBrushColour;a.bb=a.fa.ra.defaultStrokeStyle;a.va={};a.va.lineWidth=a.fa.ra.defaultLineWidth;a.va.sloppiness=.5;a.va.fontName=a.fa.ra.defaultFont;a.va.fontSize=a.fa.ra.defaultFontsize;a.va.bold=a.fa.ra.defaultBold;a.va.italic=a.fa.ra.defaultItalic;a.va.smoothness=.3;
a.va.textFillStyle=a.fa.ra.defaultTextFillStyle;a.va.textStrokeStyle=a.fa.ra.defaultTextStrokeStyle;a.va.textLineWidth=a.fa.ra.defaultTextLineWidth;a.tb=a.fa.get("defaultBrushWidth");var c=Bf(a);a.Ha=-c.x;a.Ga=-c.y;H(a);a.ka.sb=a.fa.get("spotHighlightColour");a.ka.tb=a.fa.get("spotHighlightZIndex");a.ka.format(a.ma,a.request);a.se=new L(0,0,0,0);a.re=new L(0,0,0,0);"none"!==a.sa?Qf(a,a.sa):(Qf(a,a.fa.get("defaultZoom")),a.na())}
function wf(a){return parseInt(p(a.canvas).da("border-left-width"),10)||0};function kg(a,b){this.methods=b;this.view=a}
kg.prototype={log:t("CustomToolBehaviour"),Gb:function(){this.log("Entering CustomToolBehaviour");this.methods.enter&&this.methods.enter()},Jb:function(){this.log("Leaving CustomToolBehaviour");this.methods.leave&&this.methods.leave()},vb:function(a,b,c){return this.methods.onMouseClick?this.methods.onMouseClick(a,b,c):!1},La:function(a,b,c){return this.methods.onMouseDown?this.methods.onMouseDown(a,b,c):!1},Na:function(a,b,c){return this.methods.onMouseMove?this.methods.onMouseMove(a,b,c):!1},Oa:function(a,
b,c){return this.methods.onMouseUp?this.methods.onMouseUp(a,b,c):!1},hc:function(a,b,c){return this.methods.onDoubleClick?this.methods.onDoubleClick(a,b,c):!1},Bb:function(a){return this.methods.onColour?this.methods.onColour(a.Sa):!1},ub:function(a){this.log("keyboard: %s",a);"cancel"===a&&(this.log("ESC pressed. Abort brush and go back to toolbar."),G(this.view),this.view.qb.emit("goto-toolbar"))},Wa:function(a){if(this.methods.onTouch)return this.methods.onTouch(a);var b;b=a.touches[0];b=x(this.view,
b.pageX,b.pageY);return"touchstart"===a.type?this.La(b.x,b.y,a):"touchend"===a.type?this.Oa(b.x,b.y,a):"touchmove"===a.type?this.Na(b.x,b.y,a):!1},Kd:function(a,b,c,d){return this.methods.onMouseWheel?this.methods.onMouseWheel(a,b,c,d):!1},Nb:function(){return this.methods.getToolName?this.methods.getToolName():null}};function lg(a,b){this.$=a;this.name=b;this.ia=p("<div>").da("border-top","1px solid #888").da("padding","5px").da("cursor","default");this.$.append(this.ia);this.update(0)}lg.prototype={update:function(a){this.ia.text(this.name+"... "+Math.round(100*a)+"%")},error:function(a){var b=this,c=Ma();c.click(function(){b.done()});Oa(this.ia,this.name+"... "+a+" ");this.ia.append(c)},done:function(){this.ia.remove()}};function mg(a){for(var b=[],c=0;c<a;c++)b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890"[Math.floor(63*Math.random())]);return b.join("")}"object"===typeof module&&(exports.Fg=mg);function ng(a){function b(b){c&&clearTimeout(c);c=setTimeout(function(){c=null;a()},arguments.length?b:1E3)}var c=null;b.cancel=function(){c&&(clearTimeout(c),c=null)};return b};function og(a){a=a.replace(/\+/g," ");return window.decodeURIComponent?window.decodeURIComponent(a):unescape(a)}function pg(){var a;a=a||window.location.hash;0===a.indexOf("#/")&&(a="#"+a.substr(2));var b=a,c,d,e,f;a={};e=b.indexOf("#");0<=e&&(b=b.substr(e+1));e=b.indexOf("#");0<=e&&(b=b.substr(0,e));b=b.split("&");e=0;for(f=b.length;e<f;e++)c=b[e],d=c.split("="),c=og(d[0]),d=1<d.length?og(d[1]):"",c.length&&(a[c]=d);return a};var qg,rg,sg;sg=document.getElementsByTagName("script");rg=sg[sg.length-1];qg=void 0!==rg.getAttribute.length?rg.src:rg.getAttribute("src",-1);
function tg(a){var b,c;this.ra={angleArcs:0,allowSelectBox:"auto",allowResize:!0,allowTextInShape:!0,allowZoom:!0,autoPickTool:!0,background:"clear",backgroundImage:null,colourPicker:"wheel",colourPalette:"#000000 #ffffff #000088 #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" "),debug:!1,defaultArrowStyle:"simple",defaultArrowSize:15,defaultItalic:!1,defaultBold:!1,defaultBrushColour:"#000000",defaultBrushWidth:10,defaultFillStyle:"#e0e0e0",
defaultFont:"Arial",defaultFontSize:20,defaultLineWidth:2,defaultPaperSize:"none",defaultRoundRectRadius:10,defaultSmoothness:"smooth",defaultStrokeStyle:"#000000",defaultText:"Lorum ipsum dolor",defaultTextFillStyle:"#000000",defaultTextStrokeStyle:"#000000",defaultTextLineWidth:0,defaultZoom:1,drawCircleStyle:"radial",fonts:["Arial","Times New Roman"],gridBlocks:10,gridSpacing:20,gridColour:"#cccccc",imageFolder:"$SCRIPT",iPadNoScrollText:!1,keyBringToFront:"Home",keyCancel:"ESC",keyCopy:"Ctrl+C,\u2318+C",
keyCurveTool:"C",keyCut:"Ctrl+X,\u2318+X,Shift+Delete",keyDelete:"Delete,Backspace",keyDown:"Down,Ctrl+Down",keyDuplicate:"Ctrl+D",keyEnter:"Enter",keyGroup:"Ctrl+G",keyLeft:"Left,Ctrl+Left",keyLineTool:"L",keyMoveDown:"PageDown",keyMoveUp:"PageUp",keyNext:"Down,Right",keyNextPage:"Shift+PageDown",keyPaste:"Ctrl+V,\u2318+V,Shift+Insert",keyPrevious:"Left,Up",keyPreviousPage:"Shift+Pageup",keyRedo:"Ctrl+Shift+Z",keyRight:"Right,Ctrl+Right",keySelectNone:"ESC",keySelectAll:"Ctrl+A",keySendToBack:"End",
keyUndo:"Ctrl+Z",keyUngroup:"Ctrl+Shift+G",keyUp:"Up,Ctrl+Up",keyZoomIn:"+,Shift+=",keyZoomNormal:"=",keyZoomOut:"-",keyZoomToPage:"F4",keyZoomToWidth:"Shift+F4",language:"en",multilineText:!1,nudge:10,outsidePageColour:"#808080",pagePlacement:"centre",pageSelectorDiv:"",pageShadow:!0,pageView:!1,pasteOffset:10,persistent:!1,preciseNudge:1,readOnly:!1,scrollbars:!0,setFocus:!0,showArrowTool:!0,showBackgroundSelector:!1,showBrushTool:!0,showCircleTool:!0,showColourPanel:!0,showCopyPaste:!0,showCurveTool:!0,
showDebug:!1,showFontNameProperty:!0,showFontSizeProperty:!0,showHints:!0,showImageSelector:!1,showImageTool:!1,showKeyboardHelp:!0,showLineTool:!0,showMathTool:!1,showMoveToFrontBack:!1,showPageSelector:!1,showPageSelectorControls:!0,showPickTool:!0,showPropertyPanel:!1,showRoundRectTool:!1,showShapeBrushTool:!1,showSloppinessProperty:!0,showSmoothnessProperty:!0,showSquareTool:!0,showTextTool:!0,showToolbar:!0,showUndoRedo:!0,singleStrokeBrush:!1,sloppy:!1,snap:0,spotHighlightColour:"rgba(0,0,0,0.2)",
spotHighlightZIndex:0,symmetry:0,textMode:"interactive",toolbarButtonSize:50,useTouch:"auto",enableArrowKeysNudge:!1,showMenu:!1};for(c in a)a.hasOwnProperty(c)&&(c in this.ra||alert("Zwibbler: Unknown option '"+c+"'"),this.ra[c]=a[c]);a=pg();for(c in a)a.hasOwnProperty(c)&&ug(this,c,a[c]);""===vg()?(this.$=this.ra.imageFolder.replace("$SCRIPT/",""),this.$=this.$.replace("$SCRIPT","")):this.$=this.ra.imageFolder.replace("$SCRIPT",vg());""!==this.$&&"/"!==this.$[this.$.length-1]&&(this.$+="/");"auto"===
this.ra.useTouch&&(c="ontouchstart"in window||"onmsgesturechange"in window,this.log("Detected touch support: %s",c));for(b in this.ra)this.ra.hasOwnProperty(b)&&this.log("%s=%s",b,this.ra[b])}
tg.prototype={log:t("CONFIG"),on:function(a,b){b(a,this.ra[a],!0);return J.prototype.on.call(this,a,b)},eg:function(){return this.ra.showBrushTool},pe:function(){return this.ra.showPropertyPanel},fg:function(){return this.ra.showColourPanel},gg:function(){return this.ra.showToolbar},get:function(a){return this.ra[a]},Kb:function(){return"auto"===this.ra.useTouch?"ontouchstart"in window||"onmsgesturechange"in window:this.ra.useTouch}};
function wg(a,b){for(var c in a.ra)if(a.ra.hasOwnProperty(c)&&0===c.indexOf("key")){for(var d="",e=0;e<c.length;e++)var f=c.charAt(e),d=f===f.toUpperCase()?d+("-"+f.toLowerCase()):d+f;b.map(a.ra[c],d.substr(4))}}function xg(a){a=a.get("pageSelectorDiv");return void 0!==a.className?a:""!==a&&p(a).length?p(a)[0]:null}function X(a,b){return 0===b.indexOf("http:")||0===b.indexOf("https:")||0===b.indexOf("/")?b:a.$+b}
function vg(){var a,b;b=qg;a=b.lastIndexOf("/");0<=a?b=b.substr(0,a+1):b="";return b}
function ug(a,b,c){if(!(b in a.ra))return a.log("Error: %s is not a configuration option.",b),!1;if("defaultZoom"===b){if("page"!==c&&"width"!==c&&!T(c)&&(c=parseFloat(c),isNaN(c)))return a.log("Error: Config option %s must be a number or 'page' or 'width'",b),!1}else if("allowSelectBox"!==b&&"string"===typeof c)if("number"===typeof a.ra[b]){if(c=parseFloat(c),isNaN(c))return a.log("Error: Config option %s expects a number",b),!1}else"boolean"===typeof a.ra[b]&&(c="1"===c||"true"===c||""===c);a.log("Set config %s=%s",
b,c);a.ra[b]=c;a.rc("update",b,c);a.rc(b,c);return!0}tg.prototype=p.$({},J.prototype,tg.prototype);function yg(a){zg(this,a)}function zg(a,b){a.ia=b||p("<div>");a.ia.da("position","absolute");a.ia.da("margin","0px");a.ia.da("padding","0px");p("body").append(a.ia)}m=yg.prototype;m.width=function(a){function b(a){a=parseInt(c.ia.da(a),10);return isNaN(a)?0:a}var c=this;if(void 0===a)return this.ia.outerWidth();a-=b("border-left-width");a-=b("border-right-width");a-=b("padding-right");a-=b("padding-left");a-=b("margin-left");a-=b("margin-right");a=Math.max(0,a);this.ia.da("width",""+a+"px")};
m.height=function(a){function b(a){a=parseInt(c.ia.da(a),10);return isNaN(a)?0:a}var c=this;if(void 0===a)return this.ia.outerHeight();a-=b("border-top-width");a-=b("border-bottom-width");a-=b("padding-top");a-=b("padding-bottom");a-=b("margin-top");a-=b("margin-bottom");this.ha=a=Math.max(0,a);this.ia.da("height",""+this.ha+"px")};m.moveTo=function(a,b){null!==a&&this.ia.da("left",""+a+"px");null!==b&&this.ia.da("top",""+b+"px")};m.show=function(){this.ia.show()};m.Ma=function(){this.ia.Ma()};function Ag(a,b){yg.apply(this,arguments);var c=this;this.ia.da("background","black");this.ia.da("font-family",'"Lucida Console","Dejavu Sans Mono",Monospace,"Courier New"');this.ia.da("font-size","10px");this.ia.da("line-height","12px");this.ia.da("overflow","scroll");this.ia.da("cursor","default");this.oa=0;this.la={};this.fb=!1;this.sa=ma(function(a,b){return Bg(c,a,b)});b.add(function(){for(var a=c.sa,b=0;b<la.length;b++)if(la[b]===a){la.splice(b,1);break}});this.ba=null;this.aa=[];Bg(this,"DEBUG",
"Debug window starting")}Ag.prototype={$:"#ffffff #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" "),show:function(){yg.prototype.show.call(this);this.fb=!0;Cg(this);this.ia[0].scrollTop=this.ia[0].scrollHeight},Ma:function(){this.fb=!1;yg.prototype.Ma.call(this)}};
function Cg(a){var b,c,d,e,f,g;g=a.aa;e=0;for(f=g.length;e<f;e++){c=g[e];d=c.key;c=c.Nf;b=a;var h=d;h in b.la||(b.la[h]=b.$[b.oa],b.oa=(b.oa+1)%b.$.length);b=b.la[h];b=p("<div>").da("color",b);b.da("border-bottom","1px solid #222");b.text(""+d+": "+c);a.ia.append(b)}a.ia[0].scrollTop=a.ia[0].scrollHeight;a.ba=null;a.aa.length=0}function Bg(a,b,c){var d,e,f;f=c.split("\n");d=0;for(e=f.length;d<e;d++)c=f[d],a.aa.push({key:b,Nf:c});a.fb&&null===a.ba&&(a.ba=setTimeout(function(){return Cg(a)},100))}
Qb(yg.prototype,Ag.prototype);function Dg(a){var b=p("<div>");zg(this,b);a.append(this.ia);this.oa={};this.aa=128;this.$=0;this.ia.da("overflow-x","auto");this.ia.da("overflow-y","auto");this.sa=0;this.la=1;this.ba=[];this.Da=null}
Dg.prototype={on:function(a,b){this.oa[a]=b},log:t("ListView"),format:function(){var a,b,c,d,e;b=null;e=this.ba;c=0;for(d=e.length;c<d;c++){a=e[c];if(!a.be){if(null===b){b=this.ia;var f=a.Qa,f=Ba(f);0<b.length?b[0].insertBefore(f[0],b[0].firstChild):b[0].appendChild(f[0])}else Pa(b.Qa,a.Qa);a.be=!0}b=a}}};function Eg(a){a.ia.empty();a.ba.length=0;a.la+=1}
function Fg(a,b,c,d){var e,f;f=a.la;e={Qa:null,index:a.sa,be:!1};a.sa+=1;pb(b,function(b){var h,k;f===a.la&&(k=b.width,h=b.height,a.aa&&k>a.aa&&(b.width=a.aa,b.height=h/k*a.aa),a.$&&h>a.$&&(b.width=a.$/(h/k),b.height=a.$),b=p(b),b.da("margin","2px"),b.da("border-width","3"),b.da("border-color","white"),b.da("border-style","solid"),b.da("image-rendering","optimizeQuality"),Ga(b,function(){a.log("Mouseenter");return b.da("border-color","#888888")}),Fa(b,function(){return b.da("border-color","white")}),
b.click(function(){if("click"in a.oa)return a.oa.click(c)}),d&&b.ab("title",d),e.Qa=b,a.ba.push(e),a.ba.sort(function(a,b){return a.index-b.index}),a.Da||(a.Da=setTimeout(function(){a.Da=null;a.format()},500)))})}Dg.prototype=p.$({},yg.prototype,Dg.prototype);function Gg(a,b,c){this.fa=a;this.la=b;this.sa=c;zg(this,p("<div>"));Na(this.ia,"PropertyPanel");this.$=[];this.aa={};this.view=null;this.za=[];(this.oa=rf()&&"wheel"===a.get("colourPicker"))||this.log("ColourWheel not supported in this canvas.");this.action=null;this.ia.da("background","#ffffff");this.ia.da("border","none");this.ia.da("font-family","tahoma,arial,helvetica,sans");this.ia.da("color","#4fa0d3");this.ia.da("font-weight","bold");this.ia.da("font-size","10pt");this.ia.da("overflow-y",
"scroll");var d=this;this.ia.click(function(){d.log("PropertyPanel clicked.");d.emit("click")});this.ba=null}Gg.prototype={log:t("PROP"),on:function(a,b){if("click"===a)this.ba=b;else throw"This object only handles the click event";},emit:function(){this.ba&&this.ba()},apply:function(a,b){this.view.setProperty(a,b)}};function Hg(a,b,c,d){null!==a.action&&a.action.name===d.name||a.view.setProperty(d.name,b);c.value=b}
function Ig(a,b){if(!b.$d)if(a.oa){var c=document.createElement("div"),d=new of(c,120);qf(d,b.input.value);d.Ka=function(c){Hg(a,c,b.input,b.input.Db)};b.zg=d;b.$d=!0;b.parentNode.appendChild(c)}else{c=new Xe(p(b.parentNode),20,!1,!0);c.ia.da("position","static");$e(c,a.fa.get("colourPalette"));b.zg=c;b.$d=!0;b.parentNode.appendChild(c.ia[0]);var e;c.on("colour",function(c){Hg(a,c.Sa,b.input,b.input.Db);c=Qd(c.Sa).values[3];e.value=Math.round(100*c)});e=Zb(a.sa);e.min=0;e.max=100;var f=Qd(b.input.value);
e.oe(Math.round(100*f.values[3]));e.onchange=function(){f=Qd(b.input.value);f.values[3]=e.value/100;Hg(a,f.toString(),b.input,b.input.Db)};b.parentNode.appendChild(document.createElement("br"));b.parentNode.appendChild(e)}}
function ig(a){function b(){Ig(a,this)}function c(){var b=this;"timer"in b&&clearTimeout(b.timer);b.timer=setTimeout(function(){a.apply(b.Db.name,b.value)},250)}function d(){a.view.log("Someone clicked a button for %s",this.Db.name)}function e(b){13===b.keyCode&&a.apply(this.Db.name,this.value)}function f(){a.apply(this.Db.name,this.Db.values[parseInt(this.value,10)].value)}p(a.ia).empty();var g,h;for(g=0;g<a.$.length;g++){var k=a.$[g],l=k.Ld;if("none"!==l.type){var n=document.createElement("div");
h=document.createElement("span");h.appendChild(document.createTextNode(l.display));n.appendChild(h);n.appendChild(document.createElement("br"));if("select"===l.type){var q=document.createElement("select");for(h=0;h<l.values.length;h++){var r=l.values[h],u=document.createElement("option");u.appendChild(document.createTextNode(r.name));u.setAttribute("value",h);r.value===k.value&&u.setAttribute("selected","");q.appendChild(u)}q.Db=l;q.onchange=f;n.appendChild(q)}else if("colour"===l.type)h=document.createElement("input"),
h.setAttribute("type","text"),h.value=k.value,h.Db=l,La(p(h),e),n.appendChild(h),k=document.createElement("img"),k.src=X(a.fa,"wd-wheel.png"),k.style.verticalAlign="middle",k.input=h,n.appendChild(k),p(k).click(b);else if("text"===l.type)h=document.createElement("input"),h.setAttribute("type","text"),h.value=k.value,h.Db=l,La(p(h),e),n.appendChild(h);else if("textarea"===l.type)h=document.createElement("textarea"),h.setAttribute("rows","3"),h.setAttribute("cols","20"),h.value=k.value,h.Db=l,La(p(h),
c),n.appendChild(h);else if("button"===l.type)h=document.createElement("input"),h.setAttribute("type","button"),h.value="Edit",h.Db=l,p(h).click(d),n.appendChild(h);else throw"Error: No such property";a.ia.append(n)}}}
function hg(a,b,c){var d=a.la.fc();if("strokeStyle"===c)return{name:c,type:"colour",display:d("outline-colour")};if("fillStyle"===c)return{name:c,type:"colour",display:d("fill-colour")};if("lineWidth"===c)return a=[{name:d("thickness-pencil"),value:1},{name:d("thickness-pen"),value:2},{name:d("thickness-marker"),value:4},{name:d("thickness-brush"),value:10}],!0!==b.qa("closed")&&"TextNode"!==b.type()||a.unshift({name:d("none"),value:0}),{name:c,display:d("outline-thickness"),type:"select",values:a};
if("sloppiness"===c)return{name:"sloppiness",display:d("sloppiness"),type:"select",values:[{name:d("sloppiness-draftsman"),value:0},{name:d("sloppiness-artist"),value:.25},{name:d("sloppiness-cartoonist"),value:.5},{name:d("sloppiness-child"),value:1},{name:d("sloppiness-drunk"),value:2}]};if("smoothness"===c)return{name:"smoothness",display:d("smoothness"),type:"select",values:[{name:d("smoothness-sharpest"),value:0},{name:d("smoothness-sharper"),value:.1},{name:d("smoothness-sharp"),value:.2},{name:d("smoothness-smooth"),
value:.3},{name:d("smoothness-smoothest"),value:.5}]};if("shadow"===c)return{name:"shadow",display:d("shadow"),type:"select",values:[{name:d("yes"),value:!0},{name:d("no"),value:!1}]};if("dashes"===c)return{name:"dashes",display:d("line-style"),type:"select",values:[{name:d("line-style-solid"),value:""},{name:d("line-style-short-dashes"),value:"5,5"},{name:d("line-style-long-dashes"),value:"10,5"}]};if("matrix"===c||"inverse"===c||"closed"===c||"commands"===c||"seed"===c)return{name:c,type:"none"};
if("text"===c)return{name:"text",display:d("text"),type:"textarea"};if("textFillStyle"===c)return{name:"textFillStyle",display:d("text-colour"),type:"colour"};if("fontSize"===c)return{name:"fontSize",display:d("font-size"),type:"select",values:[{name:"10",value:10},{name:"12",value:12},{name:"15",value:15},{name:"20",value:20},{name:"30",value:30},{name:"40",value:40},{name:"50",value:50},{name:"60",value:60},{name:"100",value:100}]};if("fontName"===c){b=[];c=a.fa.ra.fonts;for(a=0;a<c.length;a++)b.push({name:c[a],
value:c[a]});return{name:"fontName",display:d("font"),type:"select",values:b}}return"arrowSize"===c?{name:"arrowSize",display:d("arrowhead-size"),type:"select",values:[{name:d("arrowhead-size-none"),value:0},{name:d("arrowhead-size-tiny"),value:10},{name:d("arrowhead-size-small"),value:15},{name:d("arrowhead-size-medium"),value:20},{name:d("arrowhead-size-large"),value:30}]}:"arrowStyle"===c?{name:"arrowStyle",display:d("arrowhead-style"),type:"select",values:[{name:d("arrowhead-style-simple"),value:"simple"},
{name:d("arrowhead-style-solid"),value:"solid"}]}:"doubleArrow"===c?{name:"doubleArrow",display:d("double-arrows"),type:"select",values:[{name:d("no"),value:!1},{name:d("yes"),value:!0}]}:"url"===c?{name:"url",display:d("image-url"),type:"text"}:"rows"===c?{name:c,display:"Rows",type:"text"}:"columns"===c?{name:c,display:"Columns",type:"text"}:{name:c,display:"Display-"+c,type:"text"}}Gg.prototype=p.$({},yg.prototype,Gg.prototype);function Jg(){this.xa=new M;this.ha=[];this.lineCap="butt";this.lineJoin="miter";this.strokeStyle="#000000";this.lineWidth=1;this.fillStyle="#000000";this.textBaseline="top";this.font="10pt arial"}
Jg.prototype={save:function(){this.ha.push({fillStyle:this.fillStyle,font:this.font,lineJoin:this.lineJoin,lineCap:this.lineCap,lineWidth:this.lineWidth,xa:this.xa.clone(),strokeStyle:this.strokeStyle,textBaseline:this.textBaseline})},restore:function(){var a=this.ha.pop();this.fillStyle=a.fillStyle;this.font=a.font;this.lineJoin=a.lineJoin;this.lineCap=a.lineCap;this.lineWidth=a.lineWidth;this.xa=a.xa;this.strokeStyle=a.strokeStyle;this.textBaseline=a.textBaseline},strokeRect:function(a,b,c,d){this.beginPath();
this.rect(a,b,c,d);this.stroke()},rect:function(a,b,c,d){this.beginPath();this.moveTo(a,b);this.lineTo(a+c,b);this.lineTo(a+c,b+d);this.lineTo(a,b+d);this.lineTo(a,b);this.closePath()},fillRect:function(a,b,c,d){this.rect(a,b,c,d);this.fill()},pc:function(a){var b=null,c=null,d="normal",e="normal",f="normal",g="normal";a=a.split(/\s+/);a:for(;;){var h=a.shift();if(!h)break;switch(h){case "normal":break;case "italic":case "oblique":d=h;break;case "small-caps":f=h;break;case "bold":case "bolder":case "lighter":case "100":case "200":case "300":case "400":case "500":case "600":case "700":case "800":case "900":e=
h;break;default:if(!c){h=h.split("/");c=h[0];1<h.length&&(g=h[1]);break}b=h;a.length&&(b+=" "+a.join(" "));2<b.length&&('"'===b.charAt(0)||"'"===b.charAt(0))&&(b=b.substr(1,b.length-2));break a}}return{fontStyle:d,fontVariant:f,fontWeight:e,fontSize:c,lineHeight:g,fontFamily:b}}};function Kg(a,b,c,d){this.x=a;this.y=b;this.width=c;this.height=d;this.aa=[];this.ba=Lg(this,"Pages",{Kids:[],Count:0});this.oa=Lg(this,"Catalog",{Pages:this.ba._id+" 0 R"});this.fonts={};this.ha={};this.la={};this.$=1;Mg(this)}
Kg.prototype={log:t("PdfWriter"),Xc:function(){for(var a=Ng(this),b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=a.charCodeAt(c);return new Blob([b],{type:"application/pdf"})},Hb:function(a){for(var b=[],c=0;c<arguments.length;c++){var d=""+arguments[c];0<d.indexOf("e")&&(d=arguments[c].toFixed(20));b.push(d)}return b.join(" ")}};
function Og(a,b,c,d,e){e?b.push("<<\n"):(c.push(b.join("").length),b.push(d._id+" 0 obj\n"),"Type"in d?b.push("<< /Type /"+d.Type+"\n"):b.push("<<\n"));"_stream"in d&&(d.Length=d._stream.toString().length);for(var f in d)if(d.hasOwnProperty(f)&&"Type"!==f&&"_"!==f.charAt(0)){e&&b.push("    ");b.push("   /"+f+" ");var g=d[f];"object"===typeof g&&"[object Array]"===Object.prototype.toString.apply(g)?b.push("[ "+g.join(" ")+" ]"):"object"===typeof g?Og(a,b,c,g,!0):b.push(g);b.push("\n")}e&&b.push("    ");
b.push(">>\n");"_stream"in d&&(b.push("stream\n"),b.push(d._stream+"\n"),b.push("endstream\n"));e||b.push("endobj\n")}
function Ng(a){var b=[],c=[],d;b.push("%PDF-1.4\n%\u0080\u0081\u0082\u0083\n");for(d=0;d<a.aa.length;d++)Og(a,b,c,a.aa[d],!1);var e=b.join("").length;b.push("xref\n0 "+(a.aa.length+1)+"\n");b.push("0000000000 65535 f\n");for(d=0;d<a.aa.length;d++){for(var f=c[d],f=""+f;10>f.length;)f="0"+f;b.push(f+" 00000 n \n")}b.push("trailer\n");b.push("<< /Size "+(a.aa.length+1)+"\n");b.push("   /Root "+a.oa._id+" 0 R\n");b.push(">>\n");b.push("startxref\n");b.push(e+"\n");b.push("%%EOF\n");return b.join("")}
function Pg(a,b,c){"Resources"in a.page||(a.page.Resources={});b in a.page.Resources||(a.page.Resources[b]={});a.page.Resources[b][c._name]=c._id+" 0 R"}function Qg(a,b,c){var d=""+b+"-"+c;if(!(d in a.la)){var e="gs"+a.$;a.$+=1;var f=Lg(a,"ExtGState",{_name:e});c?f.ca=a.Hb(b):f.CA=a.Hb(b);a.la[d]=e;Pg(a,"ExtGState",f)}return a.la[d]}function Lg(a,b,c){var d=a.aa.length+1;b&&(c.Type=b);c._id=d;a.aa.push(c);return c}
function Mg(a,b,c,d,e){b=b||a.x;c=c||a.y;d=d||a.width;e=e||a.height;a.log("StartPage MediaBox=[%s %s %s %s]",b,c,d,e);a.page=Lg(a,"Page",{MediaBox:[b,c,b+d,c+e],Parent:a.ba._id+" 0 R"});a.ba.Kids.push(a.page._id+" 0 R");a.ba.Count+=1;a.la={}}function Rg(a,b){Jg.call(this);this.sa=b;this.la=this.ff;this.ba=a.clone();this.ba.transform(new nc(.75,.75,0,0));this.vc="black";this.aa=new Kg(72*a.x/96,72*a.y/96,72*a.width/96,72*a.height/96);this.$=[];this.path=[];this.y=this.x=0;this.oa=[];Sg(this)}
Rg.prototype={log:t("PDFContext"),save:function(){Jg.prototype.save.call(this);this.$.push("q");this.oa.push({xa:this.xa.clone(),vc:this.vc,Qc:this.Qc,Pc:this.Pc,Oc:this.Oc,Nc:this.Nc,Mc:this.Mc,Lc:this.Lc,Kc:this.Kc})},restore:function(){Jg.prototype.restore.call(this);this.$.push("Q");var a=this.oa.pop();this.xa=a.xa;this.vc=a.vc;this.Qc=a.Qc;this.Pc=a.Pc;this.Oc=a.Oc;this.Nc=a.Nc;this.Mc=a.Mc;this.Lc=a.Lc;this.Kc=a.Kc},beginPath:function(){this.path.length=0},toString:function(){Tg(this);return Ng(this.aa)},
Xc:function(){Tg(this);return this.aa.Xc()},setTransform:function(a,b,c,d,e,f){var g=hc(this.ba);this.xa=(new M(a,c,b,d,e,f)).multiply(new pc(0,g.x,g.y)).multiply(new nc(.75,.75,0,0))},transform:function(a,b,c,d,e,f){a=new M(a,c,b,d,e,f);this.xa=this.xa.multiply(a)},translate:function(a,b){this.transform(1,0,0,1,a,b)},scale:function(a,b){this.transform(a,0,0,b,0,0)},closePath:function(){this.path.push("h")},fill:function(){Ug(this);for(var a=0;a<this.path.length;a++)this.$.push(this.path[a]);this.$.push("f")},
stroke:function(){Vg(this);for(var a=0;a<this.path.length;a++)this.$.push(this.path[a]);this.$.push("S")},moveTo:function(a,b){var c=this.xa.apply(a,b);this.path.push(this.aa.Hb(c.x,c.y)+" m");this.x=a;this.y=b},lineTo:function(a,b){var c=this.xa.apply(a,b);this.path.push(this.aa.Hb(c.x,c.y)+" l");this.x=a;this.y=b},quadraticCurveTo:function(a,b,c,d){this.bezierCurveTo(2/3*a+1/3*this.x,2/3*b+1/3*this.y,2/3*a+1/3*c,2/3*b+1/3*d,c,d)},bezierCurveTo:function(a,b,c,d,e,f){a=this.xa.apply(a,b);c=this.xa.apply(c,
d);d=this.xa.apply(e,f);this.path.push(this.aa.Hb(a.x,a.y,c.x,c.y,d.x,d.y)+" c");this.x=e;this.y=f},arc:function(){},fillText:function(a,b,c){this.la(a,b,c,0)},strokeText:function(a,b,c){this.la(a,b,c,1)},ff:function(a,b,c,d){var e,f,g=this.pc(this.font),h=this.sa.get(g.fontFamily);if(h){0===d?Ug(this):Vg(this);this.beginPath();g=parseFloat(g.fontSize);this.save();this.translate(b,c);h.transform(this,g);for(g=c=b=0;g<h.Fc.length;g++)h.Fc[g].reset();for(g=0;g<a.length;g++){var k,l=h;k=a.charCodeAt(g);
var n=0;for(e=0;e<l.la.length&&!(n=l.la[e].map(k));e++);k=n;l=h;n=k;S("hmtx"in l.$);e=l.aa;f=e.seek(l.$.hmtx.offset+4);var q=l.$.hmtx.offset,r={};n<l.ha?(q+=4*n,f=l.aa.seek(q),r.Bd=e.getUint16()):(f=e.seek(q+4*(l.ha-1)),r.Bd=e.getUint16(),e.seek(q+4*l.ha+2*(n-l.ha)));r.Mf=e.getInt16();l.aa.seek(f);l=r;e=h;f=k;for(var q=void 0,u=n=r=0;u<e.Fc.length;u++)q=e.Fc[u].get(f),r+=q.x,n+=q.y;e=r;f=n;h.log("Metrics for %s code %s index %s: %s %s kern: %s,%s",a.charAt(g),a.charCodeAt(g),k,l.Bd,l.Mf,e,f);n=b+
e;e=c+f;k=He(h,k);if(null!==k&&"simple"===k.type)for(var u=r=q=f=0,v=void 0;q<k.ta.length;q++){var w=k.ta[q];0===f?(this.moveTo(w.x+n,w.y+e),f=1):1===f?w.tc?this.lineTo(w.x+n,w.y+e):f=2:(v=k.ta[q-1],w.tc?(this.quadraticCurveTo(v.x+n,v.y+e,w.x+n,w.y+e),f=1):this.quadraticCurveTo(v.x+n,v.y+e,(v.x+w.x)/2+n,(v.y+w.y)/2+e));q===k.Vb[r]&&(2===f&&(v=w,w=k.ta[u],w.tc?this.quadraticCurveTo(v.x+n,v.y+e,w.x+n,w.y+e):this.quadraticCurveTo(v.x+n,v.y+e,(v.x+w.x)/2+n,(v.y+w.y)/2+e)),u=q+1,r+=1,f=0)}b+=l.Bd}this.restore();
0===d?this.fill():this.stroke()}else{h=this.pc(this.font);if(this.Mc!==h.fontSize||this.Lc!==h.fontFamily)g=this.aa,l=h.fontFamily,l in g.fonts||(k="F"+g.$,g.$+=1,n="/"+l.replace(/ /g,""),k=Lg(g,"Font",{_name:k,BaseFont:n,Encoding:"/StandardEncoding",Subtype:"/Type1"}),g.fonts[l]=k),Pg(g,"Font",g.fonts[l]),this.$.push("/"+g.fonts[l]._name+" "+this.aa.Hb(parseFloat(h.fontSize))+" Tf"),this.Mc=h.fontSize,this.Lc=h.fontFamily;this.Kc!==d&&(this.$.push(d+" Tr"),this.Kc=0);0===d?Ug(this):Vg(this);this.$.push("BT");
d=this.xa.multiply(new M(1,0,0,-1,b,c));this.$.push(this.aa.Hb(d.m11,d.m21,d.m12,d.m22,d.Aa,d.Ba)+" Tm");this.$.push("("+a.replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")+") Tj");this.$.push("ET")}},pc:function(a){var b=null,c=null,d="normal",e="normal",f="normal",g="normal";a=a.split(/\s+/);a:for(;;){var h=a.shift();if(!h)break;switch(h){case "normal":break;case "italic":case "oblique":d=h;break;case "small-caps":f=h;break;case "bold":case "bolder":case "lighter":case "100":case "200":case "300":case "400":case "500":case "600":case "700":case "800":case "900":e=
h;break;default:if(!c){h=h.split("/");c=h[0];1<h.length&&(g=h[1]);break}b=h;a.length&&(b+=" "+a.join(" "));break a}}b&&(b=b.replace(/"/g,""));return{fontStyle:d,fontVariant:f,fontWeight:e,fontSize:c,lineHeight:g,fontFamily:b}},drawImage:function(a,b,c,d,e,f,g,h,k){var l=parseInt(a.width,10),n=parseInt(a.height,10);if(3===arguments.length)return this.drawImage(a,0,0,l,n,arguments[1],arguments[2],l,n);if(5===arguments.length)return this.drawImage(a,0,0,l,n,arguments[1],arguments[2],arguments[3],arguments[4]);
this.log("DrawImage(%s, %s, %s, %s, %s, %s, %s %s)",b,c,d,e,f,g,h,k);g=g+k;l=document.createElement("canvas");n=l.getContext("2d");l.width=d;l.height=e;n.drawImage(a,-b,-c);var n=this.aa,q=[a.src,b,c,d,e].join(),r;if(!(q in n.ha)){var u="I"+n.$;n.$+=1;var v=l.getContext("2d").getImageData(0,0,l.width,l.height);r="";var w=!1,z=Ua();for(r=0;r<v.data.length;r+=4)z.$a(v.data[r]),z.$a(v.data[r+1]),z.$a(v.data[r+2]),w=w||255>v.data[r+3];z.flush();r=z.jd().toString();u=Lg(n,"XObject",{Subtype:"/Image",Width:l.width,
Height:l.height,ColorSpace:"/DeviceRGB",BitsPerComponent:8,Length:r.length,Interpolate:"true",Filter:"[/ASCII85Decode /LZWDecode]",DecodeParms:"[ null << /EarlyChange 0 >> ]",_name:u,_stream:r});if(w){z=Ua();for(r=0;r<v.data.length;r+=4)z.$a(v.data[r+3]);z.flush();r=z.jd().toString();l=Lg(n,"XObject",{Subtype:"/Image",Width:l.width,Height:l.height,ColorSpace:"/DeviceGray",BitsPerComponent:8,Length:r.length,Filter:"[/ASCII85Decode /LZWDecode]",DecodeParms:"[ null << /EarlyChange 0 >> ]",_stream:r});
u.SMask=l._id+" 0 R"}n.ha[q]=u}Pg(n,"XObject",n.ha[q]);l="/"+n.ha[q]._name;this.$.push("q");n=this.xa.multiply(new M(h,0,0,-k,f,g));this.$.push(this.aa.Hb(n.m11,n.m21,n.m12,n.m22,n.Aa,n.Ba)+" cm");this.$.push(l+" Do");this.$.push("Q")}};
function Vg(a){function b(a){return"miter"===a?0:"round"===a?1:2}function c(a){return"butt"===a?0:"round"===a?1:2}if(a.Qc!==a.strokeStyle){var d=Le(Qd(a.strokeStyle),0);a.$.push(a.aa.Hb(d.values[0],d.values[1],d.values[2])+" RG");d=Qg(a.aa,d.values[3],!1);a.$.push("/"+d+" gs");a.Qc=a.strokeStyle}a.Pc!==a.lineWidth&&(a.Pc=a.lineWidth,a.$.push(a.aa.Hb(a.lineWidth)+" w"));a.Oc!==a.lineJoin&&(a.Oc=a.lineJoin,a.$.push(b(a.lineJoin)+" j"));a.Nc!==a.lineCap&&(a.Nc=a.lineCap,a.$.push(c(a.lineCap)+" J"))}
function Ug(a){if(a.vc!==a.fillStyle){var b=Le(Qd(a.fillStyle),0);a.$.push(a.aa.Hb(b.values[0],b.values[1],b.values[2])+" rg");b=Qg(a.aa,b.values[3],!0);a.$.push("/"+b+" gs");a.vc=a.fillStyle}}function Tg(a){if(a.$.length){var b=a.aa,c;c=Lg(a.aa,null,{_stream:a.$.join("\n")});b.page.Contents=c._id+" 0 R"}a.$.length=0}function Sg(a){a.log("Start page: %s",a.ba);a.setTransform(1,0,0,1,0,0)}Rg.prototype=p.$({},Jg.prototype,Rg.prototype);function Wg(a,b,c){this.name=a;this.$=b;this.children=[];this.text=c}Wg.prototype={toString:function(){var a=[];Xg(this,a,"  ");return a.join("")}};function Yg(a,b){a.children.push(b)}
function Xg(a,b,c){var d;b.push(c);b.push("<");b.push(a.name);for(d in a.$)a.$.hasOwnProperty(d)&&(b.push(" "),b.push(d),void 0!==a.$[d]&&null!==a.$[d]&&(b.push('="'),b.push(a.$[d]),b.push('"')));if(a.children.length||void 0!==a.text){b.push(">\n");for(d=0;d<a.children.length;d++)Xg(a.children[d],b,c+"  ");void 0!==a.text&&b.push(c+"  "+a.text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"));b.push("</"+a.name+">")}else b.push("/>");b.push("\n")}
;function Zg(a){Jg.call(this);this.xa=new M;this.ea=[];this.path=[];this.log("SVG context rect: %s",a);this.root=new Wg("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",version:1.2,baseProfile:"tiny",width:a.width,height:a.height,viewBox:a.x+" "+a.y+" "+a.width+" "+a.height})}
Zg.prototype={log:t("SvgContext"),td:1,ud:2,FONT:4,node:function(a,b,c,d){function e(a,b){var d=Qd(b),e=d.values[3];1>e&&(d.values[3]=1,c[a+"-opacity"]=""+e);c[a]=d.toString()}mc(this.xa)||(c.transform="matrix("+this.xa.m11+" "+this.xa.m21+" "+this.xa.m12+" "+this.xa.m22+" "+this.xa.Aa+" "+this.xa.Ba+")");b&this.td?e("fill",this.fillStyle):c.fill="none";b&this.ud&&(e("stroke",this.strokeStyle),c["stroke-width"]=this.lineWidth,"miter"!==this.lineJoin&&(c["stroke-linejoin"]=this.lineJoin),"butt"!==
this.lineCap&&(c["stroke-linecap"]=this.lineCap));b&this.FONT&&(b=this.pc(this.font),c["font-weight"]=b.fontWeight,c["font-size"]=parseFloat(b.fontSize),c["font-style"]=b.fontStyle,c["font-family"]=b.fontFamily);Yg(this.root,new Wg(a,c,d))},toString:function(){return'<?xml version="1.0" encoding="UTF-8"?>\n'+this.root.toString()},Xc:function(){for(var a=this.toString(),b=new Uint8Array(a.length),c=0;c<a.length;c++)b[c]=a.charCodeAt(c);return new Blob([b],{type:"image/svg+xml"})},beginPath:function(){this.path.length=
0},transform:function(a,b,c,d,e,f){a=new M(a,c,b,d,e,f);this.xa=this.xa.multiply(a)},setTransform:function(a,b,c,d,e,f){this.xa=new M(a,c,b,d,e,f)},translate:function(a,b){this.xa.Aa+=a;this.xa.Ba+=b},scale:function(a,b){this.xa=this.xa.multiply(new nc(a,b))},closePath:function(){this.path.push("Z")},fill:function(){this.node("path",this.td,{d:this.path.join(" ")})},stroke:function(){this.node("path",this.ud,{d:this.path.join(" ")})},moveTo:function(a,b){this.path.push("M"+a+","+b)},lineTo:function(a,
b){this.path.push("L"+a+","+b)},quadraticCurveTo:function(a,b,c,d){this.path.push("Q"+a+","+b);this.path.push(c+","+d)},bezierCurveTo:function(a,b,c,d,e,f){this.path.push("C"+a+","+b);this.path.push(c+","+d);this.path.push(e+","+f)},arc:function(a,b,c,d,e,f){var g=a+c*Math.cos(d);d=b+c*Math.sin(d);a+=c*Math.cos(e);b+=c*Math.sin(e);this.path.push("M");this.path.push(g);this.path.push(d);this.path.push("A");this.path.push(c);this.path.push(c);this.path.push(0);this.path.push(f?0:1);this.path.push(0);
this.path.push(a);this.path.push(b)},fillText:function(a,b,c){this.pc(this.font);this.node("text",this.td|this.FONT,{x:b,y:c},a)},strokeText:function(a,b,c){this.pc(this.font);this.node("text",this.ud|this.FONT,{x:b,y:c},a)},drawImage:function(a,b,c,d,e,f,g,h,k){var l=document.createElement("canvas"),n=l.getContext("2d");l.width=d;l.height=e;n.drawImage(a,-b,-c);a=l.toDataURL();Yg(this.root,new Wg("image",{transform:"matrix("+this.xa.m11+" "+this.xa.m21+" "+this.xa.m12+" "+this.xa.m22+" "+this.xa.Aa+
" "+this.xa.Ba+")",x:f,y:g,width:h,height:k,"xlink:href":a}))}};Zg.prototype=p.$({},Jg.prototype,Zg.prototype);var $g=t("DOC");
me.prototype.save=function(a,b){var c,d;if("list"===a)d=ah(this),c="application/json";else if("zwibbler3"===a)c=ah(this),d="zwibbler3."+window.JSON.stringify(c),c="application/octet-stream";else if("svg"===a)c=te(this),d=new Zg(c),this.na(d),c="image/svg+xml";else if("pdf"===a){c=te(this);d=new Rg(c,window.Zwibbler.fonts);var e=this.ob;for(c=0;c<this.Mb();c++){if(0<c){var f=d;Tg(f);Mg(f.aa,f.ba.x,f.ba.y,f.ba.width,f.ba.height);Sg(f);f.beginPath()}this.lb(c);this.na(d)}this.lb(e);c="application/pdf"}else throw"Unknown save format: "+
a;var g;if(je(d))if("string"===b)g=d;else if("data-uri"===b)g="data:"+c+";base64,"+ha(d);else{if("blob"===b)for(e=new Uint8Array(d.length),c=0;c<d.length;c++)e[c]=d.charCodeAt(c)}else if(d.Xc&&d.toString)"string"===b?g=d.toString():"data-uri"===b?g="data:"+c+";base64,"+ha(d.toString()):"blob"===b&&(g=d.Xc());else if("object"===b)g=d;else throw"Error in ZwibblerDocument.save()";return g};
function bh(a){if("{"===a.charAt(0))return ch(a);if(0===a.indexOf("zwibbler3.")){var b=window.JSON.parse(a.substr(10));return dh(b)}if(0===a.indexOf("zwibblerclip."))return b=new me(!1),a=ue(b,a,[]),b.ya(a),ye(b),b;throw"Format detection failed.";}
function ch(a){var b=t("IMPORT"),c=new me,d=c.hb,e,f,g,h,k,l=[];k=function(a){var b=new M;b.m11=a.m11;b.m12=a.m12;b.m21=a.m21;b.m22=a.m22;b.Aa=a.dx;b.Ba=a.dy;return b};g=function(a){var b=0;"arrowSize"in a&&(b=a.arrowSize,a=a.path);var c=k(a.matrix),b={strokeStyle:a.strokeStyle,fillStyle:a.fillStyle,lineWidth:a.lineWidth,smoothness:a.smoothness,sloppiness:a.sloppiness,shadow:a.shadow,arrowSize:b,seed:Math.round(65535*Math.random())};if("textNode"in a){var e=a.textNode;b.fontSize=e.fontSize;b.fontName=
e.fontName;b.text=e.text;b.textFillStyle="textFillStyle"in e?e.textFillStyle:e.fillStyle}"path"in a&&(a=a.path);var e=a.closed,f=new N,g=a.segments;a=c.apply(a.startX,a.startY);f.moveTo(a.x,a.y);for(a=0;a<g.length;a++){var h=g[a],n;switch(h.type){case 1:n=c.apply(h.x,h.y);f.lineTo(n.x,n.y);break;case 2:n=c.apply(h.x,h.y);f.fd(n.x,n.y);break;case 3:n=c.apply(h.x1,h.y1);h=c.apply(h.x,h.y);f.$(n.x,n.y,h.x,h.y);break;default:throw"Unknown path segment type: "+h.type;}}e&&f.close();b.commands=f.Eb();l.push(new D("PathNode",
b));d+=1};e=function(a,b){for(var c=[],e=a.children,g=e.length-1;0<=g;g--){var h=d;try{f(e[g],b+1)}catch(k){continue}c.push(h)}0<b&&(d+=1,l.push(new Yd(c)))};h=function(a){var b=k(a.matrix),b=b.multiply(new E(0,1.3*a.fontSize));a={fillStyle:a.fillStyle,lineWidth:0,text:a.text,fontName:a.fontName,fontSize:a.fontSize,matrix:b,inverse:b.inverse()};l.push(new D("TextNode",a));d+=1};f=function(a,b){switch(a.type){case "Node":e(a,b);break;case "PathNode":case "ArrowNode":g(a);break;case "TextNode":h(a);
break;default:throw"Unknown node type: "+a.type;}};var n;try{n=window.JSON.parse(a)}catch(q){a=a.replace(/\\\\/g,"\\").replace(/\\"/g,'"');try{n=window.JSON.parse(a)}catch(r){throw b("Couldn't parse file."),"Couldn't parse file.";}}b("Successfully parsed!");f(n,0);c.ya(l);return c}
function ah(a){function b(a,d){var e={id:d.id,type:d.type()};c.push(e);a&&(e.parent=a.id);var f=nd(d),n;for(n in f)f.hasOwnProperty(n)&&("matrix"===n?e[n]=f[n].Eb():"inverse"!==n&&(e[n]=f[n]));if(pd(d))for(e=0;e<d.children.length;e++)b(d,d.children[e])}var c=[],d={type:"document"},e=!1,f;for(f in a.ga)a.ga.hasOwnProperty(f)&&(d[f]=a.ga[f],e=!0);e&&c.push(d);b(null,a.root);return c}
function dh(a){function b(a,c){var d;if(void 0!==a){d={};for(var e in a)a.hasOwnProperty(e)&&"children"!==e&&"parent"!==e&&"id"!==e&&"type"!==e&&("matrix"===e?(d[e]=new M(a[e]),d.inverse=d.matrix.inverse()):d[e]=a[e]);e=h;0!==a.id&&f.push(new D(a.type,d,c,-1));g[a.id]=h;h+=1;if(void 0!==a.children)for(d=0;d<a.children.length;d++)b(a.children[d],e)}}var c,d,e;a=window.JSON.parse(window.JSON.stringify(a));var f=[],g={},h=0,k={},l=!1;for(c=0;c<a.length;c++)if(e=a[c],"document"===e.type)delete e.type,
f.push(new ge(e));else{"PageNode"===e.type&&(l=!0);if("parent"in e){if(!(e.parent in k))throw"Error: child "+e.id+" references parent "+e.parent+" before it was defined.";d=k[e.parent];void 0!==d.children?d.children.push(e):d.children=[e]}"GroupNode"!==e.type&&"PageNode"!==e.type||void 0!==e.children||(e.children=[]);k[e.id]=e}l||(h+=1);b(k[0],h);$g(JSON.stringify(g));for(c=0;c<f.length;c++)$g(f[c].toString());a=new me(l);a.ya(f);ye(a);return a};function eh(a,b,c){var d=this;this.ua=a;this.ia=b;this.sa=new Qa;this.ia.empty();"absolute"!==this.ia.da("position")&&"fixed"!==this.ia.da("position")&&this.ia.da("position","relative");this.ia.da("overlow","none");this.ia.da("text-align","left");this.Ra=new Ag(p("<div>").da("width","300px"),this.sa);this.log("Starting Zwibbler Version %s",14);this.ia.append(this.Ra.ia);this.fa=new tg(c);this.Ka=new ab("en:arrowhead-size:Arrowhead size\nes:arrowhead-size:Flecha tama\u00f1o\n\nen:arrowhead-size-large:Large\nes:arrowhead-size-large:Grande\n\nen:arrowhead-size-medium:Medium\nes:arrowhead-size-medium:Medio\n\nen:arrowhead-size-none:None\nes:arrowhead-size-none:Nada\n\nen:arrowhead-size-small:Small\nes:arrowhead-size-small:Peque\u00f1o\n\nen:arrowhead-size-tiny:Tiny\nes:arrowhead-size-tiny:Diminuto\n\nen:arrowhead-style:Arrowhead style\nes:arrowhead-style:Flecha estilo\n\nen:arrowhead-style-simple:Simple\nes:arrowhead-style-simple:Llanura\n\nen:arrowhead-style-solid:Solid\nes:arrowhead-style-solid:Denso\n\nen:arrow-keys:Arrow Keys\nes:arrow-keys:Teclas de flecha\n\nen:arrow-tool:Arrow tool\nes:arrow-tool:Flecha\nfr:arrow-tool:Fl\u00e8che\nnl:arrow-tool:Pijl\n\nen:break-apart-group:Break apart group\nes:break-apart-group:Dividir el grupo\n\nen:bring-to-front:Bring to front\nes:bring-to-front:Traer al frente\n\nen:brush-tool:Brush tool\nes:brush-tool:Brocha\nfr:brush-tool:Brosse\nnl:brush-tool:Penseel\n\nen:circle-tool:Circle tool\nes:circle-tool:C\u00edrculo\nfr:circle-tool:Cercle\nnl:circle-tool:Cirkel\n\nen:click-to-place-another-point-or-double-click-to-end-the-line:Click to place another point, or double-click to end the line.\nes:click-to-place-another-point-or-double-click-to-end-the-line:Haga clic para colocar otro punto, o doble clic para finalizar la l\u00ednea\nfr:click-to-place-another-point-or-double-click-to-end-the-line:Cliquez pour placer un autre point, ou double-cliquez pour terminer la ligne.\nnl:click-to-place-another-point-or-double-click-to-end-the-line:Klik op een ander punt te plaatsen, of dubbelklik om de lijn te be\u00ebindigen.\n\nen:click-to-place-first-point-of-line:Click to place first point of line\nes:click-to-place-first-point-of-line:Haga clic para colocar el primer punto de la l\u00ednea\nfr:click-to-place-the-first-point-of-line:Cliquez pour placer le premier point de la ligne\nnl:click-to-place-the-first-point-of-line:Klik om het eerste punt van de lijn te plaatsen.\n\nen:click-to-set-the-end-of-the-line:Click to set the end of the line\nes:click-to-set-the-end-of-the-line:Haga clic para colocar el extremo de la l\u00ednea\nfr:click-to-set-the-end-of-the-line:Cliquez pour d\u00e9finir la fin de la ligne\nnl:click-to-set-the-end-of-the-line:Klik hier voor het einde van de lijn in te stellen.\n\nen:copy:Copy\nes:copy:Copiar\nfr:copy:Copie\nnl:copy:Kopi\u00ebren\n\nen:curve-tool:Curve tool\nes:curve-tool:Curva\nfr:curve-tool:Courbes\nnl:curve-tool:Kromme\n\nen:delete-selection:Delete selection\nes:delete-selection:Eliminar la selecci\u00f3n\n\nen:del-key:Del\nes:del-key:Del\n\nen:double-arrows:Double arrows\nes:double-arrows:flechas dobles\n\nen:draw-curves:Draw curves\nes:draw-curves:Dibuje las curvas\n\nen:draw-lines:Draw lines\nes:draw-lines:Dibujar l\u00edneas\n\nen:duplicate-selection:Duplicate selection\nes:duplicate-selection:Duplica la selecci\u00f3n\n\nen:fill-colour:Fill colour\nes:fill-colour:Color de relleno\n\nen:font:Font\nes:font:Font\n\nen:font-size:Font size\nes:font-size:Tama\u00f1o de letra\n\nen:group-selection:Group selection\nes:group-selection:Grupo la selecci\u00f3n\n\nen:image-tool:Image tool\nes:image-tool:Imagen\nfr:image-tool:Image\nnl:image-tool:Afbeelding\n\nen:image-url:Image URL\nes:image-url:URL de la imagen\n\nen:keyboard:Keyboard\nes:keyboard:Teclado\n\nen:line-style:Line style\nes:line-style:Estilo de l\u00ednea\n\nen:line-style-long-dashes:Long dashes\nes:line-style-long-dashes:Gui\u00f3n largo\n\nen:line-style-short-dashes:Short dashes\nes:line-style-short-dashes:Gui\u00f3n corto\n\nen:line-style-solid:Solid\nes:line-style-solid:Denso\n\nen:line-tool:Line tool\nes:line-tool:Raya\nfr:line-tool:Lignes\nnl:line-tool:Lijn\n\nen:move-selection-away:Move selection away\nes:move-selection-away:Mover la selecci\u00f3n de distancia\n\nen:move-selection-closer:Move selection closer\nes:move-selection-closer:Mover la selecci\u00f3n de distancia\n\nen:move-while-zoomed:Move while zoomed\nes:move-while-zoomed:Desplazarse por la pantalla\n\nen:none:None\nes:none:Nada\n\nen:no:No\nes:no:No\n\nen:outline-colour:Outline colour\nes:outline-colour:Color del contorno\n\nen:outline-thickness:Outline thickness\nes:outline-thickness:Grosor del contorno\n\nen:page-down-key:Page Down\nes:page-down-key:Page Down\n\nen:page-up-key:Page Up\nes:page-up-key:Page Up\n\nen:paste:Paste\nes:paste:Pegar\nfr:paste:Coller\nnl:paste:Plak\n\nen:pick-tool:Pick tool\nes:pick-tool:Seleccionar\nfr:pick-tool:S\u00e9lectionner\nnl:pick-tool:Uitkiezen\n\nen:rectangle-tool:Rectangle tool\nes:rectangle-tool:rect\u00e1ngulo\nfr:rectangle-tool:Rectangle\nnl:rectangle-tool:Rechthoek\n\nen:redo:Redo\nes:redo:Rehacer\nfr:redo:Refaire\nnl:redo:Opnieuw maken\n\nen:rounded-rectangle-tool:Rounded rectangle tool\nes:rounded-rectangle-tool:Rect\u00e1ngulo redondeado\n\nen:save:Save\nes:save:Guardar\n\nen:send-to-back:Send to back\nes:send-to-back:Enviar a la parte posterior\n\nen:shadow:Shadow\nes:shadow:Sombra\n\nen:shape-brush-tool:Shape brush tool\nes:shape-brush-tool:Brush que dibuja formas\n\nen:sloppiness-artist:Artist\nes:sloppiness-artist:Artista\n\nen:sloppiness-cartoonist:Cartoonist\nes:sloppiness-cartoonist:Caricaturista\n\nen:sloppiness-child:Child\nes:sloppiness-child:Ni\u00f1o\n\nen:sloppiness-draftsman:Draftsman\nes:sloppiness-draftsman:Dibujante\n\nen:sloppiness-drunk:Drunk\nes:sloppiness-drunk:Borracho\n\nen:sloppiness:Sloppiness\nes:sloppiness:La dejadez\n\nen:smoothness-sharper:Sharper\nes:smoothness-sharper:Muy afilado\n\nen:smoothness-sharpest:Sharpest\nes:smoothness-sharpest:M\u00e1s afilado\n\nen:smoothness-sharp:Sharp\nes:smoothness-sharp:Afilado\n\nen:smoothness-smoothest:Smoothest\nes:smoothness-smoothest:Muy liso\n\nen:smoothness:Smoothness\nes:smoothness:Lisura\n\nen:smoothness-smooth:Smooth\nes:smoothness-smooth:Liso\n\nen:text-colour:Text colour\nes:text-colour:Color del texto\n\nen:text:Text\nes:text:Texto\n\nen:text-tool:Text tool\nes:text-tool:Texto\nfr:text-tool:Texte\nnl:text-tool:Tekst\n\nen:thickness-brush:Brush\nes:thickness-brush:Brocha\n\nen:thickness-marker:Marker\nes:thickness-marker:Rotulador\n\nen:thickness-pencil:Pencil\nes:thickness-pencil:L\u00e1piz\n\nen:thickness-pen:Pen\nes:thickness-pen:Pluma\n\nen:undo:Undo\nes:undo:Deshacer\nfr:undo:D\u00e9faire\nnl:undo:Ongedaan maken\n\nen:yes:Yes\nes:yes:S\u00ed\n\nen:zoom-in:Zoom in\nes:zoom-in:Zoom\n\nen:zoom-out:Zoom out\nes:zoom-out:Disminuir el zoom\n");
db(this.Ka,this.fa.get("language"));this.oa=null;this.Da=p("<div>");this.Da.da("position","absolute");this.Da.da("overflow","hidden");this.ia.append(this.Da);this.canvas=p(Oe(this.Da[0]));this.canvas.da("outline","0");this.canvas.da("position","absolute");this.canvas.da("left","0");this.canvas.da("top","0");this.canvas.ab("tabindex","0");this.ma=this.canvas[0].getContext("2d");this.fa.on("useTouch",function(a,b,c){d.fa.Kb()?(a=40,b=!0):(a=20,b=!1);c?d.aa=new Xe(d.ia,a,b,!1):(d.aa.Zb(a,b),fh(d,!0))});
this.qb=new J;this.view=new Kf(this.canvas,new me,this.aa,this.qb,this.fa,this.Ka,this.ua,this.sa);gh(this);hh(this);this.ua.on("tool-changed",function(a){Tb(d.toolbar,a)});ih(this);this.la=new Gg(this.fa,this.Ka,this.sa);this.ia.append(this.la.ia);this.fa.pe()&&(this.view.ic=this.la);this.la.view=this.view;this.la.on("click",function(){d.focus("none")});this.sa.bind(p(window),"resize",function(){return fh(d)});this.zc=pg();this.Ab="debug"in this.zc||this.fa.ra.showDebug;this.ba=new Dg(this.ia);this.ba.ia.da("border-right",
"1px solid black");this.ha=new Dg(this.ia);this.ha.ia.da("border-top","1px solid black");this.ha.on("click",function(a){return $f(d.view,a)});this.ba.on("click",function(a){return jh(d,a)});null!==this.fa.ra.backgroundImage&&(jh(this,this.fa.ra.backgroundImage),ye(this.view.ka));kh(this);this.fa.on("update",function(a,b){d.Ic(a,b)});this.jc=this.lc=-1;this.$=new df(p("<div>"),!1,!this.fa.get("showPageSelectorControls"));this.$.ia.da("position","absolute");this.$.ia.da("top","0");this.$.ia.da("bottom",
"0");this.$.ia.da("width","160px");this.$.ia.da("left","50px");this.$.ia.da("background",this.fa.get("outsidePageColour"));hf(this.$,this.fa.get("showPageSelector"));this.ia.append(this.$.ia);this.Rb=p("<div>").da("position","absolute").da("top","0").da("right","0").da("box-shadow","3px 3px 3px #444").da("background","#ccc").da("color","black").da("border-bottom-left-radius","4px").da("font-family","arial,sans");this.ia.append(this.Rb);fh(this);(a=xg(this.fa))?this.cb=new df(p(a),!0,!0):this.cb=null;
this.fa.get("setFocus")&&this.focus("toolbar");this.fa.get("pageView")&&Qf(this.view,"page");this.sb=[];gf(this.$,this.ua);this.cb&&(gf(this.cb,this.ua),hf(this.cb,!0));this.ua.emit("document-changed");this.ua.emit("set-page",this.view.ka.ob);if("localStorage"in window){var e=window.localStorage;this.fa.get("persistent")&&(a=e.getItem("zwibbler-document"))&&lh(this,bh(a));this.ic=ng(function(){d.fa.get("persistent")&&(d.log("Saving document"),e.setItem("zwibbler-document",d.ua.save()))});d.ua.on("document-changed",
function(){d.ic()});d.sa.add(function(){d.ic.cancel()})}this.sa.add(function(){d.ia.empty();delete d.ia[0].zwibbler})}
eh.prototype={log:t("APP"),Ic:function(a,b){var c=!1;this.log("onConfigChange %s=%s",a,b);switch(a){case "debug":case "showDebug":this.Ab=b;c=!0;break;case "showPageSelector":c=!0;hf(this.$,b);break;case "backgroundImage":jh(this,b);break;case "showToolbar":case "showColourPanel":c=!0;break;case "showArrowTool":case "showBrushTool":case "showCircleTool":case "showCopyPaste":case "showCurveTool":case "showLineTool":case "showMoveToFrontBack":case "showPickTool":case "showRoundRectTool":case "showShapeBrushTool":case "showSquareTool":case "showTextTool":case "showUndoRedo":case "toolbarButtonSize":hh(this);c=
!0;break;case "language":db(this.Ka,b)}c&&fh(this,!0)},focus:function(a){this.log("Set focus to %s",a);if("toolbar"!==a&&"canvas"!==a&&"none"!==a)throw"Focus must be toolbar or canvas or none, not "+a;this.Ya=a;"toolbar"===this.Ya?(this.toolbar.focus(),a=this.view,a.Ea.fb&&(a.Ea.fb=!1,a.na()),this.ia.focus()):"canvas"===this.Ya&&(this.toolbar.blur(),this.ia.focus())},qc:function(a,b){var c;c=this.view.ka.hb;a.push(new Yd(b));return c},Zc:function(a,b){a.push(new Zd(b))}};
function mh(a,b,c){return nh(a,b,"PathNode",{commands:c,fillStyle:a.view.Xa,strokeStyle:a.view.bb,seed:Math.round(65535*Math.random()),lineWidth:a.view.va.lineWidth,sloppiness:a.view.va.sloppiness,angleArcs:a.fa.get("angleArcs")})}
function oh(a,b,c){var d,e;d=p("<canvas>");d.ab("width",""+c.width);d.ab("height",""+c.height);e=d[0].getContext("2d");"image/jpeg"===b&&(e.fillStyle="#ffffff",e.fillRect(0,0,c.width,c.height));e.translate(-c.x,-c.y);Vf(a.view,e,c.x,c.y,c.width,c.height);a.view.ka.na(e);a.ua.Ib&&a.ua.Ib(e);return d[0].toDataURL(b)}
function fh(a,b){var c,d,e,f,g,h,k,l,n,q,r,u,v,w,z;l=p(window).width();c=p(window).height();if(b||l!==a.bd||c!==a.ad)a.bd=l,a.ad=c,w=a.ia.width()-0,l=a.ia.height()-0,0>=w||!b&&w===a.lc&&l===a.jc||(a.lc=w,a.jc=l,a.fa.ra.showBackgroundSelector?(c=100,a.ba.show(),g=a.ba,g.aa=c-24,g.$=0):(c=0,a.ba.Ma()),a.fa.ra.showImageSelector?(f=100,g=a.ha,g.aa=0,g.$=f-24,a.ha.show()):(f=0,a.ha.Ma()),a.fa.ra.showPageSelector?(a.$.ia.show(),z=a.$.ia.outerWidth()):(a.$.ia.Ma(),z=0),a.fa.fg()?(a.aa.show(),Ze(a.aa,w),
g=a.aa.height()):(a.aa.Ma(),g=0),a.log("Colour panel height is %s",g),a.fa.gg()?(a.toolbar.show(!0),d=l-g,e=a.toolbar,0>=d||(h=(e.Tb+2)*Math.ceil(e.la/d)+1,e.ia.style.width=""+h+"px",e.ia.style.height=""+d+"px",e.log("Toolbar width/height = %s,%s totalHeight=%s",h,d,e.la)),v=a.toolbar.width()):(a.toolbar.show(!1),v=0),d=wf(a.view),a.toolbar.moveTo(c+z,0),h=l-g,k=q=u=0,a.Ab&&(a.Ra.show(),k=a.Ra.width()),(r=a.fa.pe()&&700<=w)&&(q=300),u+=q+k,n=w-2*d-c-u,e=l-2*d-g-f,a.ba.width(c),a.ba.height(l-2*d-g),
a.ba.moveTo(0,0),a.$.ia.da("top","0"),a.$.ia.da("left","0"),a.ha.width(n),a.ha.height(f),a.ha.moveTo(c,l-2*d-g-f),f=w-2*d-v-u-c-z,a.Da.da("left",""+(z+c+v)+"px"),a.Da.da("top","0"),a.Da.da("width",""+f+"px"),a.Da.da("height",""+e+"px"),Tf(a.view,f,e),a.aa.moveTo(0,h),Ze(a.aa,w),a.aa.na(),a.Rb.da("top","0").da("right",""+(q+k)+"px"),a.Ab?(a.Ra.moveTo(w-k,0),a.Ra.height(l-2*d-g)):a.Ra.Ma(),r?(a.la.show(),a.la.moveTo(w-k-q,0),a.la.width(q),a.la.height(l-2*d-g)):a.Yc||a.la.Ma(),a.view.qd())}
function jh(a,b){var c,d;c=[];null!==a.oa&&a.oa in a.view.ka.za&&c.push(new Xd([a.oa]));b&&(d=a.view.ka.hb,c.push(new D("ImageNode",{url:b,locked:!0,layer:a.view.Ja})),c.push(new be([d],de)));a.oa=d;a.view.ya(c);a.view.Za();P(a.view)}function ph(a){a.oa=null;a.view.ka.jb(!1,function(b){"ImageNode"===b.type()&&!0===b.qa("locked")&&(a.log("Found background image at nodeid %s",b.id),a.oa=b.id)})}function nh(a,b,c,d){var e;e=a.view.ka.hb;"layer"in d||(d.layer=a.view.Ja);b.push(new D(c,d));return e}
function qh(a,b){a.focus("canvas");var c=a.view;c.Ea.fb=!0;c.Ea.Pa=!1;c.Ea.Cd=b;c.log("Showing keyboard cursor, caret=%s",b);c.na()}function rh(a){a.focus("canvas");ed(a.view)}
function ih(a){a.Ya="none";a.tb=new Vb;wg(a.fa,a.tb);a.tb.on("*",function(b,c){"toolbar"===a.Ya?a.toolbar.ub(b,c):"canvas"===a.Ya?a.view.ub(b,c):a.log("Ignore key action -- don't have focus.")});a.ia.ab("tabindex","0");Yb(a.tb,a.ia[0]);a.sa.add(function(){a.tb.detach(a.ia[0])});a.canvas.click(function(){Re()?a.Ya="canvas":a.focus("canvas")});p(a.toolbar.ia).click(function(){a.focus("toolbar")});a.aa.on("colour",function(){a.focus("canvas")});a.qb.on("goto-toolbar",function(){a.focus("toolbar")});
a.qb.on("goto-canvas",function(){a.focus("canvas")})}
function hh(a){function b(a){return 0===a.type.indexOf("key")}var c,d,e,f,g,h;a.toolbar&&(a.toolbar.ia.remove(),a.toolbar=null);var k=a.Ka.fc();a.toolbar=new Rb(a.fa.Kb(),a.fa.get("toolbarButtonSize"));if(a.fa.get("showToolbar")){a.fa.get("showPickTool")&&Ub(a.toolbar,"pick",k("pick-tool"),X(a.fa,"wd-pick.png"),function(c){G(a.view);b(c)&&qh(a)});a.fa.get("showSquareTool")&&a.toolbar.yb(X(a.fa,"wd-box.png"),k("rectangle-tool"),function(c){bg(a.view);b(c)&&rh(a)});a.fa.get("showRoundRectTool")&&a.toolbar.yb(X(a.fa,
"wd-roundrect.png"),k("rounded-rectangle-tool"),function(c){bg(a.view,{roundRadius:a.fa.get("defaultRoundRectRadius")});b(c)&&rh(a)});a.fa.get("showCircleTool")&&a.toolbar.yb(X(a.fa,"wd-circle.png"),k("circle-tool"),function(c){ag(a.view);b(c)&&rh(a)});a.fa.get("showShapeBrushTool")&&Ub(a.toolbar,"shapebrush",k("shape-brush-tool"),X(a.fa,"wd-shapebrush.png"),function(c){fg(a.view,{});b(c)&&qh(a)});a.fa.eg()&&Ub(a.toolbar,"brush",k("brush-tool"),X(a.fa,"wd-brush.png"),function(c){gg(a.view,{});b(c)&&
qh(a)});a.fa.get("showLineTool")&&Ub(a.toolbar,"line",k("line-tool"),X(a.fa,"wd-line.png"),function(c){Af(a.view,{angleArcs:a.fa.get("angleArcs")},!1);b(c)&&qh(a)});a.fa.get("showCurveTool")&&Ub(a.toolbar,"curve",k("curve-tool"),X(a.fa,"wd-curve.png"),function(c){zf(a.view,{});b(c)&&qh(a)});a.fa.get("showArrowTool")&&Ub(a.toolbar,"arrow",k("arrow-tool"),X(a.fa,"wd-arrow.png"),function(c){dg(a.view,{},!1);b(c)&&qh(a)});a.fa.get("showTextTool")&&Ub(a.toolbar,"text",k("text-tool"),X(a.fa,"wd-text.png"),
function(c){var d=a.view,e,f;"interactive"===d.fa.get("textMode")?Cf(d):(e=d.ka.hb,f=d.Ta(new y(100,100)),f=new E(f.x,f.y),d.ya([new D("TextNode",{text:d.fa.ra.defaultText,fontSize:d.va.fontSize,fontName:d.va.fontName,bold:d.va.bold,italic:d.va.italic,textFillStyle:d.va.textFillStyle,strokeStyle:d.va.textStrokeStyle,lineWidth:d.va.textLineWidth,layer:d.Ja}),new Hc([e],f,f.inverse())]));b(c)&&qh(a,!0)});c=function(b){a.toolbar.yb(d,b.name,function(c){a.log("Custom button %s clicked.",b.name);b.onclick.call(c.target,
a.ua)})};g=0;for(h=sh.length;g<h;g++)e=sh[g],f=e.name,d=e.image,a.log("add custom button %s",f),c(e);Tb(a.toolbar,"pick");a.fa.ra.showImageTool&&a.toolbar.yb(X(a.fa,"wd-image.png"),k("image-tool"),function(){$f(a.view,"logo.png")});a.fa.ra.showMoveToFrontBack&&(a.toolbar.yb(X(a.fa,"wd-moveup.png"),k("bring-to-front"),function(){a.view.Bc()}),a.toolbar.yb(X(a.fa,"wd-movedown.png"),k("send-to-back"),function(){a.view.Rc()}));a.fa.get("showUndoRedo")&&(a.toolbar.yb(X(a.fa,"wd-undo.png"),k("undo"),function(){a.view.Va()}),
a.toolbar.yb(X(a.fa,"wd-redo.png"),k("redo"),function(){a.view.Sb()}));a.fa.get("showCopyPaste")&&(a.toolbar.yb(X(a.fa,"wd-copy.png"),k("copy"),function(){a.view.dc()}),a.toolbar.yb(X(a.fa,"wd-paste.png"),k("paste"),function(){a.view.Jc()}))}a.toolbar.on("click",function(){a.focus("toolbar")});a.toolbar.ia.style.position="absolute";a.toolbar.ia.style.left="0";a.toolbar.ia.style.right="0";a.ia.append(a.toolbar.ia)}
function lh(a,b){a.oa=null;Pf(a.view,b);gh(a);ph(a);a.ua&&(a.ua.emit("document-changed"),a.ua.emit("set-page",b.ob));for(var c=0;c<a.sb.length;c++){var d=a.sb[c];a.log("Removing old DomElement of type %s",d.tagName);p(d).remove()}a.sb=[]}
function gh(a){a.fa.ra.sloppy||jg(a.view,"sloppiness",0);var b;b=(""+a.fa.ra.defaultSmoothness).toLowerCase();jg(a.view,"smoothness","sharpest"===b?0:"sharper"===b?.1:"sharp"===b?.2:"smoothest"===b?.5:.3);jg(a.view,"fillStyle",a.fa.ra.defaultFillStyle);jg(a.view,"strokeStyle",a.fa.ra.defaultStrokeStyle);jg(a.view,"fontName",a.fa.ra.defaultFont);jg(a.view,"fontSize",a.fa.ra.defaultFontSize);jg(a.view,"lineWidth",a.fa.ra.defaultLineWidth);jg(a.view,"textFillStyle",a.fa.ra.defaultTextFillStyle)}
function kh(a){var b,c,d,e,f;a.canvas[0].getContext("2d");e=a.fa.ra.fonts;f=[];c=0;for(d=e.length;c<d;c++)b=e[c],a.log("Preloading: %s",b),b=p("<div>").da("font-family",b).text("abcd"),b.da("color","transparent"),f.push(a.ia.append(b))};function Y(a,b){this.ba={};this.aa=0;this.$=[];this.ha=0;this.app=new eh(this,a,b);th(this);this.Ib=null;var c=this;this.app.sa.add(function(){delete c.ba;delete c.$;delete c.app;delete c.Ib})}
Y.prototype={log:t("CONTEXT"),gf:function(){1<this.aa&&this.mb("abortTransaction is not implemented for nested calls. Please contact support.");this.aa=0;this.$=[]},ve:function(a){var b=this.app.Ka;bb(b,a,b.data)},hf:function(){return this.Ec(this.Mb())},Rd:function(){this.aa+=1;1===this.aa?(this.$=[],this.ha=0,this.log("beginTransaction() -- beginning new")):this.log("beginTransaction() -- already in one, bump counter")},Bc:function(){this.app.view.Bc()},bc:function(){return this.app.view.ka.bc()},
cc:function(){return this.app.view.ka.cc()},Za:function(){this.app.view.Za();P(this.app.view);this.app.view.na()},lf:function(){ye(this.app.view.ka)},mf:function(a,b){this.Sc(a,!b)},of:function(){this.aa=Math.max(0,this.aa-1);0===this.aa?(this.app.view.ya(this.$,!0),this.$=[],this.ha=0,this.log("committing irreversible transaction.")):this.log("delaying transaction commit -- nested call (count=%s)",this.aa)},Dd:function(){this.aa=Math.max(0,this.aa-1);0===this.aa?(this.app.view.ya(this.$),this.$=
[],this.ha=0,this.log("committing transaction.")):this.log("delaying transaction commit -- nested call (count=%s)",this.aa)},dc:function(a){return this.app.view.dc(a)},qc:function(a){if(0<a.length)return Z(this,this.app.qc(this.$,a))},we:function(a,b){this.log("createNode(%s)",a);var c={},d;for(d in b)if(b.hasOwnProperty(d)){var e=b[d];"matrix"===d?(e=new M(e),c.matrix=e,c.inverse=e.inverse()):c[d]=e}return Z(this,nh(this.app,this.$,a,c))},xe:function(a){return Z(this,mh(this.app,this.$,a))},ze:function(a,
b){function c(a,b){b.click(function(b){a.onclick.call(this,d,b)})}a=Ne(a);ie(b)||this.error("createToolbar: second paramter must be array");var d=this,e;e="javascript:void(0)";for(var f=0;f<b.length;f++){var g=b[f],h=p("<a>").ab("href",e);h.da("background-repeat","no-repeat");h.da("background-position","center");h.da("display","inline-block");Na(h,"zwibbler-button");g.onclick&&c(g,h);g.title&&h.ab("title",g.title);g.background?h.da("background",g.background):g.image&&h.da("background-image","url("+
g.image+")");a.append(h)}},pf:function(a,b){"string"===typeof b&&(b=p("#"+b));if("PageSelector"===a){this.log("Creating page selector");var c=new df(b,!1,!1);hf(c,!0);gf(c,this);ff(c)}else return this.mb("Cannot create UI Elemment %s",a),!1;return!0},ye:function(a){var b=this.app,c=this.$,d,e,f,g,h,k;if(6>a.length)b.log("newShape: Cannot create shape with fewer than three points."),a=void 0;else{d=new N;f=h=0;for(k=a.length-1;h<=k;f=h+=2)g=b.view.Ta(new y(a[f],a[f+1])),0===f?(d.moveTo(g.x,g.y),e=
g):d.lineTo(g.x,g.y);d.lineTo(e.x,e.y);d.close();a=mh(b,c,d.Eb())}return Z(this,a)},Ed:function(){var a=this.app.view.dc(!1);this.Vd();return a},Be:function(){var a=this.app.sa;a.log("Running %s destructors",a.$.length);for(var b=a.$.length-1;0<=b;b--)a.$[b]();a.$=null},Ae:function(a){this.Td(a)},Td:function(a){this.log("deleteNodes()");if(T(a)||a.length){var b=this.$;ie(a)||(a=[a]);b.push(new Xd(a));Z(this,void 0)}},Ud:function(){if(1===this.Mb())this.log("Cannot remove all the pages.");else{var a=
this.app.view.ka;this.$.push(new Xd([a.$[a.ob].id]));Z(this)}},Vd:function(){xf(this.app.view)},ec:function(){if(1===arguments.length&&!1===arguments[0]){var a=this.app.view.ka;a.cb=a.la.next}return this.app.view.ka.ec()},Ce:function(a,b,c){"jpeg"===a&&(a="jpg");var d,e;if("pdf"===a||"svg"===a||"png"===a||"jpg"===a){("pdf"===a||"svg"===a)&&"Blob"in window?e=this.app.view.ka.save(a,"blob"):"png"===a||"jpg"===a?(d=this.save(a,c),"Blob"in window&&(e=Ve(d))):d=this.app.view.ka.save(a,"data-uri");if(e){if(window.navigator.msSaveOrOpenBlob){this.log("Using msSaveOrOpenBlob()");
window.navigator.msSaveOrOpenBlob(e,b);return}d=window.URL.createObjectURL(e)}var f=document.createElement("a");f.innerHTML="download";f.setAttribute("href",d);f.setAttribute("download",b);f.style.display="none";document.body.appendChild(f);f.click();setTimeout(function(){document.body.removeChild(f)},100)}else this.log("unsupported format for download: %s",a)},na:function(a,b){b=b||{};var c=b.page||0,d=this.app.view.ka.ob,e=te(this.app.view.ka);this.app.view.ka.lb(c);Vf(this.app.view,a,0,0,e.width,
e.height);this.app.view.ka.na(a);this.app.view.ka.lb(d)},duplicate:function(){this.app.view.duplicate()},emit:function(a,b){var c,d=this;this.ba||(this.ba={});c=Array.prototype.slice.call(arguments,1);setTimeout(function(){var b,f,g,h;if(a in d.ba)for(h=d.ba[a],f=0,g=h.length;f<g;f++)b=h[f],b.apply(null,c)},0);return this},rc:function(a,b){var c;this.ba||(this.ba={});c=Array.prototype.slice.call(arguments,1);var d,e,f,g;if(a in this.ba)for(g=this.ba[a],e=0,f=g.length;e<f;e++)d=g[e],d.apply(null,c)},
focus:function(){this.app.focus("canvas")},rf:function(a){a=this.Xd(a);return a.length?a[0]:null},Xd:function(a){var b=this.app.view.ka,c=[],d;for(d in b.za)if(b.za.hasOwnProperty(d)){var e=b.za[d];e.qa("tag")===a&&c.push(e)}a=[];for(b=0;b<c.length;b++)a.push(c[b].id);return a},sf:function(a,b,c){var d=null;if(3===arguments.length){if(!T(b)||!T(c)){this.mb("flip: 2nd and 3rd args must be numbers.");return}d=new y(b,c)}var e=this.app.view,f=a/180*Math.PI;0===e.selection.length&&null===e.Ca||e.log("flipSelection: selection is empty");
Yf(e,Jc(e),f,d)},De:function(a,b,c,d){var e=uh(this,a),f=null;if(4===arguments.length){if(!T(c)||!T(d)){this.mb("flip: 3rd and 4th args must be numbers.");return}f=new y(c,d)}Yf(this.app.view,e,b/180*Math.PI,f)},tf:function(a,b,c){function d(a){a.on("click contextmenu",function(b){n.call(g,a.da("background-color"),1===b.which);b.preventDefault()})}function e(){var c=p("<div>").da("width",b+"px").da("height",b+"px").da("display","inline-block");a.append(c);return c}function f(a,b){var c=document.createElement("canvas");
c.width=a;c.height=a;b(c.getContext("2d"),0,0,a);return e().append(c)}var g=this;a=Ne(a);c=c||{};var h,k,l,n=c.onColour||c.onColor||g.Sc;h=f(b,bf);h.on("click contextmenu",function(a){n.call(g,"transparent",1===a.which);a.preventDefault()});h=f(b,cf);h.on("click contextmenu",function(a){if(c.onOpacity)c.onOpacity(.5,1===a.which);else g.ne(.5,1===a.which);a.preventDefault()});for(k=0;1>=k;k+=1/13)l=(new W(2,[0,0,k,1])).toString(),d(e().da("background-color",l));for(k=.3;1>=k;k+=.7/14)for(h=0;360>h;h+=
22.5)l=(new W(2,[h,.7,k,1])).toString(),d(e().da("background-color",l));for(h=0;360>h;h+=22.5)l=(new W(2,[h,1,1,1])).toString(),d(e().da("background-color",l))},yd:function(){var a=this.app.view;a.log("getActiveLayer() -> %s",a.Ja);return a.Ja},uf:function(){var a=[];qe(this.app.view.ka,function(b){a.push(b.id)});return a},Ee:function(){var a=this.app;return null!==a.oa&&a.oa in a.view.ka.za?A(a.view.ka,a.oa).qa("url"):null},Fe:function(a){var b=this.app.view;ie(a)||(a=[a]);for(var c=null,d=0;d<a.length;d++){var e=
A(b.ka,a[d]);e&&(null===c?c=e.kb().clone():jc(c,e.kb()))}null===c&&(c=new L(0,0,0,0));return vh(c)},gc:function(){return this.app.view.ka.ob},Ge:function(){return this.app.view.Xa},He:function(){return this.app.view.bb},Ie:function(){var a=this.app.view,b=null;a.pa.Nb&&(b=a.pa.Nb());return b},wf:function(a,b){var c=x(this.app.view,a,b);return{x:c.x,y:c.y}},Cc:function(){var a=te(this.app.view.ka);return{x:a.x,y:a.y,width:a.width,height:a.height}},Je:function(){return this.app.view.va.fillStyle},zf:function(a){return this.app.Ka.get(a)},
error:function(a){alert(a)},xf:function(){return vh(this.app.view.ka.kb())},yf:function(a,b){return this.Od(a,b)},Bf:function(){var a=[],b={},c;this.app.view.ka.jb(!1,function(d){!(c=qd(d))||c in b||(b[c]=1,a.push(c))});c=this.yd();c in b||a.push(c);return a},Af:function(a){var b=[];this.app.view.ka.jb(!1,function(c){qd(c)===a&&b.push(c.id)});return b},Od:function(a,b){var c=this.app,d,e;(d=A(c.view.ka,a))&&(e=d.qa(b));c.log("GetItemProperty %s: %s=%s",a,b,e);return e},Cf:function(a){var b=A(this.app.view.ka,
a);null===b&&this.mb("Error: node %s does not exist",a);a=b.kb();return{x:a.x,y:a.y,width:a.width,height:a.height}},Ke:function(a){return(a=A(this.app.view.ka,a))?a.type():""},Df:function(a,b){var c=this.app.view.ka.gb(a,b,this.app.view.Ja);return c?c.id:null},Mb:function(){return this.app.view.ka.Mb()},kd:function(a){var b=A(this.app.view.ka,a);if("PathNode"!==b.type())return null;a=yc(b.kd().clone());var c=[];b.Ua();for(b=0;b<a.length;b++){var d=a[b];c.push(d.x);c.push(d.y)}return c},Ef:function(a){a=
A(this.app.view.ka,a);if("PathNode"!==a.type())return null;a=a.kd();for(var b=[],c=[],d=0;d<a.ea.length;){switch(a.ea[d]){case Lb:c=[{x:a.ea[d+1],y:a.ea[d+2]}];b.push(c);break;case Mb:c.push({x:a.ea[d+1],y:a.ea[d+2]})}d+=Pb[a.ea[d]]}return b},ef:function(){this.app.view.ic=this.app.la;this.app.Yc=!0;return this.app.la.ia[0]},vf:function(){return this.app.view.scale},Ff:function(a,b,c,d){var e;e=bd(this.app.view,a,b);if(void 0===c)return{x:e.x,y:e.y};a=bd(this.app.view,a+c,b+d);return vh(new L(e.x,
e.y,a.x-e.x,a.y-e.y))},Gf:function(){return this.app.view.oa},Me:function(){return this.app.view.va.strokeStyle},Gd:function(a,b){var c=A(this.app.view.ka,a);return c?c.Gd(b):null},Xf:function(a,b,c){var d=A(this.app.view.ka,a);if(!d)return this.log("setEditHandle: node %s doesn't exist.",a),!1;if("PathNode"!==d.type())return this.log("setEditHandle: node %s is not a PathNode.",a),!1;d=d.qa("commands");b=b/3;var e=0,f=[],g=new y(0,0),h=!1,k=0,l,n;for(l=0;l<d.length;){n=d[l];if(7===n){h=!0;break}k+=
1;l+=Q[d[l]]+1}0===b&&h&&(b=k-1);for(l=0;l<d.length;e++){n=d[l];h=!1;b===e&&(2===n&&"line_to"===c?(f.push(1,d[l+1],d[l+2]),h=!0):1===n&&"quadratic_to"===c&&(f.push(2,d[l+1],d[l+2],(g.x+d[l+1])/2,(g.y+d[l+2])/2),h=!0));g=new y(d[l+1],d[l+2]);if(!h)for(n=0;n<1+Q[d[l]];n++)f.push(d[l+n]);l+=Q[d[l]]+1}d=f;if(!d)return this.log("setEditHandle: failed"),!1;this.Ad(a,"commands",d);return!0},Le:function(a){return Rf(this.app.view,a)},If:function(){return vh(Uf(this.app.view))},mb:function(a,b){for(var c=
arguments[0].split("%s"),d=[],e=0;e<c.length;e++)d.push(c[e]),e<c.length-1&&d.push(JSON.stringify(arguments[e+1]));this.log(d.join(""));throw{message:d,toString:function(){return d}};},Ec:function(a){var b=this.app.view.ka.hb;this.$.push(new D("PageNode",{},this.app.view.ka.root.id,a));Z(this,b);return a},Jd:function(a){return this.app.view.ka.Jd(a)},Ne:function(a,b){1===arguments.length&&(b=arguments[0],a="zwibbler3");var c;"list"===a?(lh(this.app,dh(b)),c=void 0):c=lh(this.app,bh(b));return c},
Oe:function(a){var b=this;T(a)||this.error("lockUpdates: Expected a number");this.la&&clearTimeout(this.la);this.la=setTimeout(function(){Xf(b.app.view,!1)},a);Xf(b.app.view,!0)},od:function(){this.app.view.od()},pd:function(){this.app.view.pd()},Pe:function(){var a=this.app;lh(a,new me);null!==a.fa.ra.backgroundImage&&(jh(a,a.fa.ra.backgroundImage),ye(a.view.ka));th(this)},Qe:function(){this.mc(Math.min(this.gc()+1,this.Mb()-1))},on:function(a,b){"draw"===a?this.Ib=b:a in this.ba?this.ba[a].push(b):
this.ba[a]=[b];return this},Pf:function(a){"function"===typeof a||this.mb("Error: onComplete needs a function argument.");var b=this.app.view;b.request.$?(b.log("Formatting in progress; will call function soon"),qb(b.request,a)):(b.log("Format already done; call function in 1 tick"),setTimeout(a,0))},Jc:function(a){this.app.view.Jc(a)},Rf:function(){this.mc(Math.max(this.gc()-1,0))},Re:function(a,b){var c=[],d;if(T(a))c.push(a);else if(ie(a))for(d=0;d<a.length;d++)T(a[d])?c.push(a[d]):this.error("print(): pageSpec must be array of numbers");
else if(!a)for(d=0;d<this.Mb();d++)c.push(d);b=b?wh(b):wh(this.Cc());var e=this.gc(),f=document.createElement("canvas");f.width=b.width;f.height=b.height;var g=f.getContext("2d");g.translate(-b.x,-b.y);var h=window.open("about:blank","_blank");h.document.write("<!DOCTYPE html><html><body>");for(d=0;d<c.length;d++)this.mc(c[d]),Vf(this.app.view,g,b.x,b.y,b.width,b.height),this.app.view.ka.na(g),0<d?h.document.write("<div style='page-break-before:always'>"):h.document.write("<div>"),h.document.write("<img style='width:100%' src='"),
h.document.write(f.toDataURL()),h.document.write("'></div>"),g.clearRect(b.x,b.y,b.width,b.height);h.document.write("</body></html>");h.document.close();h.focus();h.print();h.close();this.mc(e)},Sb:function(){this.app.view.Sb()},Se:function(a){this.app.view.na(a)},Te:function(){var a=this;setTimeout(function(){fh(a.app,!0)},1)},save:function(a,b){a=a||"zwibbler3";var c={jpeg:"image/jpeg",jpg:"image/jpeg",png:"image/png"};b=wh(b||this.Cc());switch(a){case "list":return this.app.view.ka.save("list",
"object");case "png":case "jpeg":case "jpg":return oh(this.app,c[a],b);case "zwibbler3":return this.app.view.ka.save("zwibbler3","string");case "svg":case "pdf":return this.app.view.ka.save(a,"string");case "image/png":case "image/jpeg":for(var d=oh(this.app,a,b),d=d.substr(d.indexOf(",")+1),c=["base64"],e=0;e<c.length;e++)d=ea[c[e]](d);return d;default:return"Unsupported format: "+a}},Vf:function(a){p(this.app.view.canvas).da("cursor",a)},selectNodes:function(a){a=uh(this,a);this.app.view.selectNodes(a);
P(this.app.view);this.app.view.na()},Rc:function(){this.app.view.Rc()},Pd:function(a){var b=this.app.view;b.log("setActiveLayer(%s)",a);b.Ja=a;b.Za();P(b);b.na()},Tf:function(a,b){var c=this.app,d,e,f,g;Eg(c.ba);b&&(d=c.ba,d.aa=b,d.$=b);g=[];e=0;for(f=a.length;e<f;e++)d=a[e],"string"===typeof d?g.push(Fg(c.ba,d,d)):g.push(Fg(c.ba,d.small,d.large,d.tooltip))},Uf:function(a,b){"defaultPaperSize"===a&&this.Md(b);return ug(this.app.fa,a,b)},Sc:function(a,b){this.app.view.Bb(a,b)},mc:function(a){this.app.view.lb(a)},
Ve:function(a){var b=this.app.view;a?(b.log("Setting a custom background function."),b.la=a):b.log("Clearing custom background function.")},zd:function(a,b){!T(a)&&null!==a||!T(b)&&null!==b?alert("setDocumentSize: width/height must be numbers"):cg(this.app.view,a,b)},le:function(a,b){!T(a)&&null!==a||!T(b)&&null!==b?alert("setDocumentSize: width/height must be numbers"):Z(this,cg(this.app.view,a,b,this.$))},Wf:function(a,b){var c=A(this.app.view.ka,a);c||this.mb("setDomElement: Node %s does not exist",
a);"DomNode"!==c.type()&&this.mb("setDomElement: Node %s is not a DomNode. It is %s",a,c.type());c.me(b);this.app.sb.push(b)},$f:function(a,b){je(a)&&je(b)?(this.yd()===a&&this.Pd(b),this.app.view.ka.jb(!1,function(c){qd(c)===a&&c.setProperty("layer",b)})):this.mb("setLayerName() needs string arguments.")},Md:function(a){var b=null,c=null,d,e=!0,f=!1;if(2===arguments.length)T(arguments[0])&&T(arguments[1])?(d=arguments[0],b=arguments[1]):je(arguments[0])&&"boolean"===typeof arguments[1]?(c=arguments[0],
f=arguments[1]):e=!1;else if(1===arguments.length&&je(arguments[0]))for(var g=arguments[0].split(" "),h=0;h<g.length;h++)"landscape"===g[h]?f=!0:"portrait"===g[h]?f=!1:c=g[h];if(!1===e)return this.log("Bad arguments to setPaperSize()."),!1;if(null===c)return this.zd(d,b),!0;switch(c.toLowerCase()){case "letter":d=816;b=1056;break;case "legal":d=816;b=1344;break;case "11x17":d=1056;b=1632;break;case "tabloid":d=1056;b=1632;break;case "a0":d=841/25.4*96;b=1189/25.4*96;break;case "a1":d=594/25.4*96;
b=841/25.4*96;break;case "a2":d=420/25.4*96;b=594/25.4*96;break;case "a3":d=297/25.4*96;b=420/25.4*96;break;case "a4":d=210/25.4*96;b=297/25.4*96;break;case "none":b=d=null;break;default:return this.log("Invalid paper size: %s",c),!1}f&&(c=d,d=b,b=c);this.zd(d,b);return!0},Yf:function(a,b){var c=this.app,d,e,f,g;Eg(c.ha);g=[];b&&(d=c.ha,d.aa=b,d.$=b);e=0;for(f=a.length;e<f;e++)d=a[e],"string"===typeof d?g.push(Fg(c.ha,d,d)):g.push(Fg(c.ha,d.small,d.large,d.tooltip))},Zf:function(a,b,c){this.Ad(a,
b,c)},We:function(a,b){if(2!==arguments.length)throw"Error: setNodeProperties takes 2 arguments.";var c=this.$,d=a,e;this.app.log("External app setNodeProperty %s: %s",d,b);ie(d)||(d=[d]);for(e in b)b.hasOwnProperty(e)&&c.push(new Zc(d,e,b[e]));return Z(this,void 0)},Ad:function(a,b,c){var d=this.$;this.app.log("External app setItemProperty %s: %s=%s",a,b,c);var e;ie(a)?e=a:e=[a];d.push(new Zc(e,b,c));return Z(this,void 0)},ag:function(a,b){ie(a)||(a=[a]);for(var c=0;c<a.length;c++){var d=A(this.app.view.ka,
a[c]);d&&d.Tc(!b)}this.app.view.na()},ne:function(a,b){var c=this.app.view;c.pa.Qb?(c.log("Simulating opacity change %s",a),c.pa.Qb(a,b)):c.log("An opacity is not needed for this tool.")},Ye:function(a){var b=this.app.view;b.Ra=a;a=Bf(b);b.Ha=-a.x;b.Ga=-a.y;H(b);b.na()},cg:function(a){"object"===typeof a&&T(a.x)&&T(a.y)&&T(a.width)&&T(a.height)||this.mb("setViewRect: arg must be an object with numeric x, y, width, height properties");0!==a.width&&0!==a.height||this.mb("setViewRect: width and height must be non-zero.");
var b=this.app.view;a=wh(a);b.log("setViewRect(%s)",a);var c=b.nb,c=Math.min(c.width/a.width,c.height/a.height),d=a.y*c;b.Ha=-(a.x*c);b.Ga=-d;b.scale=c;b.sa="none";H(b);b.na()},dg:function(a){T(a)||"page"===a||"width"===a?Qf(this.app.view,a):this.log("setZoom: invalid parameter.")},Vc:function(a,b){this.app.view.Vc(a,b)},Qd:function(a,b,c){this.log("Translate node %s by %s,%s actions=%s",a,b,c,this.$.length);var d=this.$;ie(a)||(a=[a]);b=new E(b,c);d.push(new Hc(a,b,b.inverse()));return Z(this,!0)},
Sf:function(a){var b=Math.round(a/(Math.PI/2));a=b*Math.PI/2;var b=0===b%2,c=xh(this),d=this.Cc(),e=d.width/2,f=d.height/2;this.Rd();for(var g=0;g<c.length;g++)this.ke(c[g],a,e,f),b||this.Qd(c[g],f-e,e-f);b||this.le(d.height,d.width);this.Dd()},ke:function(a,b,c,d){this.log("Rotate node %s by %s around (%s,%s) actions=%s",a,b/Math.PI*180,c,d,this.$.length);var e=A(this.app.view.ka,a);null===e&&this.mb("rotateNode: Node %s doesn't exist",a);4>arguments.length&&(e=hc(e.kb()),c=e.x,d=e.y);e=new oc(b,
c,d);this.$.push(new Hc([a],e,e.inverse()));return Z(this,!0)},Ue:function(a,b,c,d,e){this.log("Scale node %s by %s,%s actions=%s",a,b,c,this.$.length);b=new nc(b,c,d||0,e||0);this.$.push(new Hc([a],b,b.inverse()));return Z(this,!0)},Xe:function(a,b,c,d,e,f,g){7!==arguments.length&&this.mb("setNodeTransform: requires 7 arguments");this.log("setNodeTransform(id=%s %s %s %s %s %s %s %s)",a,b,c,d,e,f,g);var h=this.$,k=a;ie(k)||(k=[k]);var l;l=new M(b,d,c,e,f,g);h.push(new Zc(k,"matrix",l));h.push(new Zc(k,
"inverse",l.inverse()));return Z(this,!0)},Va:function(){this.app.view.Va()},Zc:function(a){return Z(this,this.app.Zc(this.$,a))},Ze:function(a,b){function c(){}function d(){}var e=new lg(this.app.Rb,b||"Working"),f=new XMLHttpRequest,g=new FormData(a);f.upload.addEventListener("progress",function(a){e.update(a.loaded/a.total)},!1);f.addEventListener("load",function(){200===f.status?(e.done(),d(f.response,f)):(e.error("Error"),c(f,f))},!1);f.addEventListener("error",function(){e.error("Error");c(f,
f)},!1);f.addEventListener("abort",function(){e.error("Aborted");c(f)},!1);f.open(a.method,a.action);f.send(g);var h={success:function(a){d=a;return h},error:function(a){c=a;return h}};return h},jg:function(a,b){dg(this.app.view,a,b)},kg:function(a,b){2===arguments.length?gg(this.app.view,{lineWidth:b,strokeStyle:a}):gg(this.app.view,arguments[0]||{})},lg:function(a){ag(this.app.view,a)},mg:function(a){zf(this.app.view,a)},ng:function(a){"object"===typeof a||this.error("useCustomTool(): requires an object as argument.");
C(this.app.view,new kg(this.app.view,a))},$e:function(a){var b=this.app.view,c=A(b.ka,a);c?c.md()?(G(b),b.Za(),P(b),b.Ca=c,b.na()):b.log("useEditHandleTool: nodetype %s has no edit mode",c.type()):b.log("useEditHandleTool: node %s doesn't exist.",a)},af:function(){ag(this.app.view)},og:function(a,b,c){"object"===typeof a?c=b:a={strokeStyle:a,lineWidth:b};eg(this.app.view,a,c||"freehand")},xg:function(a){var b=this.app.view;C(b,new hb(b,a))},pg:function(a,b){Af(this.app.view,a,b)},qg:function(){var a=
this.app.view;C(a,new ib(a))},rg:function(){G(this.app.view)},bf:function(a,b,c){var d=this.app.view;c=c||1;var e;e=new N;for(var f=0;f<=a;f++){var g=50*Math.sin(b),h=50*-Math.cos(b);f&1&&(g*=c,h*=c);0===f?e.moveTo(g,h):e.lineTo(g,h);b+=2*Math.PI/a}e.close();a={commands:e.Eb(),fillStyle:d.Xa,strokeStyle:d.bb,seed:Math.round(65535*Math.random()),lineWidth:d.va.lineWidth,sloppiness:d.va.sloppiness,layer:d.Ja,wrap:d.fa.get("multilineText"),fontSize:d.fa.get("defaultFontSize")};d.log("Create an item on layer %s",
d.Ja);C(d,new Oc(d,"PathNode",a,100,100,"circle"))},sg:function(a){eg(this.app.view,a||{},"quadratic")},cf:function(a){bg(this.app.view,a)},tg:function(a){bg(this.app.view,p.$({},{roundRadius:this.app.fa.get("defaultRoundRectRadius")},a||{}))},ug:function(a,b){fg(this.app.view,{strokeStyle:a,lineWidth:b})},df:function(a,b,c,d,e){var f=this.app.view;C(f,new Oc(f,a,b,c,d,e))},wg:function(a){var b=this.app.view;b.fa.get("readOnly")?b.log("readOnly mode: Ignoring tool click."):C(b,new Sd(b,"stampline",
a))},vg:function(a){bg(this.app.view,a)},yg:function(){Cf(this.app.view)},cd:function(){this.app.view.cd()},dd:function(){this.app.view.dd()}};function uh(a,b){var c=[];T(b)&&(b=[b]);for(var d=0;d<b.length;d++){var e=A(a.app.view.ka,b[d]);e&&c.push(e)}return c}function th(a){var b=a.app.fa.get("defaultPaperSize");a.log("onNewDocument()");"none"!==b&&a.Md(b)}function wh(a){return new L(a.x||0,a.y||0,a.width||0,a.height||0)}function vh(a){return{x:a.x,y:a.y,width:a.width,height:a.height}}
function xh(a){var b=[];a.app.view.ka.jb(!1,function(a){b.push(a.id)});return b}function Z(a,b){if(!a.aa)return a.log("Not in a transaction. committing immediately. id=%s",b),a.Dd(),b;if("number"===typeof b)return a.ha+=1,a.log("id=%s numCreated=%s realid=%s",b,a.ha,b+a.ha-1),b+a.ha-1};"jQuery"in window&&(window.jQuery.fn.zwibbler=function(a){a=a||{};var b=null;this.each(function(c,d){d.zwibbler&&p(d).empty();b=new Y(p(d),a);d.zwibbler=b});return b},window.jQuery.fn.zwibblerContext=function(){return this[0].zwibbler});var sh=[],Ed={};
window.Zwibbler={create:function(a,b){"string"===typeof a&&0<a.length&&"."!==a.charAt(0)&&"#"!==a.charAt(0)&&(a="#"+a);var c=Ne(a);return null===c?(alert("Zwibbler.create: Cannot find an element with id "+a),null):new Y(p(c),b)},addButton:function(a){for(var b=["name","image","onclick"],c=0;c<b.length;c++)if(!(b[c]in a))return alert("Zwibbler.addButton: missing "+b[c]),!1;sh.push(a);return!0},addCustomNode:function(a,b){Ed[a]=b},Dialog:function(a,b){function c(){var a=d.outerWidth(),b=d.outerHeight(),
c=We();d.offset({left:c.x+c.width/2-a/2,top:c.y+c.height/2-b/2})}var d=Ne(a);null===d[0].parentNode&&p(document.body).append(d);"static"===d.da("position")&&d.da("position","absolute");d.da("display","none");b=b||{};var e=Se(d[0]),f=new aa("transparent");d.da("z-index",""+e);f.$=e;f.insertBefore=d;var g=b.showNear,h=b.showHow,k={hide:function(){f.Ma();d.Ma();if(k.onhide)k.onhide();p(window).Ac("resize",c)},show:function(a,b){var e,r;2===arguments.length&&T(a)&&T(b)?(e=a,r=b):(a=a||g,b=b||h);d.show();
var u=d.outerWidth(),v=d.outerHeight();if(void 0!==e){var w=We();e={left:e,top:r};e.left=Math.min(e.left,w.x+w.width-u-2);e.top=Math.min(e.top,w.y+w.height-v-3);d.offset(e)}else a&&b?(w=Ne(a),u=d,e=b,v=w.offset(),e=e.toLowerCase().split(" "),2!==e.length&&(e=["tl","tl"]),0<=e[0].indexOf("b")&&(v.top+=w.outerHeight()),0<=e[0].indexOf("r")&&(v.left+=w.outerWidth()),0<=e[1].indexOf("b")&&(v.top-=u.outerHeight()),0<=e[1].indexOf("r")&&(v.left-=u.outerWidth()),u.da("position","absolute"),w=We(),e=u.width(),
r=u.height(),v.left=Math.min(v.left,w.x+w.width-e),v.top=Math.min(v.top,w.y+w.height-r),u.offset(v)):(p(window).on("resize",c),c());f.show(k.hide);if(k.onshow)k.onshow()},onshow:b.onshow,onhide:b.onhide};return k},ColourWheel:function(a,b){a=p(a)[0];var c=new of(a,b),d=new J;c.Ka=function(a){d.emit("change",a)};return{on:function(a,b){d.on(a,b)},colour:function(){if(arguments.length)qf(c,arguments[0]);else return c.aa.toString()}}},SlidingPanel:function(a,b){b=b||{};var c=b.autohide,d;d="string"===
typeof a?p("#"+a):p(a);var e=new rb(d);if(b.onshow)e.on("show",b.onshow);if(b.onhide)e.on("hide",b.onhide);return{show:function(a){e.show(a,c)},hide:function(){e.Ma()}}},createPreview:function(a,b){return window.Zwibbler.render(a,b)},render:function(a,b){function c(){var a=q.kb(),b=1,c=0,r=0;f&&(a.y=f);k&&(a.height=k-a.y);g&&(a.x=g);h&&(a.width=h-a.x);d&&e?b=Math.min(d/a.width,e/a.height):d?(b=d/a.width,e=a.height*b):e?(b=e/a.height,d=a.width*b):(d=a.width,e=a.height);a.width*b<d&&(c=d/2-a.width*
b/2);a.height*b<e&&(r=e/2-a.height*b/2);c-=a.x*b;r-=a.y*b;l.width=Math.ceil(d);l.height=Math.ceil(e);n.translate(c,r);n.scale(b,b);q.na(n)}b=b||{};var d=b.width||0,e=b.height||0,f=b.top||0,g=b.left||0,h=b.right||0,k=b.bottom||0,l=Oe(null),n=l.getContext("2d"),q=bh(a),r=new xb;q.format(n,r);r.on("reformat",function(a){Qc(q,a.id)});if(r.$)r.on("done",function(){q.format(n,r);c()});else c();return l},parseColour:function(a){a=Qd(a);return{r:a.values[0],g:a.values[1],b:a.values[2],a:a.values[3]}},makeColour:function(a){return(new W(0,
[a.r,a.g,a.b,a.a])).toString()},getAbsoluteUrl:function(a){var b=document.createElement("a");b.href=a;return b.href},base64Encode:function(a){return ha(a)},fonts:new Ie,addFont:function(a,b){window.Zwibbler.fonts.add(b,a)},PathCommands:function(a){return new N(a)},CommandsFromSvgPath:function(a){a=a.match(/[A-Z]|-?[0-9\.E]+/gi);for(var b=0,c=0,d=0,e,f=[],g=new N,d=0;d<a.length;d++){e=a[d++];for(f.length=0;d<a.length;d++){var h=parseFloat(a[d]);if(isNaN(h)){d--;break}else f.push(h)}if("M"===e){g.moveTo(f[0],
f[1]);for(e=2;e<f.length;e+=2)g.lineTo(f[e],f[e+1]);b=f[f.length-2];c=f[f.length-1]}else if("m"===e)for(g.moveTo(f[0]+b,f[1]+c),b=f[0]+b,c=f[1]+c,e=2;e<f.length;e+=2)g.lineTo(f[e]+b,f[e+1]+c),b=f[e]+b,c=f[e+1]+c;else if("L"===e){for(e=0;e<f.length;e+=2)g.lineTo(f[e],f[e+1]);b=f[f.length-2];c=f[f.length-1]}else if("l"===e)for(e=0;e<f.length;e+=2)g.lineTo(f[e]+b,f[e+1]+c),b=f[e]+b,c=f[e+1]+c;else if("C"===e)for(e=0;e<f.length;e+=6)g.aa(f[e],f[e+1],f[e+2],f[e+3],f[e+4],f[e+5]),b=f[e+4],c=f[e+5];else if("c"===
e)for(e=0;e<f.length;e+=6)g.aa(f[e]+b,f[e+1]+c,f[e+2]+b,f[e+3]+c,f[e+4]+b,f[e+5]+c),b=f[e+4]+b,c=f[e+5]+c;else"z"!==e&&"Z"!==e||g.close()}return g.Eb()}};N.prototype.change=N.prototype.ha;N.prototype.moveTo=N.prototype.moveTo;N.prototype.lineTo=N.prototype.lineTo;N.prototype.curveTo=N.prototype.fd;N.prototype.quadraticTo=N.prototype.ba;N.prototype.cornerTo=N.prototype.$;N.prototype.bezierTo=N.prototype.aa;N.prototype.arcTo=N.prototype.arcTo;N.prototype.getBoundingBox=N.prototype.la;N.prototype.translate=N.prototype.translate;N.prototype.close=N.prototype.close;N.prototype.toArray=N.prototype.Eb;Fd.prototype.setElement=Fd.prototype.me;
Y.prototype.log=Y.prototype.log;Y.prototype.abortTransaction=Y.prototype.gf;Y.prototype.addToLanguage=Y.prototype.ve;Y.prototype.addPage=Y.prototype.hf;Y.prototype.beginTransaction=Y.prototype.Rd;Y.prototype.bringToFront=Y.prototype.Bc;Y.prototype.canRedo=Y.prototype.bc;Y.prototype.canUndo=Y.prototype.cc;Y.prototype.clearSelection=Y.prototype.Za;Y.prototype.clearUndo=Y.prototype.lf;Y.prototype.clickColour=Y.prototype.mf;Y.prototype.commitIrreversibleTransaction=Y.prototype.of;
Y.prototype.commitTransaction=Y.prototype.Dd;Y.prototype.copy=Y.prototype.dc;Y.prototype.createGroup=Y.prototype.qc;Y.prototype.createNode=Y.prototype.we;Y.prototype.createPath=Y.prototype.xe;Y.prototype.createToolbar=Y.prototype.ze;Y.prototype.createUiElement=Y.prototype.pf;Y.prototype.createShape=Y.prototype.ye;Y.prototype.cut=Y.prototype.Ed;Y.prototype.destroy=Y.prototype.Be;Y.prototype.deleteNode=Y.prototype.Ae;Y.prototype.deleteNodes=Y.prototype.Td;Y.prototype.deletePage=Y.prototype.Ud;
Y.prototype.deleteSelection=Y.prototype.Vd;Y.prototype.dirty=Y.prototype.ec;Y.prototype.download=Y.prototype.Ce;Y.prototype.draw=Y.prototype.na;Y.prototype.duplicate=Y.prototype.duplicate;Y.prototype.emit=Y.prototype.emit;Y.prototype.focus=Y.prototype.focus;Y.prototype.findNode=Y.prototype.rf;Y.prototype.findNodes=Y.prototype.Xd;Y.prototype.flip=Y.prototype.sf;Y.prototype.flipNodes=Y.prototype.De;Y.prototype.generatePalette=Y.prototype.tf;Y.prototype.getActiveLayer=Y.prototype.yd;
Y.prototype.getAllNodes=Y.prototype.uf;Y.prototype.getBackgroundImage=Y.prototype.Ee;Y.prototype.getBoundingRectangle=Y.prototype.Fe;Y.prototype.getCurrentPage=Y.prototype.gc;Y.prototype.getCurrentFillColour=Y.prototype.Ge;Y.prototype.getCurrentOutlineColour=Y.prototype.He;Y.prototype.getCurrentTool=Y.prototype.Ie;Y.prototype.getDocumentCoordinates=Y.prototype.wf;Y.prototype.getDocumentSize=Y.prototype.Cc;Y.prototype.getFillColour=Y.prototype.Je;Y.prototype.getLanguageString=Y.prototype.zf;
Y.prototype.getDrawingRectangle=Y.prototype.xf;Y.prototype.getItemProperty=Y.prototype.yf;Y.prototype.getLayers=Y.prototype.Bf;Y.prototype.getLayerNodes=Y.prototype.Af;Y.prototype.getNodeProperty=Y.prototype.Od;Y.prototype.getNodeRectangle=Y.prototype.Cf;Y.prototype.getNodeType=Y.prototype.Ke;Y.prototype.getNodeUnderPoint=Y.prototype.Df;Y.prototype.getPageCount=Y.prototype.Mb;Y.prototype.getPathData=Y.prototype.kd;Y.prototype.getPathAsPoints=Y.prototype.Ef;Y.prototype._getPropertyPanelElement=Y.prototype.ef;
Y.prototype.getCanvasScale=Y.prototype.vf;Y.prototype.getScreenCoordinates=Y.prototype.Ff;Y.prototype.getSelectedEditHandle=Y.prototype.Gf;Y.prototype.getStrokeColour=Y.prototype.Me;Y.prototype.getEditHandleType=Y.prototype.Gd;Y.prototype.setEditHandle=Y.prototype.Xf;Y.prototype.getSelectedNodes=Y.prototype.Le;Y.prototype.getViewRectangle=Y.prototype.If;Y.prototype.insertPage=Y.prototype.Ec;Y.prototype.isLayerVisible=Y.prototype.Jd;Y.prototype.load=Y.prototype.Ne;Y.prototype.lockUpdates=Y.prototype.Oe;
Y.prototype.moveDown=Y.prototype.od;Y.prototype.moveUp=Y.prototype.pd;Y.prototype.newDocument=Y.prototype.Pe;Y.prototype.nextPage=Y.prototype.Qe;Y.prototype.on=Y.prototype.on;Y.prototype.onComplete=Y.prototype.Pf;Y.prototype.paste=Y.prototype.Jc;Y.prototype.previousPage=Y.prototype.Rf;Y.prototype.print=Y.prototype.Re;Y.prototype.redo=Y.prototype.Sb;Y.prototype.redraw=Y.prototype.Se;Y.prototype.resize=Y.prototype.Te;Y.prototype.save=Y.prototype.save;Y.prototype.setCursor=Y.prototype.Vf;
Y.prototype.selectNodes=Y.prototype.selectNodes;Y.prototype.sendToBack=Y.prototype.Rc;Y.prototype.setActiveLayer=Y.prototype.Pd;Y.prototype.setBackgroundBrowserImages=Y.prototype.Tf;Y.prototype.setConfig=Y.prototype.Uf;Y.prototype.setColour=Y.prototype.Sc;Y.prototype.setCurrentPage=Y.prototype.mc;Y.prototype.setCustomBackgroundFn=Y.prototype.Ve;Y.prototype.setDocumentSize=Y.prototype.zd;Y.prototype.setDocumentSizeInTransaction=Y.prototype.le;Y.prototype.setDomElement=Y.prototype.Wf;
Y.prototype.setLayerName=Y.prototype.$f;Y.prototype.setPaperSize=Y.prototype.Md;Y.prototype.setIconBrowserImages=Y.prototype.Yf;Y.prototype.setItemProperty=Y.prototype.Zf;Y.prototype.setNodeProperties=Y.prototype.We;Y.prototype.setNodeProperty=Y.prototype.Ad;Y.prototype.setNodeVisibility=Y.prototype.ag;Y.prototype.setOpacity=Y.prototype.ne;Y.prototype.setPageView=Y.prototype.Ye;Y.prototype.setViewRectangle=Y.prototype.cg;Y.prototype.setZoom=Y.prototype.dg;Y.prototype.showLayer=Y.prototype.Vc;
Y.prototype.translateNode=Y.prototype.Qd;Y.prototype.rotateDocument=Y.prototype.Sf;Y.prototype.rotateNode=Y.prototype.ke;Y.prototype.scaleNode=Y.prototype.Ue;Y.prototype.setNodeTransform=Y.prototype.Xe;Y.prototype.undo=Y.prototype.Va;Y.prototype.ungroup=Y.prototype.Zc;Y.prototype.upload=Y.prototype.Ze;Y.prototype.useArrowTool=Y.prototype.jg;Y.prototype.useBrushTool=Y.prototype.kg;Y.prototype.useCircleTool=Y.prototype.lg;Y.prototype.useCurveTool=Y.prototype.mg;Y.prototype.useCustomTool=Y.prototype.ng;
Y.prototype.useEditHandleTool=Y.prototype.$e;Y.prototype.useEllipseTool=Y.prototype.af;Y.prototype.useFreehandTool=Y.prototype.og;Y.prototype.useStampTool=Y.prototype.xg;Y.prototype.useLineTool=Y.prototype.pg;Y.prototype.usePanTool=Y.prototype.qg;Y.prototype.usePickTool=Y.prototype.rg;Y.prototype.usePolygonTool=Y.prototype.bf;Y.prototype.useQuadraticBezierTool=Y.prototype.sg;Y.prototype.useRectangleTool=Y.prototype.cf;Y.prototype.useRoundRectTool=Y.prototype.tg;Y.prototype.useShapeBrushTool=Y.prototype.ug;
Y.prototype.useShapeTool=Y.prototype.df;Y.prototype.useStampLineTool=Y.prototype.wg;Y.prototype.useSquareTool=Y.prototype.vg;Y.prototype.useTextTool=Y.prototype.yg;Y.prototype.zoomIn=Y.prototype.cd;Y.prototype.zoomOut=Y.prototype.dd;eh.prototype.createGroup=eh.prototype.qc;

})();
